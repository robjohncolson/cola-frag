<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragrance Composition Tracker</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" onerror="console.warn('Failed to load Lucide icons')"></script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js" onerror="console.warn('Failed to load Three.js')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-layout {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 380px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            color: #6b7280;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 16px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .stats-bar {
            background: #dbeafe;
            padding: 16px 24px;
            border-bottom: 1px solid #bfdbfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .stats-left {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1e40af;
        }
        
        .stat-label {
            font-size: 12px;
            color: #1d4ed8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .groups-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }
        
        .container {
            max-width: none;
            margin: 0;
            padding: 0;
            background: transparent;
            min-height: auto;
        }
        
        .form-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }
        
        .form-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .form-flex {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            white-space: nowrap;
        }
        
        .btn-blue {
            background: #3b82f6;
            color: white;
        }
        .btn-blue:hover {
            background: #2563eb;
        }
        .btn-green {
            background: #10b981;
            color: white;
        }
        .btn-green:hover {
            background: #059669;
        }
        .btn-red {
            background: transparent;
            color: #ef4444;
            padding: 4px;
        }
        .btn-red:hover {
            color: #dc2626;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                width: 320px;
            }
        }
        
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            .stats-bar {
                padding: 12px 16px;
            }
            .stats-left {
                gap: 16px;
            }
            .groups-container {
                padding: 16px;
            }
        }

        .group {
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .group-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .group-header:hover {
            background: rgba(0,0,0,0.02);
        }
        .group-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .group-title {
            font-size: 18px;
            font-weight: 600;
        }
        .group-count {
            font-size: 14px;
            color: #6b7280;
        }
        .group-stats {
            text-align: right;
        }
        .group-actives {
            font-weight: bold;
        }
        .group-percentage {
            font-size: 14px;
            color: #6b7280;
        }
        .group-content {
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            min-height: 100px;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        .ingredient-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: move;
            transition: box-shadow 0.2s;
        }
        .ingredient-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .ingredient-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
        }
        .ingredient-info {
            flex: 1;
        }
        .ingredient-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .ingredient-details {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .ingredient-actives {
            font-size: 12px;
            font-weight: 500;
            color: #2563eb;
        }
        .ingredient-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }
        .icon {
            width: 16px;
            height: 16px;
        }
        .icon-sm {
            width: 14px;
            height: 14px;
        }
        .text-gray {
            color: #9ca3af;
        }
        /* Group color classes */
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-pink-50 { background-color: #fdf2f8; }
        .bg-indigo-50 { background-color: #eef2ff; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-orange-50 { background-color: #fff7ed; }
        
        /* Edit mode styles */
        .ingredient-edit {
            background: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        .edit-input {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
            margin-bottom: 4px;
            outline: none;
        }
        .edit-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .btn-save {
            background: #10b981;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        .btn-save:hover {
            background: #059669;
        }
        .btn-cancel {
            background: #6b7280;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        .btn-cancel:hover {
            background: #4b5563;
        }
        .btn-edit {
            background: transparent;
            color: #3b82f6;
            padding: 4px;
        }
        .btn-edit:hover {
            color: #2563eb;
        }
        
        /* Inventory Management Styles */
        .inventory-section {
            margin-bottom: 16px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            background: white;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #f9fafb;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .inventory-item.low-stock {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        
        .inventory-item.out-of-stock {
            border-color: #ef4444;
            background: #fee2e2;
            opacity: 0.7;
        }
        
        .inventory-name {
            font-weight: 500;
            flex: 1;
        }
        
        .inventory-amount {
            color: #6b7280;
            margin-left: 8px;
        }
        
        .coverage-indicator {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .coverage-full {
            background: #dcfce7;
            color: #166534;
        }
        
        .coverage-partial {
            background: #fef3c7;
            color: #92400e;
        }
        
        .coverage-none {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .add-inventory-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 8px;
            align-items: end;
        }
        
        .recipe-coverage {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .coverage-title {
            font-weight: 600;
            color: #0c4a6e;
        }
        
        .coverage-stats {
            font-size: 12px;
            color: #0369a1;
        }
        
        .missing-ingredients {
            font-size: 12px;
            color: #7c2d12;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .add-inventory-form {
                grid-template-columns: 1fr;
            }
            .inventory-grid {
                max-height: 150px;
            }
        }
        
        /* Notes and Substitution Styles */
        .ingredient-notes {
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
            margin-top: 4px;
            padding: 4px;
            background: #f9fafb;
            border-radius: 3px;
            border-left: 3px solid #d1d5db;
        }
        
        .ingredient-substituted {
            border-left: 3px solid #f59e0b !important;
            background: #fefbf3 !important;
        }
        
        .substitution-info {
            font-size: 11px;
            color: #d97706;
            font-weight: 500;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .notes-textarea {
            width: 100%;
            min-height: 60px;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            resize: vertical;
            font-family: inherit;
        }
        
        .substitution-controls {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        .substitution-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 4px;
            margin-top: 4px;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 120px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .suggestion-item {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background: #f3f4f6;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-source {
            font-size: 10px;
            color: #9ca3af;
        }
        
        .btn-substitute {
            background: #f59e0b;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .btn-substitute:hover {
            background: #d97706;
        }
        
        .btn-clear-sub {
            background: #6b7280;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
        }
        
        .btn-clear-sub:hover {
            background: #4b5563;
        }
        
        /* Compound Substitution Styles */
        .compound-substitution-group {
            border: 2px dashed #f59e0b;
            border-radius: 8px;
            background: linear-gradient(to right, #fefbf3, #fffef7);
            padding: 12px;
            margin: 8px 0;
            position: relative;
        }
        
        .compound-substitution-header {
            font-size: 12px;
            font-weight: 600;
            color: #d97706;
            background: #fef3c7;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .compound-substitution-controls {
            display: flex;
            gap: 4px;
        }
        
        .compound-substitution-form {
            background: #fffbf5;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }
        
        .compound-ingredient-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .compound-ingredient-row:last-child {
            margin-bottom: 0;
        }
        
        .compound-ingredient-input {
            flex: 2;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .compound-percentage-input {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
        }
        
        .percentage-total {
            font-size: 11px;
            color: #d97706;
            font-weight: 500;
            margin-top: 8px;
            text-align: center;
        }
        
        .percentage-total.valid {
            color: #059669;
        }
        
        .percentage-total.invalid {
            color: #dc2626;
        }
        
        .btn-compound {
            background: #f59e0b;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .btn-compound:hover {
            background: #d97706;
        }
        
        .expand-toggle {
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 10px;
            cursor: pointer;
            padding: 2px 4px;
            margin-left: 4px;
        }
        
        .expand-toggle:hover {
            color: #374151;
        }
        
        /* Inventory Status Stars */
        .inventory-star {
            font-size: 16px;
            margin-left: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .inventory-star:hover {
            transform: scale(1.1);
        }
        
        .inventory-star.available {
            color: #fbbf24; /* Gold */
        }
        
        .inventory-star.missing {
            color: #64748b; /* Dark blueish grey */
        }
        
        /* Ingredient Card Color Coding */
        .ingredient-card.has-inventory {
            border-left: 3px solid #10b981;
            background: linear-gradient(to right, #f0fdf4, white);
        }
        
        .ingredient-card.missing-inventory {
            border-left: 3px solid #ef4444;
            background: linear-gradient(to right, #fef2f2, white);
        }
        
        /* Recipe Complete Background */
        .recipe-complete {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7) !important;
        }
        
        .recipe-complete-banner {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 12px 24px;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid #047857;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Inline Inventory Form */
        .inline-inventory-form {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            display: none;
        }
        
        .inline-inventory-form.active {
            display: block;
        }
        
        .inventory-form-row {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .inventory-form-input {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .inventory-status-detail {
            font-size: 11px;
            color: #059669;
            margin-top: 4px;
            padding: 4px;
            background: #f0fdf4;
            border-radius: 3px;
            border-left: 3px solid #10b981;
        }
        
        .inventory-status-missing {
            font-size: 11px;
            color: #dc2626;
            margin-top: 4px;
            padding: 4px;
            background: #fef2f2;
            border-radius: 3px;
            border-left: 3px solid #ef4444;
        }
        
        .purchase-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 10px;
            margin-left: 8px;
        }
        
        .purchase-link:hover {
            text-decoration: underline;
        }
        
        /* Database Tab Styles */
        .database-table {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: auto; /* Allow horizontal and vertical scrolling */
            max-height: 400px;
            min-width: 100%;
        }
        
        .db-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 800px; /* Ensure table has minimum width for all columns */
        }
        
        .db-table th {
            background: #f9fafb;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .db-table th:last-child {
            background: #e0f2fe; /* Light blue background for actions column */
            position: sticky;
            right: 0;
            z-index: 11;
        }
        
        .db-table th:hover {
            background: #f3f4f6;
        }
        
        .db-table td {
            padding: 6px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }
        
        .db-table td:last-child {
            background: #f0f9ff; /* Light blue background for actions column */
            position: sticky;
            right: 0;
            z-index: 9;
            border-left: 1px solid #e0f2fe;
        }
        
        .db-table tr:hover {
            background: #f9fafb;
        }
        
        .db-table .notes-cell {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .db-table .subs-cell {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .db-edit-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 11px;
            background: #fefce8;
        }
        
        .db-edit-textarea {
            width: 100%;
            min-height: 40px;
            padding: 2px 4px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 11px;
            resize: vertical;
            background: #fefce8;
        }
        
        .db-actions {
            display: flex;
            gap: 2px;
        }
        
        .db-btn {
            background: transparent;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .db-btn:hover {
            background: #f3f4f6;
        }
        
        .sort-indicator {
            margin-left: 4px;
            color: #9ca3af;
        }
        
        .tab-active {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        .tab-inactive {
            background: #6b7280 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="title">Fragrance Composer</h1>
                <p class="subtitle">Create and manage your fragrance formulations</p>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 6px; margin-top: 16px;">
                    <button onclick="switchTab('composer')" id="composerTab" class="btn" style="flex: 1; font-size: 11px;">
                        <i data-lucide="beaker" class="icon"></i>
                        Composer
                    </button>
                    <button onclick="switchTab('database')" id="databaseTab" class="btn" style="flex: 1; font-size: 11px; background: #6b7280; color: white;">
                        <i data-lucide="database" class="icon"></i>
                        Database
                    </button>
                    <button onclick="switchTab('visualizer')" id="visualizerTab" class="btn" style="flex: 1; font-size: 11px; background: #6b7280; color: white;">
                        <i data-lucide="bar-chart-3" class="icon"></i>
                        Visualizer
                    </button>
                </div>
            </div>
            
            <div class="sidebar-content">
                <!-- Composer Tab Content -->
                <div id="composerContent">
                    <!-- Add Ingredient Form -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="plus-circle" class="icon"></i>
                            Add Ingredient
                        </h2>
                        <div class="form-grid">
                            <input type="text" 
                                   id="ingredientName" 
                                   class="input" 
                                   placeholder="Ingredient name" 
                                   list="add-ingredient-datalist"
                                   onchange="onIngredientNameChange()">
                            <datalist id="add-ingredient-datalist">
                                <!-- Will be populated by JavaScript -->
                            </datalist>
                            <input type="number" id="ingredientDilution" class="input" step="0.001" placeholder="Dilution (0.1 = 10%)" value="1.0">
                            <input type="number" id="ingredientVolume" class="input" step="0.1" placeholder="Volume (μL)" value="0">
                            <button onclick="addIngredient()" class="btn btn-blue">
                                <i data-lucide="plus" class="icon"></i>
                                Add Ingredient
                            </button>
                        </div>
                    </div>

                    <!-- Add Group Form -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="folder-plus" class="icon"></i>
                            Add Group/Accord
                        </h2>
                        <div class="form-grid">
                            <input type="text" id="groupName" class="input" placeholder="Group name (e.g., Citrus, Musks, Pineapple Accord)">
                            <button onclick="addGroup()" class="btn btn-green">
                                <i data-lucide="plus" class="icon"></i>
                                Add Group
                            </button>
                        </div>
                    </div>

                    <!-- Import/Export Section -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="save" class="icon"></i>
                            Import/Export
                        </h2>
                        
                        <!-- Smart Load All Section -->
                        <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-weight: 600; font-size: 12px; color: #1e40af; margin-bottom: 6px;">
                                🚀 Smart Load All
                            </div>
                            <div style="font-size: 11px; color: #1d4ed8; margin-bottom: 8px;">
                                Select multiple files (database, inventory, recipe) and they'll be loaded in the correct order automatically
                            </div>
                            <input type="file" id="loadAllFiles" accept=".json" multiple style="display: none;" onchange="loadAllFiles(event)">
                            <button onclick="document.getElementById('loadAllFiles').click()" class="btn" style="background: #3b82f6; color: white; width: 100%;">
                                <i data-lucide="folder-open" class="icon"></i>
                                Load All Files
                            </button>
                            <div id="loadAllProgress" style="display: none; margin-top: 8px; font-size: 11px; color: #1d4ed8;"></div>
                        </div>
                        
                        <!-- Individual Import/Export -->
                        <div class="form-grid" style="margin-bottom: 12px;">
                            <button onclick="exportRecipe()" class="btn btn-blue">
                                <i data-lucide="download" class="icon"></i>
                                Export Recipe
                            </button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importRecipe(event)">
                            <button onclick="document.getElementById('importFile').click()" class="btn btn-green">
                                <i data-lucide="upload" class="icon"></i>
                                Import Recipe
                            </button>
                            <button onclick="clearAll()" class="btn btn-red" style="background: #ef4444; color: white;">
                                <i data-lucide="trash-2" class="icon"></i>
                                Clear All
                            </button>
                        </div>
                        <div>
                            <textarea id="jsonPreview" class="input" placeholder="JSON preview will appear here..." style="height: 80px; resize: vertical; font-family: monospace; font-size: 11px;" readonly></textarea>
                        </div>
                    </div>
                    
                    <!-- Inventory Management Section -->
                    <div class="form-section inventory-section">
                        <h2 class="form-title">
                            <i data-lucide="package" class="icon"></i>
                            Inventory Management
                        </h2>
                        
                        <div class="add-inventory-form" style="margin-bottom: 12px;">
                            <input type="text" id="inventoryName" class="input" placeholder="Ingredient name">
                            <input type="number" id="inventoryAmount" class="input" step="0.1" placeholder="Amount">
                            <select id="inventoryUnit" class="input">
                                <option value="ml">ml</option>
                                <option value="g">g</option>
                                <option value="μL">μL</option>
                            </select>
                            <button onclick="addToInventory()" class="btn btn-blue">
                                <i data-lucide="plus" class="icon"></i>
                            </button>
                        </div>
                        
                        <button onclick="exportInventory()" class="btn btn-blue" style="width: 100%; margin-bottom: 8px;">
                            <i data-lucide="database" class="icon"></i>
                            Export Inventory
                        </button>
                        
                        <input type="file" id="inventoryImportFile" accept=".json" style="display: none;" onchange="importInventory(event)">
                        <button onclick="document.getElementById('inventoryImportFile').click()" class="btn btn-green" style="width: 100%; margin-bottom: 8px;">
                            <i data-lucide="upload" class="icon"></i>
                            Import Inventory
                        </button>
                        
                        <div class="inventory-grid" id="inventoryGrid">
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                No ingredients in inventory
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Tab Content -->
                <div id="databaseContent" style="display: none;">
                    <!-- Database Search -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="search" class="icon"></i>
                            Search Database
                        </h2>
                        <input type="text" id="databaseSearch" class="input" placeholder="Search ingredients..." onkeyup="filterDatabase()">
                    </div>
                    
                    <!-- Database Export/Import -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="database" class="icon"></i>
                            Database Management
                        </h2>
                        <div class="form-grid">
                            <button onclick="exportDatabase()" class="btn btn-blue">
                                <i data-lucide="download" class="icon"></i>
                                Export Database
                            </button>
                            <input type="file" id="databaseImportFile" accept=".json" style="display: none;" onchange="importDatabase(event)">
                            <button onclick="document.getElementById('databaseImportFile').click()" class="btn btn-green">
                                <i data-lucide="upload" class="icon"></i>
                                Import Database
                            </button>
                        </div>
                    </div>
                    
                    <!-- Database Table -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="list" class="icon"></i>
                            Ingredient Database
                        </h2>
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 4px 8px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6;">
                            💡 <strong>Tip:</strong> Scroll horizontally to see all columns. The blue "Actions" column on the right has edit buttons (✏️).
                        </div>
                        <div id="databaseTable" class="database-table">
                            <!-- Table will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Visualizer Tab Content -->
                <div id="visualizerContent" style="display: none;">
                    <!-- View Mode Selection -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="bar-chart-3" class="icon"></i>
                            Visualization Mode
                        </h2>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button onclick="resetCameraView()" class="btn" style="flex: 1; background: #3b82f6; color: white; font-size: 11px;">
                                🔄 Reset View
                            </button>
                            <button onclick="toggleMolecularMotion()" id="motionToggle" class="btn" style="flex: 1; background: #6b7280; color: white; font-size: 11px;">
                                ⚡ Start Motion
                            </button>
                            <button onclick="toggleFullscreen()" id="fullscreenBtn" class="btn" style="flex: 1; background: #8b5cf6; color: white; font-size: 11px;">
                                🔳 Fullscreen
                            </button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button onclick="exportVisualizationImage()" class="btn" style="flex: 1; background: #10b981; color: white; font-size: 11px;">
                                📸 Screenshot
                            </button>
                            <button onclick="showKeyboardControls()" class="btn" style="flex: 1; background: #64748b; color: white; font-size: 11px;">
                                ⌨️ Controls
                            </button>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 4px 8px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6;">
                            💡 <strong>Hover</strong> over visualization elements to see detailed ingredient information
                        </div>
                    </div>
                    
                    <!-- Color Management -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="palette" class="icon"></i>
                            Color Management
                        </h2>
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 4px 8px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6;">
                            💡 <strong>Click ingredient names in the legend</strong> to assign smell-based colors. Custom colors are saved to your database!
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button onclick="resetAllColorsToAuto()" class="btn" style="flex: 1; background: #f59e0b; color: white; font-size: 11px;">
                                🔄 Reset All Colors
                            </button>
                            <button onclick="showColorPresets()" class="btn" style="flex: 1; background: #8b5cf6; color: white; font-size: 11px;">
                                🎨 Color Presets
                            </button>
                        </div>
                        <div id="colorStats" style="font-size: 10px; color: #64748b;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                
                    <!-- Power Controls -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="sliders" class="icon"></i>
                            Scaling Power Controls
                        </h2>
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 4px 8px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6;">
                            💡 <strong>Adjust how dramatically size and territory vary</strong> - Higher values create more extreme differences between high and low concentration ingredients
                        </div>
                        
                        <!-- Sphere Size Power -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                                🔴 Sphere Size Power: <span id="spherePowerValue">2.0</span>
                            </label>
                            <input type="range" id="spherePowerSlider" min="1" max="4" step="0.1" value="2.0" 
                                   style="width: 100%; margin-bottom: 4px;" 
                                   oninput="updateSpherePower(this.value)">
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #6b7280;">
                                <span>1.0 (Linear)</span>
                                <span>2.0 (Squared)</span>
                                <span>3.0 (Cubed)</span>
                                <span>4.0 (⁴th Power)</span>
                            </div>
                        </div>
                        
                        <!-- Territory Size Power -->
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                                🟣 Territory Size Power: <span id="territoryPowerValue">1.0</span>
                            </label>
                            <input type="range" id="territoryPowerSlider" min="1" max="3" step="0.1" value="1.0" 
                                   style="width: 100%; margin-bottom: 4px;" 
                                   oninput="updateTerritoryPower(this.value)">
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #6b7280;">
                                <span>1.0 (Linear)</span>
                                <span>2.0 (Squared)</span>
                                <span>3.0 (Cubed)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics Summary -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="pie-chart" class="icon"></i>
                            Recipe Statistics
                        </h2>
                        <div id="visualizerStats" style="font-size: 12px; color: #4b5563;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stats-left">
                    <div class="stat-item">
                        <div class="stat-value" id="totalActives">0.00</div>
                        <div class="stat-label">Total Actives (μL)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalIngredients">0</div>
                        <div class="stat-label">Total Ingredients</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalGroups">1</div>
                        <div class="stat-label">Groups</div>
                    </div>
                </div>
            </div>
            
            <!-- Recipe Complete Banner -->
            <div id="recipeCompleteBanner" class="recipe-complete-banner" style="display: none;">
                🎉 Recipe Complete! All ingredients are available in your inventory
            </div>

            <!-- Visualization Container -->
            <div id="visualizationContainer" class="groups-container" style="display: none;">
                <div style="display: flex; height: 100%; gap: 16px;">
                    <!-- Main Visualization Area -->
                    <div style="flex: 1; background: #000; border-radius: 8px; padding: 0; border: 1px solid #1f2937; position: relative; overflow: hidden;">
                        <div id="molecularVisualization" style="width: 100%; height: 500px; cursor: grab;"></div>
                        <div id="visualizationTooltip" style="position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 1000; border: 1px solid #3b82f6;"></div>
                        <div id="visualizationHUD" style="position: absolute; top: 10px; left: 10px; color: #64748b; font-size: 11px; font-family: monospace; z-index: 999;">
                            <div>Molecules: <span id="moleculeCount">0</span></div>
                            <div>Camera: <span id="cameraInfo">Ready</span></div>
                        </div>
                    </div>
                    
                    <!-- Legend Sidebar -->
                    <div style="width: 250px; background: white; border-radius: 8px; padding: 16px; border: 1px solid #e5e7eb;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #374151;">Groups & Inventory</h3>
                        <div id="visualizationLegend">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Groups Container -->
            <div id="groupsContainer" class="groups-container">
                <!-- Recipe Coverage Analysis -->
                <div class="recipe-coverage" id="recipeCoverage" style="display: none;">
                    <div class="coverage-header">
                        <div class="coverage-title">Recipe Coverage Analysis</div>
                        <div class="coverage-stats" id="coverageStats">0/0 ingredients available</div>
                    </div>
                    <div id="coverageDetails">No active recipe loaded</div>
                    <div class="missing-ingredients" id="missingIngredients"></div>
                </div>
                
                <div class="container">
                    <div id="groupsGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let ingredients = [];
        let groups = {
            'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' }
        };
        let draggedItem = null;
        
        // Inventory Management
        let inventory = [];
        
        // Ingredient Database
        let ingredientDatabase = [];
        let currentTab = 'composer'; // 'composer' or 'database'
        
        // Power Controls for Scaling
        let spherePower = 2.0; // Default to squared for sphere sizing
        let territoryPower = 1.0; // Default to linear for territory sizing
        
        // Notes and Substitutions
        let expandedIngredients = new Set(); // Track which ingredient cards are expanded
        
        // Common aromachemical substitutions database
        const substitutionDatabase = {
            // Citrus substitutions
            "bergamot oil": ["lemon oil", "sweet orange oil", "citral", "limonene"],
            "sweet orange oil": ["bergamot oil", "mandarin oil", "citral", "valencene"],
            "lemon oil": ["bergamot oil", "citral", "limonene"],
            
            // Woody substitutions  
            "iso e super": ["timbersilk", "kephalis", "cashmeran"],
            "cashmeran": ["iso e super", "kephalis", "polysantol"],
            "kephalis": ["iso e super", "cashmeran", "timbersilk"],
            
            // Musk substitutions
            "helvetolide": ["galaxolide", "ambrettolide", "muscone"],
            "galaxolide": ["helvetolide", "ambrettolide", "exaltolide"],
            "ambrettolide": ["helvetolide", "galaxolide", "muscone"],
            "muscone": ["ambrettolide", "helvetolide", "civetone"],
            
            // Floral substitutions
            "hedione": ["methyl anthranilate", "linalool", "phenyl ethyl alcohol"],
            "lyral": ["lily aldehyde", "hydroxycitronellal", "linalool"],
            "linalool": ["linalyl acetate", "hedione", "phenyl ethyl alcohol"],
            "linalyl acetate": ["linalool", "lavender oil", "bergamyl acetate"],
            
            // Aldehyde substitutions
            "aldehyde c-12 mna": ["aldehyde c-10", "aldehyde c-11", "aldehyde c-12"],
            "aldehyde c-10": ["aldehyde c-12 mna", "aldehyde c-11", "decanal"],
            "aldehyde c-6": ["hexanal", "aldehyde c-8", "aldehyde c-10"],
            
            // Amber substitutions
            "ambroxan": ["ambrocenide", "ambergris tincture", "labdanol"],
            
            // Animalic substitutions
            "2-isobutyl quinoline": ["civet absolute", "castoreum", "indole"],
            "birch tar oil": ["cade oil", "guaiacol", "phenolic compounds"],
            
            // Green substitutions
            "galbanum oil": ["violet leaf absolute", "green leaves accord", "hexenol-3-cis"],
            "petitgrain bigarade oil": ["clary sage oil", "petitgrain paraguay", "neroli oil"],
            
            // Fruity substitutions
            "beta pinene": ["alpha pinene", "limonene", "fruit terpenes"],
            "manzanate": ["apple ester", "ethyl butyrate", "fruit accord"],
            "veloutone": ["gamma undecalactone", "peach aldehyde", "fruity lactones"],
            "ethyl caproate": ["ethyl butyrate", "pineapple ester", "fruit esters"],
            
            // Spice substitutions
            "pink pepper oil": ["black pepper oil", "coriander oil", "cardamom oil"],
            "coranol": ["coriander oil", "metallic aldehydes", "green aldehydes"],
            
            // Patchouli substitutions
            "patchouli oil": ["patchoulol", "dark patchouli oil", "patchouli fraction"],
            "patchoulol crystals": ["patchouli oil", "synthetic patchoulol"],
            
            // Synthetic backbone
            "evernyl": ["oakmoss absolute", "treemoss", "mousse de chene"],
            "octyl salicylate": ["homosalate", "sunscreen molecules", "salicylates"]
        };

        const groupColors = [
            'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50', 
            'bg-pink-50', 'bg-indigo-50', 'bg-red-50', 'bg-orange-50'
        ];

        // Utility functions
        function getActives(ingredient) {
            return ingredient.volume * ingredient.dilution;
        }

        function getTotalActives() {
            return ingredients.reduce((sum, ing) => sum + getActives(ing), 0);
        }

        function getGroupActives(groupName) {
            const groupIngredients = groups[groupName].ingredients.map(id => 
                ingredients.find(i => i.id === id)
            ).filter(Boolean);
            return groupIngredients.reduce((sum, ing) => sum + getActives(ing), 0);
        }

        function getGroupPercentage(groupName) {
            const total = getTotalActives();
            if (total === 0) return 0;
            return (getGroupActives(groupName) / total * 100).toFixed(1);
        }

        function getIngredientPercentage(ingredient) {
            const total = getTotalActives();
            if (total === 0) return 0;
            return (getActives(ingredient) / total * 100).toFixed(2);
        }

        // Import/Export functions
        function exportRecipe() {
            // Collect compound substitution information
            const compoundSubstitutions = {};
            ingredients.forEach(ingredient => {
                if (ingredient.isCompoundSubstitute && ingredient.compoundId) {
                    if (!compoundSubstitutions[ingredient.compoundId]) {
                        compoundSubstitutions[ingredient.compoundId] = {
                            originalIngredient: ingredient.originalIngredient,
                            originalGroup: ingredient.group,
                            substitutes: []
                        };
                    }
                    compoundSubstitutions[ingredient.compoundId].substitutes.push({
                        name: ingredient.name,
                        percentage: ingredient.compoundPercentage,
                        volume: ingredient.volume,
                        dilution: ingredient.dilution
                    });
                }
            });

            const recipeData = {
                version: "1.1",
                timestamp: new Date().toISOString(),
                totalActives: getTotalActives(),
                ingredients: ingredients,
                groups: groups,
                compoundSubstitutions: compoundSubstitutions
            };

            const jsonString = JSON.stringify(recipeData, null, 2);
            
            // Update preview
            document.getElementById('jsonPreview').value = jsonString;

            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-recipe-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importRecipe(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const recipeData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!recipeData.ingredients || !recipeData.groups) {
                        throw new Error('Invalid recipe format');
                    }

                    // Clear existing data
                    ingredients = [];
                    groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };

                    // Import ingredients and merge notes into database
                    if (Array.isArray(recipeData.ingredients)) {
                        ingredients = recipeData.ingredients.map(ing => {
                            // Get or create database entry for this ingredient
                            const dbEntry = getOrCreateDatabaseEntry(ing.name || 'Unknown');
                            
                            // Merge notes from recipe into database
                            if (ing.notes && ing.notes.trim()) {
                                if (dbEntry.notes && dbEntry.notes.trim()) {
                                    dbEntry.notes += '\n---\n' + ing.notes;
                                } else {
                                    dbEntry.notes = ing.notes;
                                }
                            }
                            
                            return {
                                id: ing.id || Date.now() + Math.random(),
                                name: ing.name || 'Unknown',
                                dilution: parseFloat(ing.dilution) || 1.0,
                                volume: parseFloat(ing.volume) || 0,
                                group: ing.group || 'Unassigned',
                                notes: '', // Notes now come from database
                                substituted: ing.substituted || false,
                                // Preserve compound substitution metadata
                                isCompoundSubstitute: ing.isCompoundSubstitute || false,
                                originalIngredient: ing.originalIngredient || undefined,
                                compoundId: ing.compoundId || undefined,
                                compoundPercentage: ing.compoundPercentage || undefined
                            };
                        });
                    }

                    // Import groups
                    if (typeof recipeData.groups === 'object') {
                        Object.entries(recipeData.groups).forEach(([groupName, groupData]) => {
                            groups[groupName] = {
                                ingredients: Array.isArray(groupData.ingredients) ? groupData.ingredients : [],
                                expanded: groupData.expanded !== false,
                                color: groupData.color || 'bg-gray-100'
                            };
                        });
                    }

                    // Handle compound substitutions (for version 1.1+)
                    let compoundSubsCount = 0;
                    if (recipeData.compoundSubstitutions && typeof recipeData.compoundSubstitutions === 'object') {
                        compoundSubsCount = Object.keys(recipeData.compoundSubstitutions).length;
                        console.log('Imported compound substitutions:', compoundSubsCount);
                        
                        // Verify that compound substitution ingredients are properly linked
                        Object.entries(recipeData.compoundSubstitutions).forEach(([compoundId, subData]) => {
                            const relatedIngredients = ingredients.filter(ing => 
                                ing.compoundId && (ing.compoundId.toString() === compoundId.toString())
                            );
                            console.log(`Compound substitution ${compoundId}: ${subData.originalIngredient} -> ${relatedIngredients.length} substitutes`);
                            console.log('Related ingredients:', relatedIngredients.map(ing => `${ing.name} (ID: ${ing.compoundId})`));
                        });
                    }

                    // Update preview
                    document.getElementById('jsonPreview').value = JSON.stringify(recipeData, null, 2);

                    render();
                    
                    let message = 'Recipe imported successfully! Notes have been merged into your ingredient database.';
                    if (compoundSubsCount > 0) {
                        message += ` ${compoundSubsCount} compound substitution(s) restored.`;
                    }
                    alert(message);
                } catch (error) {
                    alert('Error importing recipe: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all ingredients and groups? This cannot be undone.')) {
                ingredients = [];
                groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };
                document.getElementById('jsonPreview').value = '';
                render();
            }
        }

        function updateJsonPreview() {
            if (ingredients.length > 0 || Object.keys(groups).length > 1) {
                // Collect compound substitution information for preview
                const compoundSubstitutions = {};
                ingredients.forEach(ingredient => {
                    if (ingredient.isCompoundSubstitute && ingredient.compoundId) {
                        if (!compoundSubstitutions[ingredient.compoundId]) {
                            compoundSubstitutions[ingredient.compoundId] = {
                                originalIngredient: ingredient.originalIngredient,
                                originalGroup: ingredient.group,
                                substitutes: []
                            };
                        }
                        compoundSubstitutions[ingredient.compoundId].substitutes.push({
                            name: ingredient.name,
                            percentage: ingredient.compoundPercentage,
                            volume: ingredient.volume,
                            dilution: ingredient.dilution
                        });
                    }
                });

                const recipeData = {
                    version: "1.1",
                    timestamp: new Date().toISOString(),
                    totalActives: getTotalActives(),
                    ingredients: ingredients,
                    groups: groups,
                    compoundSubstitutions: compoundSubstitutions
                };
                document.getElementById('jsonPreview').value = JSON.stringify(recipeData, null, 2);
            } else {
                document.getElementById('jsonPreview').value = '';
            }
        }

        // Inventory Management Functions
        function addToInventory() {
            const name = document.getElementById('inventoryName').value.trim();
            const amount = parseFloat(document.getElementById('inventoryAmount').value);
            const unit = document.getElementById('inventoryUnit').value;

            if (!name || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid ingredient name and amount');
                return;
            }

            // Check if ingredient already exists
            const existing = inventory.find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existing) {
                existing.amount += amount;
                existing.unit = unit; // Update unit if different
            } else {
                inventory.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    unit: unit,
                    dilution: 1.0 // Default to neat
                });
            }
            
            // Update database entry with inventory information
            const dbEntry = getOrCreateDatabaseEntry(name);
            dbEntry.currentInventory = existing ? existing.amount : amount;
            dbEntry.inventoryUnit = unit;
            dbEntry.lastUpdated = new Date().toISOString();

            // Clear form
            document.getElementById('inventoryName').value = '';
            document.getElementById('inventoryAmount').value = '';
            
            renderInventory();
            updateRecipeCoverage();
            render(); // Update stars and colors
        }

        function importInventoryFromReceipts() {
            // Merge PA receipts data with existing inventory
            paReceiptsData.forEach(receipt => {
                const existing = inventory.find(item => 
                    item.name.toLowerCase() === receipt.name.toLowerCase()
                );
                
                if (existing) {
                    // Add to existing amount (convert units if needed)
                    existing.amount += receipt.amount;
                    existing.dilution = receipt.dilution; // Update dilution
                } else {
                    inventory.push({
                        id: Date.now() + Math.random(),
                        name: receipt.name,
                        amount: receipt.amount,
                        unit: receipt.unit,
                        dilution: receipt.dilution
                    });
                }
            });

            renderInventory();
            updateRecipeCoverage();
            alert('Perfumer\'s Apprentice receipts loaded successfully!');
        }

        function exportInventory() {
            const inventoryData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalItems: inventory.length,
                inventory: inventory
            };

            const jsonString = JSON.stringify(inventoryData, null, 2);
            
            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-inventory-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importInventory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const inventoryData = JSON.parse(e.target.result);
                    
                    if (!inventoryData.inventory || !Array.isArray(inventoryData.inventory)) {
                        throw new Error('Invalid inventory format');
                    }

                    inventory = inventoryData.inventory.map(item => ({
                        id: item.id || Date.now() + Math.random(),
                        name: item.name || 'Unknown',
                        amount: parseFloat(item.amount) || 0,
                        unit: item.unit || 'ml',
                        dilution: parseFloat(item.dilution) || 1.0
                    }));

                    renderInventory();
                    updateRecipeCoverage();
                    render(); // Update stars and colors
                    alert('Inventory imported successfully!');
                } catch (error) {
                    alert('Error importing inventory: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function removeFromInventory(id) {
            inventory = inventory.filter(item => item.id !== id);
            renderInventory();
            updateRecipeCoverage();
            render(); // Update stars and colors
        }

        function renderInventory() {
            const container = document.getElementById('inventoryGrid');
            
            if (inventory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No ingredients in inventory</div>';
                updateAddIngredientDatalist();
                return;
            }

            container.innerHTML = '';
            
            inventory.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const itemDiv = document.createElement('div');
                
                // Determine stock level
                let stockClass = '';
                if (item.amount <= 0) stockClass = 'out-of-stock';
                else if (item.amount <= 1) stockClass = 'low-stock';
                
                itemDiv.className = `inventory-item ${stockClass}`;
                itemDiv.innerHTML = `
                    <div class="inventory-name">${item.name}</div>
                    <div class="inventory-amount">${item.amount}${item.unit}</div>
                    <button onclick="removeFromInventory(${item.id})" class="btn-red" style="padding: 2px;">
                        <i data-lucide="x" class="icon-sm"></i>
                    </button>
                `;
                
                container.appendChild(itemDiv);
            });
            
            // Update the add ingredient datalist
            updateAddIngredientDatalist();
        }
        
        function updateAddIngredientDatalist() {
            const datalist = document.getElementById('add-ingredient-datalist');
            if (datalist) {
                datalist.innerHTML = inventory.map(item => 
                    `<option value="${item.name}" label="${item.amount}${item.unit} available">`
                ).join('');
            }
        }

        function updateRecipeCoverage() {
            if (ingredients.length === 0) {
                document.getElementById('recipeCoverage').style.display = 'none';
                return;
            }

            document.getElementById('recipeCoverage').style.display = 'block';
            
            let availableCount = 0;
            let partialCount = 0;
            const missingIngredients = [];
            const partialIngredients = [];

            ingredients.forEach(ingredient => {
                const inventoryItem = findInventoryMatch(ingredient.name);
                
                if (inventoryItem) {
                    const requiredAmount = ingredient.volume; // μL
                    const availableAmount = convertToMicroliters(inventoryItem.amount, inventoryItem.unit);
                    
                    if (availableAmount >= requiredAmount) {
                        availableCount++;
                    } else if (availableAmount > 0) {
                        partialCount++;
                        partialIngredients.push({
                            name: ingredient.name,
                            required: requiredAmount,
                            available: availableAmount
                        });
                    } else {
                        missingIngredients.push(ingredient.name);
                    }
                } else {
                    missingIngredients.push(ingredient.name);
                }
            });

            // Update stats
            document.getElementById('coverageStats').textContent = 
                `${availableCount}/${ingredients.length} ingredients available (${partialCount} partial)`;

            // Update details
            const percentage = ((availableCount + partialCount * 0.5) / ingredients.length * 100).toFixed(1);
            document.getElementById('coverageDetails').innerHTML = `
                <div style="margin-bottom: 4px;">
                    <span class="coverage-indicator coverage-full">${availableCount} Full</span>
                    <span class="coverage-indicator coverage-partial">${partialCount} Partial</span>
                    <span class="coverage-indicator coverage-none">${missingIngredients.length} Missing</span>
                    <span style="margin-left: 8px; font-weight: 600;">${percentage}% Coverage</span>
                </div>
            `;

            // Update missing ingredients
            if (missingIngredients.length > 0) {
                document.getElementById('missingIngredients').innerHTML = 
                    `<strong>Missing:</strong> ${missingIngredients.join(', ')}`;
            } else {
                document.getElementById('missingIngredients').innerHTML = '';
            }
        }

        function findInventoryMatch(ingredientName) {
            return inventory.find(item => {
                const itemName = item.name.toLowerCase().replace(/[®™]/g, '').trim();
                const searchName = ingredientName.toLowerCase().replace(/[®™]/g, '').trim();
                
                // Exact match
                if (itemName === searchName) return true;
                
                // Normalize common variations (remove/standardize suffixes)
                const normalizeIngredientName = (name) => {
                    return name
                        .replace(/\s+(essential\s+)?oil$/i, '')
                        .replace(/\s+co2$/i, '')
                        .replace(/\s+absolute$/i, '')
                        .replace(/\s+eo$/i, '') // Remove EO suffix
                        .replace(/\s+by-absolute$/i, ' absolute')
                        .trim();
                };
                
                const normalizedItem = normalizeIngredientName(itemName);
                const normalizedSearch = normalizeIngredientName(searchName);
                
                // Check normalized names
                if (normalizedItem === normalizedSearch) return true;
                
                // Handle specific common variations
                const variations = {
                    // Citrus oils
                    'bergamot': ['bergamot oil', 'bergamot eo', 'bergamot essential oil'],
                    'bergamot oil': ['bergamot', 'bergamot eo', 'bergamot essential oil'],
                    'sweet orange': ['sweet orange oil', 'orange oil', 'orange'],
                    'sweet orange oil': ['sweet orange', 'orange oil', 'orange'],
                    'lemon': ['lemon oil', 'lemon eo', 'lemon essential oil'],
                    'lemon oil': ['lemon', 'lemon eo', 'lemon essential oil'],
                    'lime': ['lime oil', 'lime eo', 'lime essential oil'],
                    'lime oil': ['lime', 'lime eo', 'lime essential oil'],
                    
                    // CO2 vs Oil variations
                    'juniper berry oil': ['juniper berry co2', 'juniper berry'],
                    'juniper berry co2': ['juniper berry oil', 'juniper berry'],
                    'galbanum oil': ['galbanum co2', 'galbanum'],
                    'galbanum co2': ['galbanum oil', 'galbanum'],
                    'angelica root oil': ['angelica root co2', 'angelica root'],
                    'angelica root co2': ['angelica root oil', 'angelica root'],
                    'myrrh oil': ['myrrh co2', 'myrrh'],
                    'myrrh co2': ['myrrh oil', 'myrrh'],
                    'cassia oil': ['cassia co2', 'cassia'],
                    'cassia co2': ['cassia oil', 'cassia'],
                    
                    // Essential oils vs absolutes
                    'clary sage oil': ['clary sage absolute', 'clary sage'],
                    'clary sage absolute': ['clary sage oil', 'clary sage'],
                    'lavender oil': ['lavender absolute', 'lavender'],
                    'lavender absolute': ['lavender oil', 'lavender'],
                    'geranium oil': ['geranium absolute', 'geranium'],
                    'geranium absolute': ['geranium oil', 'geranium'],
                    
                    // Wood oils
                    'patchouli': ['patchouli oil', 'patchouli eo'],
                    'patchouli oil': ['patchouli', 'patchouli eo'],
                    'sandalwood': ['sandalwood oil', 'sandalwood eo'],
                    'sandalwood oil': ['sandalwood', 'sandalwood eo'],
                    'cedarwood': ['cedarwood oil', 'cedarwood absolute', 'cedarwood eo'],
                    'cedarwood oil': ['cedarwood', 'cedarwood absolute', 'cedarwood eo'],
                    'cedarwood absolute': ['cedarwood', 'cedarwood oil', 'cedarwood eo'],
                    'vetiver': ['vetiver oil', 'vetiver eo'],
                    'vetiver oil': ['vetiver', 'vetiver eo'],
                    
                    // Spice oils
                    'pink pepper': ['pink pepper oil', 'pink peppercorn oil'],
                    'pink pepper oil': ['pink pepper', 'pink peppercorn oil'],
                    'star anise': ['star anise oil', 'star anise eo'],
                    'star anise oil': ['star anise', 'star anise eo'],
                    'thyme': ['thyme oil', 'thyme eo'],
                    'thyme oil': ['thyme', 'thyme eo'],
                    
                    // Herb oils
                    'basil': ['basil oil', 'basil eo'],
                    'basil oil': ['basil', 'basil eo'],
                    'fennel': ['fennel oil', 'fennel eo'],
                    'fennel oil': ['fennel', 'fennel eo'],
                    'marjoram': ['marjoram oil', 'marjoram eo'],
                    'marjoram oil': ['marjoram', 'marjoram eo'],
                    'sage': ['sage oil', 'sage eo'],
                    'sage oil': ['sage', 'sage eo'],
                    
                    // Special cases
                    'cypress by-absolute': ['cypress absolute', 'cypress'],
                    'cypress absolute': ['cypress by-absolute', 'cypress'],
                    'birch tar oil': ['birch tar', 'birch tar rectified'],
                    'birch tar': ['birch tar oil', 'birch tar rectified'],
                    
                    // Synthetics
                    'iso e super': ['isoesuper', 'iso-e-super'],
                    'hedione': ['hedione hc'],
                    'lyral': ['leerall'],
                    'evernyl': ['veramoss']
                };
                
                // Check bidirectional variations
                const checkVariations = (name1, name2) => {
                    if (variations[name1] && variations[name1].includes(name2)) return true;
                    if (variations[name2] && variations[name2].includes(name1)) return true;
                    return false;
                };
                
                if (checkVariations(normalizedSearch, normalizedItem)) return true;
                if (checkVariations(searchName, itemName)) return true;
                
                // Final fallback: check if core ingredient name matches
                // Remove common suffixes and check again
                const getCoreIngredientName = (name) => {
                    return name
                        .replace(/\s+(oil|absolute|co2|eo|essential oil|by-absolute)$/i, '')
                        .replace(/\s+decumbens$/i, '') // For hyssop decumbens
                        .replace(/\s+verbenone$/i, '') // For rosemary verbenone
                        .replace(/\s+antioxidant$/i, '') // For rosemary antioxidant
                        .replace(/\s+leaf$/i, '') // For rosewood leaf
                        .replace(/\s+frereana$/i, '') // For frankincense frereana
                        .replace(/\s+bud$/i, '') // For black currant bud
                        .replace(/\s+berry$/i, '') // For juniper berry
                        .replace(/\s+root$/i, '') // For angelica root
                        .trim();
                };
                
                const coreItem = getCoreIngredientName(normalizedItem);
                const coreSearch = getCoreIngredientName(normalizedSearch);
                
                if (coreItem === coreSearch && coreItem.length > 3) return true;
                
                return false;
            });
        }

        function convertToMicroliters(amount, unit) {
            switch (unit.toLowerCase()) {
                case 'ml': return amount * 1000;
                case 'g': return amount * 1000; // Approximate for most aromachemicals
                case 'μl': return amount;
                default: return amount * 1000; // Default to ml conversion
            }
        }

        // Inventory Star Functions
        function getInventoryStatus(ingredientName) {
            const inventoryItem = findInventoryMatch(ingredientName);
            return {
                available: !!inventoryItem,
                item: inventoryItem,
                amount: inventoryItem ? inventoryItem.amount : 0,
                unit: inventoryItem ? inventoryItem.unit : 'ml'
            };
        }
        
        function checkRecipeComplete() {
            if (ingredients.length === 0) return false;
            
            return ingredients.every(ingredient => {
                const status = getInventoryStatus(ingredient.name);
                return status.available;
            });
        }
        
        function toggleInlineInventoryForm(ingredientId) {
            // First, ensure the ingredient is expanded
            if (!expandedIngredients.has(ingredientId)) {
                expandedIngredients.add(ingredientId);
                render(); // Re-render to show expanded state
                
                // Use setTimeout to ensure the form exists after re-render
                setTimeout(() => {
                    openInlineForm(ingredientId);
                }, 10);
            } else {
                openInlineForm(ingredientId);
            }
        }
        
        function openInlineForm(ingredientId) {
            const form = document.getElementById(`inline-form-${ingredientId}`);
            const allForms = document.querySelectorAll('.inline-inventory-form');
            
            // Close all other forms
            allForms.forEach(f => {
                if (f.id !== `inline-form-${ingredientId}`) {
                    f.classList.remove('active');
                }
            });
            
            // Open this form
            if (form) {
                form.classList.add('active');
                
                // Focus on the amount input for better UX
                const amountInput = document.getElementById(`inline-amount-${ingredientId}`);
                if (amountInput) {
                    amountInput.focus();
                    amountInput.select(); // Select existing text if any
                }
            }
        }
        
        function updateInventoryFromInline(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;
            
            const amountInput = document.getElementById(`inline-amount-${ingredientId}`);
            const unitSelect = document.getElementById(`inline-unit-${ingredientId}`);
            
            const amount = parseFloat(amountInput.value);
            const unit = unitSelect.value;
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Check if ingredient already exists in inventory
            const existing = inventory.find(item => 
                item.name.toLowerCase() === ingredient.name.toLowerCase()
            );
            
            if (existing) {
                existing.amount = amount;
                existing.unit = unit;
            } else {
                inventory.push({
                    id: Date.now(),
                    name: ingredient.name,
                    amount: amount,
                    unit: unit,
                    dilution: 1.0
                });
            }
            
            // Update database entry with inventory information
            const dbEntry = getOrCreateDatabaseEntry(ingredient.name);
            dbEntry.currentInventory = amount;
            dbEntry.inventoryUnit = unit;
            dbEntry.lastUpdated = new Date().toISOString();
            
            // Clear form and close
            amountInput.value = '';
            document.getElementById(`inline-form-${ingredientId}`).classList.remove('active');
            
            renderInventory();
            render(); // Re-render to update stars and colors
            
            // Refresh database view if we're on the database tab
            if (currentTab === 'database') {
                renderDatabase();
            }
        }
        
        function removeInventoryFromInline(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;
            
            inventory = inventory.filter(item => 
                item.name.toLowerCase() !== ingredient.name.toLowerCase()
            );
            
            // Close form
            document.getElementById(`inline-form-${ingredientId}`).classList.remove('active');
            
            renderInventory();
            render(); // Re-render to update stars and colors
        }

        // Compound Substitution Functions
        function showCompoundSubstitutionForm(ingredientId) {
            // Hide regular substitution form and show compound form
            const regularForm = document.querySelector(`#substitution-form-regular-${ingredientId}`);
            const compoundForm = document.querySelector(`#substitution-form-compound-${ingredientId}`);
            
            if (regularForm) regularForm.style.display = 'none';
            if (compoundForm) {
                compoundForm.style.display = 'block';
                updateCompoundPercentageTotal(ingredientId);
            }
        }
        
        function hideCompoundSubstitutionForm(ingredientId) {
            const regularForm = document.querySelector(`#substitution-form-regular-${ingredientId}`);
            const compoundForm = document.querySelector(`#substitution-form-compound-${ingredientId}`);
            
            if (regularForm) regularForm.style.display = 'block';
            if (compoundForm) compoundForm.style.display = 'none';
        }
        
        function updateCompoundPercentageTotal(ingredientId) {
            const inputs = document.querySelectorAll(`[id^="compound-percentage-${ingredientId}-"]`);
            let total = 0;
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            const totalDisplay = document.querySelector(`#compound-total-${ingredientId}`);
            if (totalDisplay) {
                totalDisplay.textContent = `Total: ${total}%`;
                totalDisplay.className = 'percentage-total';
                
                if (total === 100) {
                    totalDisplay.classList.add('valid');
                } else {
                    totalDisplay.classList.add('invalid');
                }
            }
        }
        
        function addCompoundIngredientRow(ingredientId) {
            const container = document.querySelector(`#compound-ingredients-${ingredientId}`);
            if (!container) return;
            
            const rowCount = container.children.length;
            const newRow = document.createElement('div');
            newRow.className = 'compound-ingredient-row';
            newRow.innerHTML = `
                <input type="text" 
                       class="compound-ingredient-input" 
                       placeholder="Substitute ingredient ${rowCount + 1}"
                       list="compound-inventory-datalist-${ingredientId}"
                       id="compound-ingredient-${ingredientId}-${rowCount}">
                <input type="number" 
                       class="compound-percentage-input" 
                       placeholder="%" 
                       min="0" 
                       max="100" 
                       step="0.1"
                       id="compound-percentage-${ingredientId}-${rowCount}"
                       onchange="updateCompoundPercentageTotal(${ingredientId})">
                <button onclick="removeCompoundIngredientRow(this, ${ingredientId})" 
                        class="btn" style="background: #ef4444; color: white; padding: 2px 6px; font-size: 10px;">
                    ×
                </button>
            `;
            
            container.appendChild(newRow);
        }
        
        function removeCompoundIngredientRow(button, ingredientId) {
            button.parentElement.remove();
            updateCompoundPercentageTotal(ingredientId);
        }
        
        function applyCompoundSubstitution(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;
            
            // Collect all compound ingredients
            const container = document.querySelector(`#compound-ingredients-${ingredientId}`);
            if (!container) return;
            
            const compoundIngredients = [];
            const rows = container.children;
            
            for (let i = 0; i < rows.length; i++) {
                const nameInput = document.querySelector(`#compound-ingredient-${ingredientId}-${i}`);
                const percentageInput = document.querySelector(`#compound-percentage-${ingredientId}-${i}`);
                
                if (nameInput && percentageInput) {
                    const name = nameInput.value.trim();
                    const percentage = parseFloat(percentageInput.value) || 0;
                    
                    if (name && percentage > 0) {
                        compoundIngredients.push({ name, percentage });
                    }
                }
            }
            
            // Validate total percentage
            const totalPercentage = compoundIngredients.reduce((sum, ing) => sum + ing.percentage, 0);
            if (Math.abs(totalPercentage - 100) > 0.1) {
                alert('Percentages must add up to 100%');
                return;
            }
            
            if (compoundIngredients.length < 2) {
                alert('Please add at least 2 substitute ingredients');
                return;
            }
            
            // Store original ingredient info
            const originalName = ingredient.name;
            const originalVolume = ingredient.volume;
            const originalGroup = ingredient.group;
            const compoundId = Date.now();
            
            // Record in database
            const dbEntry = getOrCreateDatabaseEntry(originalName);
            const compoundSub = {
                type: 'compound',
                ingredients: compoundIngredients,
                date: new Date().toISOString()
            };
            
            if (!dbEntry.compoundSubstitutions) {
                dbEntry.compoundSubstitutions = [];
            }
            dbEntry.compoundSubstitutions.push(compoundSub);
            
            // Remove original ingredient
            const originalIndex = ingredients.findIndex(i => i.id === ingredientId);
            ingredients.splice(originalIndex, 1);
            groups[originalGroup].ingredients = groups[originalGroup].ingredients.filter(i => i !== ingredientId);
            
            // Add new compound ingredients
            compoundIngredients.forEach((compIng, index) => {
                const calculatedVolume = (originalVolume * compIng.percentage / 100);
                
                const newIngredient = {
                    id: Date.now() + index,
                    name: compIng.name,
                    dilution: ingredient.dilution,
                    volume: calculatedVolume,
                    group: originalGroup,
                    notes: '',
                    substituted: false,
                    isCompoundSubstitute: true,
                    originalIngredient: originalName,
                    compoundId: compoundId,
                    compoundPercentage: compIng.percentage
                };
                
                ingredients.push(newIngredient);
                groups[originalGroup].ingredients.push(newIngredient.id);
                
                // Create database entries for substitutes
                getOrCreateDatabaseEntry(compIng.name);
            });
            
            render();
        }
        
        function undoCompoundSubstitution(compoundId) {
            // Find all ingredients that are part of this compound substitution
            const compoundIngredients = ingredients.filter(i => i.compoundId === compoundId);
            if (compoundIngredients.length === 0) return;
            
            const originalName = compoundIngredients[0].originalIngredient;
            const originalGroup = compoundIngredients[0].group;
            const originalDilution = compoundIngredients[0].dilution;
            
            // Calculate total volume from all compound ingredients
            const totalVolume = compoundIngredients.reduce((sum, ing) => sum + ing.volume, 0);
            
            // Remove all compound ingredients
            compoundIngredients.forEach(compIng => {
                const index = ingredients.findIndex(i => i.id === compIng.id);
                if (index !== -1) {
                    ingredients.splice(index, 1);
                }
                groups[originalGroup].ingredients = groups[originalGroup].ingredients.filter(i => i !== compIng.id);
            });
            
            // Recreate original ingredient
            const restoredIngredient = {
                id: Date.now(),
                name: originalName,
                dilution: originalDilution,
                volume: totalVolume,
                group: originalGroup,
                notes: '',
                substituted: false
            };
            
            ingredients.push(restoredIngredient);
            groups[originalGroup].ingredients.push(restoredIngredient.id);
            
            render();
        }

        // Notes and Substitution Functions
        function toggleIngredientExpansion(ingredientId) {
            if (expandedIngredients.has(ingredientId)) {
                expandedIngredients.delete(ingredientId);
            } else {
                expandedIngredients.add(ingredientId);
            }
            render();
        }

        function updateIngredientNotes(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            const notesTextarea = document.querySelector(`#notes-${ingredientId}`);
            
            if (ingredient && notesTextarea) {
                ingredient.notes = notesTextarea.value;
                // Don't re-render to avoid losing focus
            }
        }
        
        function updateDatabaseNotes(ingredientName, notes) {
            const dbEntry = getOrCreateDatabaseEntry(ingredientName);
            dbEntry.notes = notes.trim();
            
            // Refresh database view if we're on the database tab
            if (currentTab === 'database') {
                renderDatabase();
            }
        }

        function substituteIngredient(ingredientId, substituteName = null) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            if (substituteName) {
                // Apply substitution
                ingredient.originalName = ingredient.originalName || ingredient.name;
                ingredient.name = substituteName;
                ingredient.substituted = true;
                ingredient.notes = (ingredient.notes || '') + 
                    `\n[Substituted: ${ingredient.originalName} → ${substituteName}]`;
                
                // Record this substitution in the database for future reference
                const originalDbEntry = getOrCreateDatabaseEntry(ingredient.originalName);
                const substituteDbEntry = getOrCreateDatabaseEntry(substituteName);
                
                // Add bidirectional substitution knowledge
                if (!originalDbEntry.substitutions.includes(substituteName)) {
                    originalDbEntry.substitutions.push(substituteName);
                }
                if (!substituteDbEntry.substitutions.includes(ingredient.originalName)) {
                    substituteDbEntry.substitutions.push(ingredient.originalName);
                }
            } else {
                // Get substitution name from input
                const substitutionInput = document.querySelector(`#substitution-${ingredientId}`);
                if (substitutionInput && substitutionInput.value.trim()) {
                    substituteIngredient(ingredientId, substitutionInput.value.trim());
                    return;
                }
            }
            
            render();
            updateRecipeCoverage();
        }

        function clearSubstitution(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient || !ingredient.substituted) return;

            ingredient.name = ingredient.originalName || ingredient.name;
            ingredient.substituted = false;
            delete ingredient.originalName;
            
            // Remove substitution note
            if (ingredient.notes) {
                ingredient.notes = ingredient.notes.replace(/\n\[Substituted:.*?\]/g, '');
            }
            
            render();
            updateRecipeCoverage();
        }

        function getSubstitutionSuggestions(ingredientName) {
            const normalizedName = ingredientName.toLowerCase().replace(/[®™]/g, '').trim();
            const suggestions = [];
            
            // Check substitution database
            for (const [key, subs] of Object.entries(substitutionDatabase)) {
                if (normalizedName.includes(key) || key.includes(normalizedName)) {
                    subs.forEach(sub => {
                        if (!suggestions.some(s => s.name.toLowerCase() === sub.toLowerCase())) {
                            suggestions.push({
                                name: sub,
                                source: 'database',
                                reason: 'Similar function'
                            });
                        }
                    });
                    break;
                }
            }
            
            // Check inventory for available alternatives
            inventory.forEach(item => {
                const itemName = item.name.toLowerCase().replace(/[®™]/g, '');
                
                // Skip if it's the same ingredient
                if (itemName === normalizedName) return;
                
                // Look for similar ingredients in inventory
                if (itemName.includes(normalizedName.split(' ')[0]) || 
                    normalizedName.includes(itemName.split(' ')[0])) {
                    if (!suggestions.some(s => s.name.toLowerCase() === item.name.toLowerCase())) {
                        suggestions.push({
                            name: item.name,
                            source: 'inventory',
                            reason: `${item.amount}${item.unit} available`
                        });
                    }
                }
            });
            
            return suggestions.slice(0, 5); // Limit to 5 suggestions
        }

        function showSubstitutionSuggestions(ingredientId, inputElement) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            const suggestions = getSubstitutionSuggestions(ingredient.name);
            if (suggestions.length === 0) return;

            // Remove existing dropdown
            const existing = document.querySelector('.suggestions-dropdown');
            if (existing) existing.remove();

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'suggestions-dropdown';
            
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.onclick = () => {
                    substituteIngredient(ingredientId, suggestion.name);
                    dropdown.remove();
                };
                
                item.innerHTML = `
                    <span>${suggestion.name}</span>
                    <span class="suggestion-source">${suggestion.reason}</span>
                `;
                
                dropdown.appendChild(item);
            });

            // Position and show dropdown
            const container = inputElement.parentElement;
            container.style.position = 'relative';
            container.appendChild(dropdown);

            // Remove dropdown when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== inputElement) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        // Main functions
        function addIngredient() {
            const name = document.getElementById('ingredientName').value.trim();
            const dilution = parseFloat(document.getElementById('ingredientDilution').value);
            const volume = parseFloat(document.getElementById('ingredientVolume').value);

            if (!name) return;
            
            // Create or get database entry for this ingredient
            const dbEntry = getOrCreateDatabaseEntry(name);

            const ingredient = {
                id: Date.now(),
                name: name,
                dilution: dilution,
                volume: volume,
                group: 'Unassigned',
                notes: '',
                substituted: false
            };

            ingredients.push(ingredient);
            groups['Unassigned'].ingredients.push(ingredient.id);

            // Clear form
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientDilution').value = '1.0';
            document.getElementById('ingredientVolume').value = '0';

            render();
        }
        
        // Auto-populate form when ingredient name changes
        function onIngredientNameChange() {
            const name = document.getElementById('ingredientName').value.trim();
            if (!name) return;
            
            const dbEntry = ingredientDatabase.find(entry => 
                entry.name.toLowerCase() === name.toLowerCase()
            );
            
            if (dbEntry) {
                // Auto-populate dilution and volume from database
                if (dbEntry.dilution && dbEntry.dilution !== 1.0) {
                    document.getElementById('ingredientDilution').value = dbEntry.dilution;
                }
                if (dbEntry.typicalUsage && dbEntry.typicalUsage > 0) {
                    document.getElementById('ingredientVolume').value = dbEntry.typicalUsage;
                }
            }
        }

        function addGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name || groups[name]) return;

            const colorIndex = Object.keys(groups).length % groupColors.length;
            groups[name] = {
                ingredients: [],
                expanded: true,
                color: groupColors[colorIndex]
            };

            document.getElementById('groupName').value = '';
            render();
        }

        function deleteIngredient(id) {
            const ingredient = ingredients.find(i => i.id === id);
            if (ingredient) {
                groups[ingredient.group].ingredients = groups[ingredient.group].ingredients.filter(i => i !== id);
            }
            ingredients = ingredients.filter(i => i.id !== id);
            render();
        }

        function moveIngredient(ingredientId, targetGroup) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient || ingredient.group === targetGroup) return;

            // Remove from old group
            groups[ingredient.group].ingredients = groups[ingredient.group].ingredients.filter(i => i !== ingredientId);
            
            // Add to new group
            groups[targetGroup].ingredients.push(ingredientId);
            
            // Update ingredient group
            ingredient.group = targetGroup;
            
            render();
        }

        function toggleGroup(groupName) {
            groups[groupName].expanded = !groups[groupName].expanded;
            render();
        }

        // Edit functionality
        let editingIngredient = null;
        let originalIngredientData = null;

        function startEditIngredient(ingredientId) {
            // If already editing another ingredient, cancel that first
            if (editingIngredient && editingIngredient !== ingredientId) {
                cancelEditIngredient();
            }

            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            editingIngredient = ingredientId;
            originalIngredientData = { ...ingredient }; // Store original data for cancel
            render();
        }

        function saveEditIngredient(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            // Get values from edit inputs
            const nameInput = document.querySelector(`#edit-name-${ingredientId}`);
            const dilutionInput = document.querySelector(`#edit-dilution-${ingredientId}`);
            const volumeInput = document.querySelector(`#edit-volume-${ingredientId}`);

            if (!nameInput || !dilutionInput || !volumeInput) return;

            const newName = nameInput.value.trim();
            const newDilution = parseFloat(dilutionInput.value);
            const newVolume = parseFloat(volumeInput.value);

            // Validate inputs
            if (!newName) {
                alert('Ingredient name cannot be empty');
                return;
            }
            if (isNaN(newDilution) || newDilution <= 0 || newDilution > 1) {
                alert('Dilution must be between 0 and 1 (e.g., 0.1 for 10%)');
                return;
            }
            if (isNaN(newVolume) || newVolume < 0) {
                alert('Volume must be a positive number');
                return;
            }

            // Update ingredient
            ingredient.name = newName;
            ingredient.dilution = newDilution;
            ingredient.volume = newVolume;

            // Clear edit state
            editingIngredient = null;
            originalIngredientData = null;

            render();
        }

        function cancelEditIngredient() {
            if (editingIngredient && originalIngredientData) {
                // Restore original data
                const ingredient = ingredients.find(i => i.id === editingIngredient);
                if (ingredient) {
                    ingredient.name = originalIngredientData.name;
                    ingredient.dilution = originalIngredientData.dilution;
                    ingredient.volume = originalIngredientData.volume;
                }
            }

            editingIngredient = null;
            originalIngredientData = null;
            render();
        }

        function render() {
            // Check if recipe is complete and update body class
            const isRecipeComplete = checkRecipeComplete();
            const banner = document.getElementById('recipeCompleteBanner');
            if (isRecipeComplete && ingredients.length > 0) {
                document.body.classList.add('recipe-complete');
                banner.style.display = 'block';
            } else {
                document.body.classList.remove('recipe-complete');
                banner.style.display = 'none';
            }
            
            // Update stats
            document.getElementById('totalActives').textContent = getTotalActives().toFixed(2);
            document.getElementById('totalIngredients').textContent = ingredients.length;
            document.getElementById('totalGroups').textContent = Object.keys(groups).length;

            // Render groups
            const container = document.getElementById('groupsGrid');
            container.innerHTML = '';

            Object.entries(groups).forEach(([groupName, groupData]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = `group ${groupData.color}`;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'group-header';
                headerDiv.onclick = () => toggleGroup(groupName);

                headerDiv.innerHTML = `
                    <div class="group-header-left">
                        <i data-lucide="${groupData.expanded ? 'chevron-down' : 'chevron-right'}" class="icon"></i>
                        <h3 class="group-title">${groupName}</h3>
                        <span class="group-count">(${groupData.ingredients.length} ingredients)</span>
                    </div>
                    <div class="group-stats">
                        <div class="group-actives">${getGroupActives(groupName).toFixed(2)} μL actives</div>
                        <div class="group-percentage">${getGroupPercentage(groupName)}% of total</div>
                    </div>
                `;

                groupDiv.appendChild(headerDiv);

                if (groupData.expanded) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'group-content';
                    
                    // Add drag and drop handlers
                    contentDiv.ondragover = (e) => e.preventDefault();
                    contentDiv.ondrop = (e) => {
                        e.preventDefault();
                        if (draggedItem) {
                            moveIngredient(draggedItem, groupName);
                            draggedItem = null;
                        }
                    };

                    if (groupData.ingredients.length === 0) {
                        contentDiv.innerHTML = '<div class="drop-zone">Drop ingredients here or drag from other groups</div>';
                    } else {
                        const gridDiv = document.createElement('div');
                        gridDiv.className = 'ingredients-grid';

                        // Group ingredients by compound substitution
                        const groupedIngredients = {};
                        const standaloneIngredients = [];
                        
                        groupData.ingredients.forEach(ingredientId => {
                            const ingredient = ingredients.find(i => i.id === ingredientId);
                            if (!ingredient) return;
                            
                            if (ingredient.isCompoundSubstitute && ingredient.compoundId) {
                                const compoundKey = ingredient.compoundId.toString();
                                if (!groupedIngredients[compoundKey]) {
                                    groupedIngredients[compoundKey] = [];
                                }
                                groupedIngredients[compoundKey].push(ingredient);
                            } else {
                                standaloneIngredients.push(ingredient);
                            }
                        });
                        
                        // Debug compound substitutions
                        if (Object.keys(groupedIngredients).length > 0) {
                            console.log(`Group ${groupName} has ${Object.keys(groupedIngredients).length} compound substitution(s):`, groupedIngredients);
                        }
                        
                        // Render compound substitution groups first
                        Object.entries(groupedIngredients).forEach(([compoundId, compoundIngredients]) => {
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'compound-substitution-group';
                            
                            const originalName = compoundIngredients[0].originalIngredient;
                            const totalVolume = compoundIngredients.reduce((sum, ing) => sum + ing.volume, 0);
                            
                            groupDiv.innerHTML = `
                                <div class="compound-substitution-header">
                                    <div style="display: flex; flex-direction: column; flex: 1;">
                                        <div style="font-weight: 600; color: #d97706;">
                                            🔄 SPLIT SUBSTITUTION
                                        </div>
                                        <div style="font-size: 11px; color: #92400e; margin-top: 2px;">
                                            Original: <strong>${originalName}</strong> (${totalVolume.toFixed(1)}μL) → ${compoundIngredients.length} substitutes
                                        </div>
                                    </div>
                                    <div class="compound-substitution-controls">
                                        <button onclick="undoCompoundSubstitution(${compoundId})" 
                                                class="btn" style="background: #6b7280; color: white; font-size: 10px; padding: 2px 6px;">
                                            🔄 Undo Split
                                        </button>
                                    </div>
                                </div>
                                <div style="background: #fefbf3; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #f59e0b;">
                                    <div style="font-size: 11px; color: #92400e; font-weight: 500;">
                                        Split Breakdown:
                                    </div>
                                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">
                                        ${compoundIngredients.map(ing => `${ing.name} (${ing.compoundPercentage}%)`).join(' + ')}
                                    </div>
                                </div>
                                <div class="compound-ingredients-container">
                                    ${compoundIngredients.map(ingredient => {
                                        const inventoryStatus = getInventoryStatus(ingredient.name);
                                        const isEditing = editingIngredient === ingredient.id;
                                        
                                        let cardClasses = 'ingredient-card';
                                        if (isEditing) cardClasses += ' ingredient-edit';
                                        if (!isEditing) {
                                            if (inventoryStatus.available) {
                                                cardClasses += ' has-inventory';
                                            } else {
                                                cardClasses += ' missing-inventory';
                                            }
                                        }
                                        
                                        return `
                                            <div class="${cardClasses}" style="margin-bottom: 8px;">
                                                <div class="ingredient-header">
                                                    <div class="ingredient-info">
                                                        <div style="display: flex; align-items: center; gap: 4px;">
                                                            <h4 class="ingredient-name">${ingredient.name}</h4>
                                                            <span class="inventory-star ${inventoryStatus.available ? 'available' : 'missing'}" 
                                                                  onclick="toggleInlineInventoryForm(${ingredient.id})"
                                                                  title="${inventoryStatus.available ? 'In inventory - click to edit' : 'Not in inventory - click to add'}">
                                                                ${inventoryStatus.available ? '⭐' : '☆'}
                                                            </span>
                                                            <span style="font-size: 10px; color: #d97706; background: #fef3c7; padding: 1px 4px; border-radius: 3px;">
                                                                Replaces ${ingredient.compoundPercentage}% of <strong>${originalName}</strong>
                                                            </span>
                                                        </div>
                                                        <p class="ingredient-details">${ingredient.volume.toFixed(1)}μL @ ${(ingredient.dilution * 100).toFixed(1)}%</p>
                                                        <p class="ingredient-actives">${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                                    </div>
                                                    <div class="ingredient-actions">
                                                        <button onclick="deleteIngredient(${ingredient.id})" class="btn-red">
                                                            <i data-lucide="trash-2" class="icon-sm"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                            
                            gridDiv.appendChild(groupDiv);
                        });
                        
                        // Render standalone ingredients
                        standaloneIngredients.forEach(ingredient => {
                            const cardDiv = document.createElement('div');
                            const isEditing = editingIngredient === ingredient.id;
                            const isSubstituted = ingredient.substituted;
                            const inventoryStatus = getInventoryStatus(ingredient.name);
                            
                            let cardClasses = 'ingredient-card';
                            if (isEditing) cardClasses += ' ingredient-edit';
                            if (isSubstituted) cardClasses += ' ingredient-substituted';
                            if (!isEditing) {
                                if (inventoryStatus.available) {
                                    cardClasses += ' has-inventory';
                                } else {
                                    cardClasses += ' missing-inventory';
                                }
                            }
                            
                            cardDiv.className = cardClasses;
                            cardDiv.draggable = !isEditing;
                            if (!isEditing) {
                                cardDiv.ondragstart = () => draggedItem = ingredient.id;
                            }

                            if (isEditing) {
                                cardDiv.innerHTML = `
                                    <div class="ingredient-header">
                                        <div class="ingredient-info">
                                            <div style="position: relative;">
                                                <input type="text" 
                                                       id="edit-name-${ingredient.id}" 
                                                       class="edit-input" 
                                                       value="${ingredient.name}" 
                                                       placeholder="Ingredient name"
                                                       list="edit-inventory-datalist-${ingredient.id}">
                                                <datalist id="edit-inventory-datalist-${ingredient.id}">
                                                    ${inventory.map(item => `<option value="${item.name}" label="${item.amount}${item.unit} available">`).join('')}
                                                </datalist>
                                            </div>
                                            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">💡 Type or click dropdown to align with inventory names</div>
                                            <div style="display: flex; gap: 4px;">
                                                <input type="number" id="edit-volume-${ingredient.id}" class="edit-input" value="${ingredient.volume}" step="0.1" placeholder="Volume (μL)" style="flex: 1;">
                                                <input type="number" id="edit-dilution-${ingredient.id}" class="edit-input" value="${ingredient.dilution}" step="0.001" min="0" max="1" placeholder="Dilution" style="flex: 1;">
                                            </div>
                                            <p class="ingredient-actives" style="margin-top: 4px;">Preview: ${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                        </div>
                                    </div>
                                    <div class="edit-actions">
                                        <button onclick="saveEditIngredient(${ingredient.id})" class="btn btn-save">
                                            <i data-lucide="check" class="icon-sm"></i> Save
                                        </button>
                                        <button onclick="cancelEditIngredient()" class="btn btn-cancel">
                                            <i data-lucide="x" class="icon-sm"></i> Cancel
                                        </button>
                                    </div>
                                `;
                            } else {
                                const isExpanded = expandedIngredients.has(ingredient.id);
                                const isSubstituted = ingredient.substituted;
                                
                                // Get notes from database
                                const dbEntry = ingredientDatabase.find(entry => 
                                    entry.name.toLowerCase() === ingredient.name.toLowerCase()
                                );
                                const dbNotes = dbEntry ? dbEntry.notes : '';
                                const dbSubstitutions = dbEntry ? dbEntry.substitutions : [];
                                
                                cardDiv.innerHTML = `
                                    <div class="ingredient-header">
                                        <div class="ingredient-info">
                                            ${isSubstituted ? `<div class="substitution-info">
                                                <i data-lucide="arrow-right" class="icon-sm"></i>
                                                Substituted: ${ingredient.originalName}
                                                <button onclick="clearSubstitution(${ingredient.id})" class="btn-clear-sub">
                                                    <i data-lucide="x" class="icon-sm"></i>
                                                </button>
                                            </div>` : ''}
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <h4 class="ingredient-name">${ingredient.name}</h4>
                                                <span class="inventory-star ${inventoryStatus.available ? 'available' : 'missing'}" 
                                                      onclick="toggleInlineInventoryForm(${ingredient.id})"
                                                      title="${inventoryStatus.available ? 'In inventory - click to edit' : 'Not in inventory - click to add'}">
                                                    ${inventoryStatus.available ? '⭐' : '☆'}
                                                </span>
                                                <button onclick="toggleIngredientExpansion(${ingredient.id})" class="expand-toggle">
                                                    ${isExpanded ? '▼' : '▶'} ${isExpanded ? 'Less' : 'More'}
                                                </button>
                                            </div>
                                            <p class="ingredient-details">${ingredient.volume}μL @ ${(ingredient.dilution * 100).toFixed(1)}%</p>
                                            <p class="ingredient-actives">${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                            
                                            ${dbNotes ? `<div class="ingredient-notes">${dbNotes}</div>` : ''}
                                            
                                            ${isExpanded ? `
                                                <div class="substitution-controls">
                                                    <div style="font-size: 11px; font-weight: 500; margin-bottom: 4px;">Inventory Status:</div>
                                                    ${inventoryStatus.available ? 
                                                        `<div class="inventory-status-detail">
                                                            ✓ Available: ${inventoryStatus.amount}${inventoryStatus.unit}
                                                            <a href="https://perfumersapprentice.com/search?q=${encodeURIComponent(ingredient.name)}" 
                                                               target="_blank" class="purchase-link">Buy more</a>
                                                        </div>` :
                                                        `<div class="inventory-status-missing">
                                                            ✗ Not in inventory
                                                            <a href="https://perfumersapprentice.com/search?q=${encodeURIComponent(ingredient.name)}" 
                                                               target="_blank" class="purchase-link">Buy</a>
                                                        </div>`
                                                    }
                                                    
                                                    <div class="inline-inventory-form" id="inline-form-${ingredient.id}">
                                                        <div style="font-size: 11px; font-weight: 500; margin-bottom: 4px;">
                                                            ${inventoryStatus.available ? 'Update Inventory:' : 'Add to Inventory:'}
                                                        </div>
                                                        <div class="inventory-form-row">
                                                            <input type="number" 
                                                                   id="inline-amount-${ingredient.id}" 
                                                                   class="inventory-form-input" 
                                                                   placeholder="Amount" 
                                                                   step="0.1" 
                                                                   value="${inventoryStatus.available ? inventoryStatus.amount : ''}">
                                                            <select id="inline-unit-${ingredient.id}" class="inventory-form-input" style="flex: 0 0 60px;">
                                                                <option value="ml" ${inventoryStatus.unit === 'ml' ? 'selected' : ''}>ml</option>
                                                                <option value="g" ${inventoryStatus.unit === 'g' ? 'selected' : ''}>g</option>
                                                                <option value="μL" ${inventoryStatus.unit === 'μL' ? 'selected' : ''}>μL</option>
                                                            </select>
                                                            <button onclick="updateInventoryFromInline(${ingredient.id})" 
                                                                    class="btn" style="background: #10b981; color: white; padding: 4px 8px; font-size: 10px;">
                                                                ${inventoryStatus.available ? 'Update' : 'Add'}
                                                            </button>
                                                        </div>
                                                        ${inventoryStatus.available ? `
                                                            <button onclick="removeInventoryFromInline(${ingredient.id})" 
                                                                    class="btn" style="background: #ef4444; color: white; padding: 2px 6px; font-size: 10px; margin-top: 4px;">
                                                                Remove from Inventory
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                    
                                                    <div style="font-size: 11px; font-weight: 500; margin: 12px 0 4px 0;">Database Notes:</div>
                                                    <textarea id="notes-${ingredient.id}" 
                                                             class="notes-textarea" 
                                                             placeholder="Add notes about this ingredient..."
                                                             onblur="updateDatabaseNotes('${ingredient.name}', this.value)">${dbNotes}</textarea>
                                                    
                                                    <div style="font-size: 11px; font-weight: 500; margin: 8px 0 4px 0;">Known Substitutions:</div>
                                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">
                                                        ${dbSubstitutions.length > 0 ? dbSubstitutions.join(', ') : 'None recorded'}
                                                    </div>
                                                    
                                                    <div style="font-size: 11px; font-weight: 500; margin: 8px 0 4px 0;">Add Substitution:</div>
                                                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">💡 Type or click dropdown to see inventory items</div>
                                                    <div class="substitution-form" id="substitution-form-regular-${ingredient.id}">
                                                        <input type="text" 
                                                               id="substitution-${ingredient.id}" 
                                                               class="input" 
                                                               placeholder="Enter substitute ingredient"
                                                               list="inventory-datalist-${ingredient.id}"
                                                               onfocus="showSubstitutionSuggestions(${ingredient.id}, this)"
                                                               style="font-size: 11px;">
                                                        <datalist id="inventory-datalist-${ingredient.id}">
                                                            ${inventory.map(item => `<option value="${item.name}" label="${item.amount}${item.unit} available">`).join('')}
                                                        </datalist>
                                                        <button onclick="substituteIngredient(${ingredient.id})" class="btn btn-substitute">
                                                            <i data-lucide="arrow-right" class="icon-sm"></i>
                                                        </button>
                                                    </div>
                                                    
                                                    <div style="margin-top: 8px;">
                                                        <button onclick="showCompoundSubstitutionForm(${ingredient.id})" 
                                                                class="btn" style="background: #f59e0b; color: white; font-size: 10px; padding: 3px 6px;">
                                                            ⚗️ Split Substitution
                                                        </button>
                                                    </div>
                                                    
                                                    <div class="compound-substitution-form" 
                                                         id="substitution-form-compound-${ingredient.id}" 
                                                         style="display: none;">
                                                                                                                 <div style="font-size: 11px; font-weight: 500; margin-bottom: 4px;">
                                                             Split "${ingredient.name}" into multiple ingredients:
                                                         </div>
                                                         <div style="font-size: 10px; color: #6b7280; margin-bottom: 8px;">💡 Type or click dropdown to see inventory items</div>
                                                        <div id="compound-ingredients-${ingredient.id}">
                                                                                                                         <div class="compound-ingredient-row">
                                                                 <input type="text" 
                                                                        class="compound-ingredient-input" 
                                                                        placeholder="Substitute ingredient 1"
                                                                        list="compound-inventory-datalist-${ingredient.id}"
                                                                        id="compound-ingredient-${ingredient.id}-0">
                                                                 <input type="number" 
                                                                        class="compound-percentage-input" 
                                                                        placeholder="%" 
                                                                        min="0" 
                                                                        max="100" 
                                                                        step="0.1"
                                                                        id="compound-percentage-${ingredient.id}-0"
                                                                        onchange="updateCompoundPercentageTotal(${ingredient.id})">
                                                                 <button onclick="removeCompoundIngredientRow(this, ${ingredient.id})" 
                                                                         class="btn" style="background: #ef4444; color: white; padding: 2px 6px; font-size: 10px;">
                                                                     ×
                                                                 </button>
                                                             </div>
                                                             <div class="compound-ingredient-row">
                                                                 <input type="text" 
                                                                        class="compound-ingredient-input" 
                                                                        placeholder="Substitute ingredient 2"
                                                                        list="compound-inventory-datalist-${ingredient.id}"
                                                                        id="compound-ingredient-${ingredient.id}-1">
                                                                 <input type="number" 
                                                                        class="compound-percentage-input" 
                                                                        placeholder="%" 
                                                                        min="0" 
                                                                        max="100" 
                                                                        step="0.1"
                                                                        id="compound-percentage-${ingredient.id}-1"
                                                                        onchange="updateCompoundPercentageTotal(${ingredient.id})">
                                                                 <button onclick="removeCompoundIngredientRow(this, ${ingredient.id})" 
                                                                         class="btn" style="background: #ef4444; color: white; padding: 2px 6px; font-size: 10px;">
                                                                     ×
                                                                 </button>
                                                             </div>
                                                         </div>
                                                         <datalist id="compound-inventory-datalist-${ingredient.id}">
                                                             ${inventory.map(item => `<option value="${item.name}" label="${item.amount}${item.unit} available">`).join('')}
                                                         </datalist>
                                                        </div>
                                                        <div id="compound-total-${ingredient.id}" class="percentage-total">Total: 0%</div>
                                                        <div style="margin-top: 8px; display: flex; gap: 4px; justify-content: center;">
                                                            <button onclick="addCompoundIngredientRow(${ingredient.id})" 
                                                                    class="btn" style="background: #10b981; color: white; font-size: 10px; padding: 3px 6px;">
                                                                + Add Ingredient
                                                            </button>
                                                            <button onclick="applyCompoundSubstitution(${ingredient.id})" 
                                                                    class="btn btn-compound">
                                                                Apply Split
                                                            </button>
                                                            <button onclick="hideCompoundSubstitutionForm(${ingredient.id})" 
                                                                    class="btn" style="background: #6b7280; color: white; font-size: 10px; padding: 3px 6px;">
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="ingredient-actions">
                                            <i data-lucide="move" class="icon-sm text-gray"></i>
                                            <button onclick="startEditIngredient(${ingredient.id})" class="btn-edit">
                                                <i data-lucide="edit" class="icon-sm"></i>
                                            </button>
                                            <button onclick="deleteIngredient(${ingredient.id})" class="btn-red">
                                                <i data-lucide="trash-2" class="icon-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }

                            gridDiv.appendChild(cardDiv);
                        });

                        contentDiv.appendChild(gridDiv);
                    }

                    groupDiv.appendChild(contentDiv);
                }

                container.appendChild(groupDiv);
            });

            // Initialize Lucide icons with error handling
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Lucide icons failed to load:', error);
                // Fallback: replace icons with text
                document.querySelectorAll('[data-lucide]').forEach(el => {
                    const iconName = el.getAttribute('data-lucide');
                    if (iconName === 'chevron-down') el.innerHTML = '▼';
                    else if (iconName === 'chevron-right') el.innerHTML = '▶';
                    else if (iconName === 'plus') el.innerHTML = '+';
                    else if (iconName === 'download') el.innerHTML = '↓';
                    else if (iconName === 'upload') el.innerHTML = '↑';
                    else if (iconName === 'trash-2') el.innerHTML = '×';
                    else if (iconName === 'move') el.innerHTML = '⌖';
                    else if (iconName === 'edit') el.innerHTML = '✎';
                    else if (iconName === 'check') el.innerHTML = '✓';
                    else if (iconName === 'x') el.innerHTML = '×';
                    else if (iconName === 'plus-circle') el.innerHTML = '⊕';
                    else if (iconName === 'folder-plus') el.innerHTML = '📁+';
                    else if (iconName === 'save') el.innerHTML = '💾';
                    else if (iconName === 'package') el.innerHTML = '📦';
                    else if (iconName === 'file-text') el.innerHTML = '📄';
                    else if (iconName === 'database') el.innerHTML = '🗄️';
                    else if (iconName === 'arrow-right') el.innerHTML = '→';
                    else el.innerHTML = iconName;
                });
            }
            
            // Update JSON preview and inventory coverage
            updateJsonPreview();
            updateRecipeCoverage();
        }

        // Handle Enter key in form inputs
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize tab state
            switchTab('composer');
            
            document.getElementById('ingredientName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addIngredient();
            });
            
            document.getElementById('groupName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addGroup();
            });

            // Global keyboard shortcuts for edit mode
            document.addEventListener('keydown', (e) => {
                if (editingIngredient) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveEditIngredient(editingIngredient);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEditIngredient();
                    }
                }
            });

            // Initial render
            render();
            renderInventory();
        });

        // Database Management Functions
        function getOrCreateDatabaseEntry(ingredientName) {
            let dbEntry = ingredientDatabase.find(entry => 
                entry.name.toLowerCase() === ingredientName.toLowerCase()
            );
            
            if (!dbEntry) {
                dbEntry = {
                    id: Date.now() + Math.random(),
                    name: ingredientName,
                    notes: '',
                    substitutions: [],
                    dilution: 1.0,
                    typicalUsage: 0,
                    olfactoryFamily: '',
                    customColor: null // New field for smell-based color
                };
                ingredientDatabase.push(dbEntry);
            }
            
            return dbEntry;
        }
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.getElementById('composerTab').className = tabName === 'composer' ? 'btn tab-active' : 'btn tab-inactive';
            document.getElementById('databaseTab').className = tabName === 'database' ? 'btn tab-active' : 'btn tab-inactive';
            document.getElementById('visualizerTab').className = tabName === 'visualizer' ? 'btn tab-active' : 'btn tab-inactive';
            
            // Show/hide sidebar content
            document.getElementById('composerContent').style.display = tabName === 'composer' ? 'block' : 'none';
            document.getElementById('databaseContent').style.display = tabName === 'database' ? 'block' : 'none';
            document.getElementById('visualizerContent').style.display = tabName === 'visualizer' ? 'block' : 'none';
            
            // Show/hide main content areas
            document.getElementById('groupsContainer').style.display = tabName === 'composer' ? 'block' : 'none';
            document.getElementById('visualizationContainer').style.display = tabName === 'visualizer' ? 'block' : 'none';
            
            if (tabName === 'database') {
                renderDatabase();
            } else if (tabName === 'visualizer') {
                renderVisualization();
            }
        }
        
        function exportDatabase() {
            const databaseData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalEntries: ingredientDatabase.length,
                database: ingredientDatabase
            };

            const jsonString = JSON.stringify(databaseData, null, 2);
            
            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-ingredient-database-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const databaseData = JSON.parse(e.target.result);
                    
                    if (!databaseData.database || !Array.isArray(databaseData.database)) {
                        throw new Error('Invalid database format');
                    }

                    // Merge with existing database
                    databaseData.database.forEach(importedEntry => {
                        const existing = ingredientDatabase.find(entry => 
                            entry.name.toLowerCase() === importedEntry.name.toLowerCase()
                        );
                        
                        if (existing) {
                            // Merge notes with separator
                            if (importedEntry.notes && importedEntry.notes.trim()) {
                                if (existing.notes && existing.notes.trim()) {
                                    existing.notes += '\n---\n' + importedEntry.notes;
                                } else {
                                    existing.notes = importedEntry.notes;
                                }
                            }
                            
                            // Merge substitutions
                            if (importedEntry.substitutions && Array.isArray(importedEntry.substitutions)) {
                                importedEntry.substitutions.forEach(sub => {
                                    if (!existing.substitutions.includes(sub)) {
                                        existing.substitutions.push(sub);
                                    }
                                });
                            }
                            
                            // Update other fields if they're better/newer
                            if (importedEntry.dilution && !existing.dilution) existing.dilution = importedEntry.dilution;
                            if (importedEntry.typicalUsage && !existing.typicalUsage) existing.typicalUsage = importedEntry.typicalUsage;
                            if (importedEntry.olfactoryFamily && !existing.olfactoryFamily) existing.olfactoryFamily = importedEntry.olfactoryFamily;
                        } else {
                            // Add new entry
                            ingredientDatabase.push({
                                id: Date.now() + Math.random(),
                                name: importedEntry.name || 'Unknown',
                                notes: importedEntry.notes || '',
                                substitutions: Array.isArray(importedEntry.substitutions) ? importedEntry.substitutions : [],
                                dilution: parseFloat(importedEntry.dilution) || 1.0,
                                typicalUsage: parseFloat(importedEntry.typicalUsage) || 0,
                                olfactoryFamily: importedEntry.olfactoryFamily || ''
                            });
                        }
                    });

                    if (currentTab === 'database') {
                        renderDatabase();
                    }
                    alert('Database imported and merged successfully!');
                } catch (error) {
                    alert('Error importing database: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        let currentSort = { field: 'name', direction: 'asc' };
        let filteredDatabase = [];
        
        function renderDatabase() {
            const searchTerm = document.getElementById('databaseSearch').value.toLowerCase();
            
            // Filter database
            filteredDatabase = ingredientDatabase.filter(entry =>
                entry.name.toLowerCase().includes(searchTerm) ||
                entry.notes.toLowerCase().includes(searchTerm) ||
                entry.olfactoryFamily.toLowerCase().includes(searchTerm) ||
                entry.substitutions.some(sub => sub.toLowerCase().includes(searchTerm))
            );
            
            // Sort database
            filteredDatabase.sort((a, b) => {
                let aVal = a[currentSort.field] || '';
                let bVal = b[currentSort.field] || '';
                
                if (currentSort.field === 'substitutions') {
                    aVal = aVal.join(', ');
                    bVal = bVal.join(', ');
                }
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            const container = document.getElementById('databaseTable');
            
            if (filteredDatabase.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 14px; margin-bottom: 8px;">📝 No ingredients in database</div>
                        <div style="font-size: 11px;">Add ingredients to your recipe to build the database!</div>
                        <div style="font-size: 11px; margin-top: 4px;">Total database entries: ${ingredientDatabase.length}</div>
                    </div>
                `;
                return;
            }
            
            const getSortIndicator = (field) => {
                if (currentSort.field === field) {
                    return `<span class="sort-indicator">${currentSort.direction === 'asc' ? '↑' : '↓'}</span>`;
                }
                return '<span class="sort-indicator">↕</span>';
            };
            
            container.innerHTML = `
                <table class="db-table">
                    <thead>
                        <tr>
                            <th onclick="sortDatabase('name')">Name ${getSortIndicator('name')}</th>
                            <th onclick="sortDatabase('olfactoryFamily')">Family ${getSortIndicator('olfactoryFamily')}</th>
                            <th onclick="sortDatabase('currentInventory')">Inventory ${getSortIndicator('currentInventory')}</th>
                            <th onclick="sortDatabase('dilution')">Dilution ${getSortIndicator('dilution')}</th>
                            <th onclick="sortDatabase('typicalUsage')">Usage ${getSortIndicator('typicalUsage')}</th>
                            <th onclick="sortDatabase('notes')">Notes ${getSortIndicator('notes')}</th>
                            <th onclick="sortDatabase('substitutions')">Substitutions ${getSortIndicator('substitutions')}</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredDatabase.map(entry => `
                            <tr id="db-row-${entry.id}">
                                <td><strong>${entry.name}</strong></td>
                                <td>${entry.olfactoryFamily || ''}</td>
                                <td>${entry.currentInventory ? `${entry.currentInventory}${entry.inventoryUnit || 'ml'}` : 'None'}</td>
                                <td>${entry.dilution || 1.0}</td>
                                <td>${entry.typicalUsage || 0}μL</td>
                                <td class="notes-cell" title="${entry.notes || ''}">${entry.notes || ''}</td>
                                <td class="subs-cell" title="${(entry.substitutions || []).join(', ')}">${(entry.substitutions || []).join(', ')}</td>
                                <td class="db-actions">
                                    <button onclick="editDatabaseEntry(${entry.id})" class="db-btn" title="Edit" style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px;">
                                        ✏️ Edit
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function sortDatabase(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            renderDatabase();
        }
        
        function filterDatabase() {
            renderDatabase();
        }
        
        let editingDatabaseEntry = null;
        
        function editDatabaseEntry(entryId) {
            const entry = ingredientDatabase.find(e => e.id === entryId);
            if (!entry) return;
            
            editingDatabaseEntry = entryId;
            
            const row = document.getElementById(`db-row-${entryId}`);
            if (!row) return;
            
            row.innerHTML = `
                <td><input type="text" class="db-edit-input" value="${entry.name}" id="edit-db-name-${entryId}"></td>
                <td><input type="text" class="db-edit-input" value="${entry.olfactoryFamily || ''}" id="edit-db-family-${entryId}" placeholder="e.g., Citrus, Woody, Floral"></td>
                <td><input type="number" class="db-edit-input" value="${entry.currentInventory || ''}" id="edit-db-inventory-${entryId}" step="0.1" min="0" placeholder="Amount"></td>
                <td><input type="number" class="db-edit-input" value="${entry.dilution || 1.0}" id="edit-db-dilution-${entryId}" step="0.001" min="0" max="1"></td>
                <td><input type="number" class="db-edit-input" value="${entry.typicalUsage || 0}" id="edit-db-usage-${entryId}" step="0.1" min="0"></td>
                <td><textarea class="db-edit-textarea" id="edit-db-notes-${entryId}" placeholder="Notes about this ingredient...">${entry.notes || ''}</textarea></td>
                <td><textarea class="db-edit-textarea" id="edit-db-subs-${entryId}" placeholder="Comma-separated substitutions">${(entry.substitutions || []).join(', ')}</textarea></td>
                <td class="db-actions">
                    <button onclick="saveDatabaseEntry(${entryId})" class="db-btn" title="Save" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 4px;">
                        ✅ Save
                    </button>
                    <button onclick="cancelEditDatabase()" class="db-btn" title="Cancel" style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px;">
                        ❌ Cancel
                    </button>
                </td>
            `;
        }
        
        function saveDatabaseEntry(entryId) {
            const entry = ingredientDatabase.find(e => e.id === entryId);
            if (!entry) return;
            
            const name = document.getElementById(`edit-db-name-${entryId}`).value.trim();
            const family = document.getElementById(`edit-db-family-${entryId}`).value.trim();
            const inventoryAmount = parseFloat(document.getElementById(`edit-db-inventory-${entryId}`).value);
            const dilution = parseFloat(document.getElementById(`edit-db-dilution-${entryId}`).value);
            const usage = parseFloat(document.getElementById(`edit-db-usage-${entryId}`).value);
            const notes = document.getElementById(`edit-db-notes-${entryId}`).value.trim();
            const subsText = document.getElementById(`edit-db-subs-${entryId}`).value.trim();
            
            if (!name) {
                alert('Ingredient name cannot be empty');
                return;
            }
            
            // Update entry
            entry.name = name;
            entry.olfactoryFamily = family;
            entry.currentInventory = isNaN(inventoryAmount) ? 0 : inventoryAmount;
            entry.inventoryUnit = entry.inventoryUnit || 'ml';
            entry.dilution = isNaN(dilution) ? 1.0 : dilution;
            entry.typicalUsage = isNaN(usage) ? 0 : usage;
            entry.notes = notes;
            entry.substitutions = subsText ? subsText.split(',').map(s => s.trim()).filter(s => s) : [];
            entry.lastUpdated = new Date().toISOString();
            
            // Also update the main inventory if this ingredient exists there
            const inventoryItem = inventory.find(item => 
                item.name.toLowerCase() === name.toLowerCase()
            );
            if (inventoryItem && entry.currentInventory > 0) {
                inventoryItem.amount = entry.currentInventory;
                inventoryItem.unit = entry.inventoryUnit;
                renderInventory();
                render(); // Update stars and colors
            } else if (!inventoryItem && entry.currentInventory > 0) {
                // Add to inventory if it doesn't exist but has inventory amount
                inventory.push({
                    id: Date.now(),
                    name: name,
                    amount: entry.currentInventory,
                    unit: entry.inventoryUnit,
                    dilution: entry.dilution
                });
                renderInventory();
                render(); // Update stars and colors
            }
            
            editingDatabaseEntry = null;
            renderDatabase();
        }
        
        function cancelEditDatabase() {
            editingDatabaseEntry = null;
            renderDatabase();
        }
        
        // 3D Molecular Visualization
        let scene, camera, renderer, raycaster, mouse;
        let molecules = [];
        let molecularMotion = false;
        let hoveredMolecule = null;
        let ingredientColors = new Map();
        
        function initializeMolecularVisualization() {
            console.log('🚀 Starting molecular visualization initialization...');
            
            if (typeof THREE === 'undefined') {
                console.error('❌ Three.js not loaded');
                document.getElementById('molecularVisualization').innerHTML = 
                    '<div style="color: red; padding: 20px; text-align: center;">Three.js failed to load. Please refresh the page.</div>';
                return;
            }
            
            console.log('✅ Three.js loaded successfully');
            
            const container = document.getElementById('molecularVisualization');
            if (!container) {
                console.error('❌ Container not found');
                return;
            }
            
            console.log('✅ Container found:', container);
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            console.log('✅ Scene created');
            
            // Camera setup - positioned to view the molecular plane optimally
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 25); // Moved back slightly for better plane view
            console.log('✅ Camera created at position:', camera.position);
            
            // Renderer setup
            try {
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                
                // Fix size issue - use fallback dimensions if container not sized yet
                let width = container.clientWidth || 800;
                let height = container.clientHeight || 500;
                
                // If still 0, get from parent or use computed style
                if (width === 0 || height === 0) {
                    const computedStyle = window.getComputedStyle(container);
                    width = parseInt(computedStyle.width) || 800;
                    height = parseInt(computedStyle.height) || 500;
                }
                
                renderer.setSize(width, height);
                renderer.setPixelRatio(window.devicePixelRatio);
                console.log('✅ Renderer created, size:', width, 'x', height);
                
                // Update camera aspect ratio
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                
                // Clear any existing content
                container.innerHTML = '';
                container.appendChild(renderer.domElement);
                console.log('✅ Renderer canvas added to container');
            } catch (error) {
                console.error('❌ WebGL renderer failed:', error);
                container.innerHTML = '<div style="color: red; padding: 20px; text-align: center;">WebGL not supported on this device.</div>';
                return;
            }
            
            // Mouse interaction setup
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // Add ambient light for general illumination
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // Add multiple point lights for dramatic effect
            const pointLight1 = new THREE.PointLight(0xffffff, 1.5, 100);
            pointLight1.position.set(10, 10, 10);
            scene.add(pointLight1);
            
            const pointLight2 = new THREE.PointLight(0x4a9eff, 0.8, 80);
            pointLight2.position.set(-10, -10, 5);
            scene.add(pointLight2);
            
            const pointLight3 = new THREE.PointLight(0xff6b4a, 0.6, 60);
            pointLight3.position.set(0, 15, -10);
            scene.add(pointLight3);
            
            // Add directional light for better visibility
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            // Add mouse event listeners
            container.addEventListener('mousemove', onMolecularMouseMove);
            container.addEventListener('click', onMolecularClick);
            container.addEventListener('wheel', onMolecularWheel);
            container.addEventListener('mousedown', onMolecularMouseDown);
            container.addEventListener('mouseup', onMolecularMouseUp);
            
            // Add keyboard controls
            document.addEventListener('keydown', onMolecularKeyDown);
            
            // Make container focusable for keyboard events
            container.tabIndex = 0;
            
            // Add a test cube to verify visibility (temporary) - on the molecular plane
            const testGeometry = new THREE.BoxGeometry(2, 2, 2);
            const testMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff0000, 
                emissive: 0x440000 
            });
            const testCube = new THREE.Mesh(testGeometry, testMaterial);
            testCube.position.set(0, 0, 0); // On the molecular plane
            scene.add(testCube);
            console.log('🔴 Test cube added at molecular plane center');
            
            // Force immediate render
            renderer.render(scene, camera);
            console.log('🎬 First render completed');
            
            // Remove test cube after 3 seconds
            setTimeout(() => {
                scene.remove(testCube);
                console.log('🔴 Test cube removed');
            }, 3000);
            
            // Start animation loop
            animateMolecularScene();
            
            console.log('3D Molecular visualization initialized with test cube');
        }
        
        function assignIngredientVisuals() {
            ingredients.forEach(ingredient => {
                // Check if ingredient has custom color in database
                const dbEntry = ingredientDatabase.find(entry => 
                    entry.name.toLowerCase() === ingredient.name.toLowerCase()
                );
                
                if (dbEntry && dbEntry.customColor) {
                    // Use custom color from database
                    ingredientColors.set(ingredient.name, dbEntry.customColor);
                } else if (!ingredientColors.has(ingredient.name)) {
                    // Generate automatic color as fallback
                    const hue = (ingredient.name.charCodeAt(0) * 137.5) % 360;
                    const saturation = 70 + (ingredient.name.length * 5) % 30;
                    const lightness = 50 + (ingredient.name.charCodeAt(1) * 3) % 20;
                    ingredientColors.set(ingredient.name, `hsl(${hue}, ${saturation}%, ${lightness}%)`);
                }
            });
        }
        
        function showIngredientColorPicker(ingredientName) {
            // Remove any existing color picker
            const existingPicker = document.getElementById('ingredient-color-picker');
            if (existingPicker) {
                existingPicker.remove();
            }
            
            // Get current color
            const currentColor = ingredientColors.get(ingredientName) || '#ffffff';
            const hexColor = convertToHex(currentColor);
            
            // Create color picker modal
            const modal = document.createElement('div');
            modal.id = 'ingredient-color-picker';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="background: #1f2937; padding: 30px; border-radius: 12px; max-width: 400px; color: white; border: 1px solid #3b82f6;">
                    <h3 style="margin: 0 0 20px 0; color: #3b82f6; text-align: center;">🎨 Choose Color for "${ingredientName}"</h3>
                    
                    <div style="background: #1e3a8a; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 12px; color: #bfdbfe;">💡 <strong>Choose a color that represents the smell of this ingredient</strong></div>
                        <div style="font-size: 11px; color: #93c5fd; margin-top: 4px;">Examples: Citrus = Yellow/Orange, Woody = Brown, Floral = Pink/Purple, Fresh = Green/Blue</div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <input type="color" 
                               id="color-picker-input" 
                               value="${hexColor}" 
                               style="width: 80px; height: 80px; border: none; border-radius: 8px; cursor: pointer; background: none;">
                        <div style="margin-top: 8px; font-size: 12px; color: #d1d5db;">Current: ${hexColor}</div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="applyIngredientColor('${ingredientName}')" 
                                style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ✅ Apply Color
                        </button>
                        <button onclick="resetIngredientColor('${ingredientName}')" 
                                style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            🔄 Reset to Auto
                        </button>
                        <button onclick="closeIngredientColorPicker()" 
                                style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ❌ Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeIngredientColorPicker();
                }
            };
            
            document.body.appendChild(modal);
        }
        
        function applyIngredientColor(ingredientName) {
            const colorInput = document.getElementById('color-picker-input');
            if (!colorInput) return;
            
            const newColor = colorInput.value;
            
            // Update ingredient color
            ingredientColors.set(ingredientName, newColor);
            
            // Save to database
            const dbEntry = getOrCreateDatabaseEntry(ingredientName);
            dbEntry.customColor = newColor;
            
            // Update 3D visualization if we're on that tab
            if (currentTab === 'visualizer') {
                updateMoleculeColor(ingredientName, newColor);
            }
            
            // Update legend
            updateVisualizationLegend();
            
            // Close picker
            closeIngredientColorPicker();
            
            console.log(`Applied custom color ${newColor} to ${ingredientName}`);
        }
        
        function resetIngredientColor(ingredientName) {
            // Remove custom color from database
            const dbEntry = ingredientDatabase.find(entry => 
                entry.name.toLowerCase() === ingredientName.toLowerCase()
            );
            if (dbEntry) {
                dbEntry.customColor = null;
            }
            
            // Generate new automatic color
            const hue = (ingredientName.charCodeAt(0) * 137.5) % 360;
            const saturation = 70 + (ingredientName.length * 5) % 30;
            const lightness = 50 + (ingredientName.charCodeAt(1) * 3) % 20;
            const autoColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            
            // Update ingredient color
            ingredientColors.set(ingredientName, autoColor);
            
            // Update 3D visualization if we're on that tab
            if (currentTab === 'visualizer') {
                updateMoleculeColor(ingredientName, autoColor);
            }
            
            // Update legend
            updateVisualizationLegend();
            
            // Close picker
            closeIngredientColorPicker();
            
            console.log(`Reset ${ingredientName} to automatic color: ${autoColor}`);
        }
        
        function closeIngredientColorPicker() {
            const picker = document.getElementById('ingredient-color-picker');
            if (picker) {
                picker.remove();
            }
        }
        
        function updateMoleculeColor(ingredientName, newColor) {
            // Find the molecule in the 3D scene and update its color
            molecules.forEach(mol => {
                if (mol.ingredient.name === ingredientName) {
                    const color = new THREE.Color(newColor);
                    
                    // Update main material
                    mol.mesh.material.color = color;
                    mol.mesh.material.emissive = color.clone().multiplyScalar(0.4);
                    
                    // Update wireframe material
                    if (mol.mesh.userData.wireframeMesh) {
                        mol.mesh.userData.wireframeMesh.material.color = color.clone().multiplyScalar(1.5);
                    }
                }
            });
        }
        
        function convertToHex(color) {
            // Convert various color formats to hex
            if (color.startsWith('#')) {
                return color;
            }
            
            if (color.startsWith('hsl')) {
                // Create a temporary element to convert HSL to hex
                const temp = document.createElement('div');
                temp.style.color = color;
                document.body.appendChild(temp);
                const rgbColor = window.getComputedStyle(temp).color;
                document.body.removeChild(temp);
                
                // Parse RGB values
                const rgbMatch = rgbColor.match(/\d+/g);
                if (rgbMatch) {
                    const r = parseInt(rgbMatch[0]);
                    const g = parseInt(rgbMatch[1]);
                    const b = parseInt(rgbMatch[2]);
                    return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                }
            }
            
            // Fallback
            return '#ffffff';
        }
        
        function resetAllColorsToAuto() {
            if (confirm('Reset all ingredient colors to automatic? This will remove all custom smell-based colors.')) {
                // Remove custom colors from all database entries
                ingredientDatabase.forEach(entry => {
                    entry.customColor = null;
                });
                
                // Regenerate all colors
                ingredients.forEach(ingredient => {
                    const hue = (ingredient.name.charCodeAt(0) * 137.5) % 360;
                    const saturation = 70 + (ingredient.name.length * 5) % 30;
                    const lightness = 50 + (ingredient.name.charCodeAt(1) * 3) % 20;
                    const autoColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    ingredientColors.set(ingredient.name, autoColor);
                    
                    // Update 3D visualization
                    if (currentTab === 'visualizer') {
                        updateMoleculeColor(ingredient.name, autoColor);
                    }
                });
                
                // Update displays
                updateVisualizationLegend();
                updateVisualizationStats();
                
                console.log('Reset all colors to automatic');
            }
        }
        
        function showColorPresets() {
            // Remove any existing color picker
            const existingPicker = document.getElementById('ingredient-color-picker');
            if (existingPicker) {
                existingPicker.remove();
            }
            
            // Create color presets modal
            const modal = document.createElement('div');
            modal.id = 'ingredient-color-picker';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            const colorPresets = {
                'Citrus': '#FFA500',  // Orange
                'Woody': '#8B4513',   // Saddle Brown
                'Floral': '#FFB6C1',  // Light Pink
                'Fresh/Green': '#32CD32', // Lime Green
                'Spicy': '#DC143C',   // Crimson
                'Sweet': '#FFD700',   // Gold
                'Musky': '#8A2BE2',   // Blue Violet
                'Marine': '#00CED1',  // Dark Turquoise
                'Fruity': '#FF69B4',  // Hot Pink
                'Herbal': '#228B22'   // Forest Green
            };
            
            modal.innerHTML = `
                <div style="background: #1f2937; padding: 30px; border-radius: 12px; max-width: 500px; color: white; border: 1px solid #3b82f6;">
                    <h3 style="margin: 0 0 20px 0; color: #3b82f6; text-align: center;">🎨 Color Presets for Fragrance Families</h3>
                    
                    <div style="background: #1e3a8a; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 12px; color: #bfdbfe;">💡 <strong>Quick color assignment based on common fragrance families</strong></div>
                        <div style="font-size: 11px; color: #93c5fd; margin-top: 4px;">Click a preset color to apply to ingredients that match the family name</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        ${Object.entries(colorPresets).map(([family, color]) => `
                            <button onclick="applyFamilyColorPreset('${family}', '${color}')" 
                                    style="background: ${color}; color: ${getBestTextColor(color)}; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                ${family}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="closeIngredientColorPicker()" 
                                style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ❌ Close
                        </button>
                    </div>
                </div>
            `;
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeIngredientColorPicker();
                }
            };
            
            document.body.appendChild(modal);
        }
        
        function getBestTextColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // Calculate relative luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }
        
        function applyFamilyColorPreset(family, color) {
            const familyLower = family.toLowerCase();
            let appliedCount = 0;
            
            ingredients.forEach(ingredient => {
                const ingredientName = ingredient.name.toLowerCase();
                
                // Check if ingredient name contains family keywords
                let matches = false;
                switch (familyLower) {
                    case 'citrus':
                        matches = ingredientName.includes('lemon') || ingredientName.includes('orange') || 
                                 ingredientName.includes('bergamot') || ingredientName.includes('lime') ||
                                 ingredientName.includes('grapefruit') || ingredientName.includes('citrus');
                        break;
                    case 'woody':
                        matches = ingredientName.includes('cedar') || ingredientName.includes('sandalwood') ||
                                 ingredientName.includes('vetiver') || ingredientName.includes('wood') ||
                                 ingredientName.includes('timber') || ingredientName.includes('oak');
                        break;
                    case 'floral':
                        matches = ingredientName.includes('rose') || ingredientName.includes('jasmine') ||
                                 ingredientName.includes('lavender') || ingredientName.includes('geranium') ||
                                 ingredientName.includes('floral') || ingredientName.includes('flower');
                        break;
                    case 'fresh/green':
                        matches = ingredientName.includes('mint') || ingredientName.includes('eucalyptus') ||
                                 ingredientName.includes('grass') || ingredientName.includes('green') ||
                                 ingredientName.includes('fresh') || ingredientName.includes('leaf');
                        break;
                    case 'spicy':
                        matches = ingredientName.includes('pepper') || ingredientName.includes('cinnamon') ||
                                 ingredientName.includes('clove') || ingredientName.includes('spice') ||
                                 ingredientName.includes('ginger') || ingredientName.includes('cardamom');
                        break;
                    case 'sweet':
                        matches = ingredientName.includes('vanilla') || ingredientName.includes('caramel') ||
                                 ingredientName.includes('honey') || ingredientName.includes('sugar') ||
                                 ingredientName.includes('sweet') || ingredientName.includes('candy');
                        break;
                    case 'musky':
                        matches = ingredientName.includes('musk') || ingredientName.includes('ambergris') ||
                                 ingredientName.includes('civet') || ingredientName.includes('animalic');
                        break;
                    case 'marine':
                        matches = ingredientName.includes('marine') || ingredientName.includes('ocean') ||
                                 ingredientName.includes('sea') || ingredientName.includes('aquatic') ||
                                 ingredientName.includes('water') || ingredientName.includes('algae');
                        break;
                    case 'fruity':
                        matches = ingredientName.includes('apple') || ingredientName.includes('peach') ||
                                 ingredientName.includes('strawberry') || ingredientName.includes('pear') ||
                                 ingredientName.includes('fruit') || ingredientName.includes('berry');
                        break;
                    case 'herbal':
                        matches = ingredientName.includes('herb') || ingredientName.includes('basil') ||
                                 ingredientName.includes('thyme') || ingredientName.includes('sage') ||
                                 ingredientName.includes('rosemary') || ingredientName.includes('oregano');
                        break;
                }
                
                if (matches) {
                    // Apply color
                    ingredientColors.set(ingredient.name, color);
                    
                    // Save to database
                    const dbEntry = getOrCreateDatabaseEntry(ingredient.name);
                    dbEntry.customColor = color;
                    
                    // Update 3D visualization
                    if (currentTab === 'visualizer') {
                        updateMoleculeColor(ingredient.name, color);
                    }
                    
                    appliedCount++;
                }
            });
            
            // Update displays
            updateVisualizationLegend();
            updateVisualizationStats();
            closeIngredientColorPicker();
            
            alert(`Applied ${family} color to ${appliedCount} ingredient(s)`);
        }
        
        function updateSpherePower(value) {
            spherePower = parseFloat(value);
            document.getElementById('spherePowerValue').textContent = spherePower.toFixed(1);
            
            // Update visualization in real-time
            if (currentTab === 'visualizer') {
                renderVisualization();
            }
        }
        
        function updateTerritoryPower(value) {
            territoryPower = parseFloat(value);
            document.getElementById('territoryPowerValue').textContent = territoryPower.toFixed(1);
            
            // Update visualization in real-time
            if (currentTab === 'visualizer') {
                renderVisualization();
            }
        }
        
        function calculateTerritoryAllocations() {
            if (ingredients.length === 0) return [];
            
            const totalActives = getTotalActives();
            const territories = [];
            
            // Calculate territory data for each ingredient
            ingredients.forEach((ingredient, index) => {
                const actives = getActives(ingredient);
                const activeRatio = totalActives > 0 ? actives / totalActives : 0;
                const poweredActiveRatio = Math.pow(activeRatio, territoryPower); // Apply variable power to territory ratio
                
                // Inverse territory calculation: higher ratio = smaller territory
                // Scale territory radius inversely to powered active ratio
                const minTerritoryRadius = 1.5; // Minimum territory for high-concentration ingredients
                const maxTerritoryRadius = 6.0; // Maximum territory for low-concentration ingredients
                
                // Inverse mapping: 100% ratio gets minRadius, 0% ratio gets maxRadius
                const territoryRadius = maxTerritoryRadius - (poweredActiveRatio * (maxTerritoryRadius - minTerritoryRadius));
                
                territories.push({
                    ingredient: ingredient,
                    activeRatio: activeRatio,
                    territoryRadius: territoryRadius,
                    index: index
                });
            });
            
            return territories;
        }
        
        function assignTerritoryPositions(territories) {
            if (territories.length === 0) return territories;
            
            // Simple circle packing algorithm
            const visualizationRadius = 12; // Overall area radius
            const positionedTerritories = [];
            
            // Sort by territory size (largest territories first for better packing)
            const sortedTerritories = [...territories].sort((a, b) => b.territoryRadius - a.territoryRadius);
            
            sortedTerritories.forEach((territory, index) => {
                let position = { x: 0, y: 0 };
                let attempts = 0;
                const maxAttempts = 100;
                
                if (index === 0) {
                    // First territory goes in center
                    position = { x: 0, y: 0 };
                } else {
                    // Try to find a non-overlapping position
                    let validPosition = false;
                    
                    while (!validPosition && attempts < maxAttempts) {
                        // Generate random position within visualization area
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * (visualizationRadius - territory.territoryRadius);
                        
                        position.x = Math.cos(angle) * distance;
                        position.y = Math.sin(angle) * distance;
                        
                        // Check if this position overlaps with existing territories
                        validPosition = true;
                        for (const existingTerritory of positionedTerritories) {
                            const dx = position.x - existingTerritory.centerX;
                            const dy = position.y - existingTerritory.centerY;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const minDistance = territory.territoryRadius + existingTerritory.territoryRadius + 0.5; // Small buffer
                            
                            if (distance < minDistance) {
                                validPosition = false;
                                break;
                            }
                        }
                        
                        attempts++;
                    }
                }
                
                // If we couldn't find a valid position, place it randomly
                if (attempts >= maxAttempts) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * visualizationRadius * 0.8;
                    position.x = Math.cos(angle) * distance;
                    position.y = Math.sin(angle) * distance;
                }
                
                // Store the positioned territory
                const positionedTerritory = {
                    ...territory,
                    centerX: position.x,
                    centerY: position.y
                };
                
                positionedTerritories.push(positionedTerritory);
            });
            
            return positionedTerritories;
        }
        
        function renderVisualization() {
            if (!scene || !renderer) {
                setTimeout(initializeMolecularVisualization, 100);
                return;
            }
            
            if (ingredients.length === 0) {
                renderEmptyMolecularScene();
                return;
            }
            
            // Clear existing molecules
            molecules.forEach(mol => {
                if (mol.group) {
                    scene.remove(mol.group);
                } else {
                    scene.remove(mol.mesh);
                }
            });
            molecules = [];
            
            // Assign visual properties
            assignIngredientVisuals();
            
            // Calculate territory allocations
            const territories = calculateTerritoryAllocations();
            const positionedTerritories = assignTerritoryPositions(territories);
            
            // Create molecules for each ingredient
            const totalActives = getTotalActives();
            const totalPoweredActives = ingredients.reduce((sum, ing) => {
                const actives = getActives(ing);
                return sum + Math.pow(actives, spherePower);
            }, 0);
            // Dynamic radius range based on power - higher power = more extreme size differences
            const baseMaxRadius = 2.0;
            const baseMinRadius = 0.3;
            const powerMultiplier = Math.pow(spherePower, 0.5); // Scale radius range with power
            const maxRadius = baseMaxRadius * powerMultiplier;
            const minRadius = baseMinRadius / powerMultiplier;
            
            ingredients.forEach((ingredient, index) => {
                const actives = getActives(ingredient);
                const poweredActives = Math.pow(actives, spherePower); // Apply variable power for dramatic visual differences
                const percentage = totalActives > 0 ? (actives / totalActives) * 100 : 0;
                const poweredPercentage = totalPoweredActives > 0 ? (poweredActives / totalPoweredActives) * 100 : 0;
                
                // Size based on powered percentage for more dramatic visual differences
                const radius = minRadius + (poweredPercentage / 100) * (maxRadius - minRadius);
                
                // Create sphere geometry (all ingredients are now spheres)
                const geometry = createMolecularGeometry('sphere', radius);
                
                // Create glowing material with enhanced visibility
                const color = new THREE.Color(ingredientColors.get(ingredient.name) || '#ffffff');
                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color.clone().multiplyScalar(0.4),
                    shininess: 100,
                    transparent: true,
                    opacity: 0.85,
                    specular: 0x444444
                });
                
                // Create wireframe overlay for better definition
                const wireframeMaterial = new THREE.MeshBasicMaterial({
                    color: color.clone().multiplyScalar(1.5),
                    wireframe: true,
                    transparent: true,
                    opacity: 0.3
                });
                
                // Create main mesh with solid material
                const mesh = new THREE.Mesh(geometry, material);
                
                // Create wireframe mesh for edges
                const wireframeMesh = new THREE.Mesh(geometry, wireframeMaterial);
                
                // Find this ingredient's territory
                const territory = positionedTerritories.find(t => t.ingredient.id === ingredient.id);
                
                let x, y;
                const z = 0; // All molecules on the same plane for perfect visibility
                
                if (territory) {
                    // Position within assigned territory (random position within territory circle)
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * territory.territoryRadius * 0.8; // Stay within 80% of territory
                    
                    x = territory.centerX + Math.cos(angle) * distance;
                    y = territory.centerY + Math.sin(angle) * distance;
                } else {
                    // Fallback to old positioning if territory not found
                    const spread = 15;
                    x = (Math.random() - 0.5) * spread;
                    y = (Math.random() - 0.5) * spread;
                }
                
                mesh.position.set(x, y, z);
                wireframeMesh.position.set(x, y, z);
                
                // Add rotation
                const rotX = Math.random() * Math.PI;
                const rotY = Math.random() * Math.PI;
                const rotZ = Math.random() * Math.PI;
                
                mesh.rotation.set(rotX, rotY, rotZ);
                wireframeMesh.rotation.set(rotX, rotY, rotZ);
                
                // Store ingredient data
                const userData = {
                    ingredient: ingredient,
                    originalPosition: mesh.position.clone(),
                    rotationSpeed: {
                        x: (Math.random() - 0.5) * 0.02,
                        y: (Math.random() - 0.5) * 0.02,
                        z: (Math.random() - 0.5) * 0.02
                    },
                    wireframeMesh: wireframeMesh
                };
                
                mesh.userData = userData;
                wireframeMesh.userData = userData;
                
                // Create a group to hold both meshes
                const moleculeGroup = new THREE.Group();
                moleculeGroup.add(mesh);
                moleculeGroup.add(wireframeMesh);
                moleculeGroup.position.set(x, y, z);
                
                scene.add(moleculeGroup);
                molecules.push({ mesh, ingredient, group: moleculeGroup });
            });
            
            // Update HUD
            document.getElementById('moleculeCount').textContent = molecules.length;
            document.getElementById('cameraInfo').textContent = `${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)}`;
            
            // Update legend and stats
            updateVisualizationLegend();
            updateVisualizationStats();
        }
        
        function createMolecularGeometry(shape, radius) {
            // All geometries are now spheres
            return new THREE.SphereGeometry(radius, 16, 12);
        }
        
        function renderEmptyMolecularScene() {
            molecules.forEach(mol => {
                if (mol.group) {
                    scene.remove(mol.group);
                } else {
                    scene.remove(mol.mesh);
                }
            });
            molecules = [];
            
            document.getElementById('moleculeCount').textContent = '0';
            document.getElementById('visualizationLegend').innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">No molecules to display</div>';
            document.getElementById('visualizerStats').innerHTML = '<div style="color: #9ca3af;">Add ingredients to see statistics</div>';
        }
        
        function animateMolecularScene() {
            requestAnimationFrame(animateMolecularScene);
            
            // Rotate molecules if motion is enabled
            if (molecularMotion) {
                molecules.forEach(mol => {
                    const speed = mol.mesh.userData.rotationSpeed;
                    mol.mesh.rotation.x += speed.x;
                    mol.mesh.rotation.y += speed.y;
                    mol.mesh.rotation.z += speed.z;
                    
                    // Also rotate wireframe
                    if (mol.mesh.userData.wireframeMesh) {
                        mol.mesh.userData.wireframeMesh.rotation.x += speed.x;
                        mol.mesh.userData.wireframeMesh.rotation.y += speed.y;
                        mol.mesh.userData.wireframeMesh.rotation.z += speed.z;
                    }
                });
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // Mouse interaction variables
        let isMouseDown = false;
        let mouseX = 0, mouseY = 0;
        let cameraDistance = 20;
        
        function onMolecularMouseMove(event) {
            const rect = event.target.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            // Raycasting for hover detection
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(molecules.map(m => m.mesh));
            
            if (intersects.length > 0) {
                const intersected = intersects[0].object;
                const ingredient = intersected.userData.ingredient;
                
                if (hoveredMolecule !== intersected) {
                    // Reset previous hover
                    if (hoveredMolecule) {
                        hoveredMolecule.material.emissive.multiplyScalar(0.5);
                    }
                    
                    // Set new hover
                    hoveredMolecule = intersected;
                    intersected.material.emissive.multiplyScalar(2);
                    
                    // Show tooltip
                    showMolecularTooltip(event, ingredient);
                }
            } else {
                if (hoveredMolecule) {
                    hoveredMolecule.material.emissive.multiplyScalar(0.5);
                    hoveredMolecule = null;
                    hideMolecularTooltip();
                }
            }
            
            // Camera rotation when dragging
            if (isMouseDown) {
                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;
                
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi += deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                
                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 0, 0);
                
                document.getElementById('cameraInfo').textContent = `${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)}`;
            }
            
            mouseX = event.clientX;
            mouseY = event.clientY;
        }
        

        

        
        function updateVisualizationLegend() {
            const legend = document.getElementById('visualizationLegend');
            if (!legend) return;
            
            if (molecules.length === 0) {
                legend.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">No molecules to display</div>';
                return;
            }
            
            // Group molecules by their ingredient groups
            const groupedMolecules = {};
            molecules.forEach(mol => {
                const groupName = mol.ingredient.group || 'Unassigned';
                if (!groupedMolecules[groupName]) {
                    groupedMolecules[groupName] = [];
                }
                groupedMolecules[groupName].push(mol);
            });
            
            const totalActives = getTotalActives();
            
            const legendHTML = Object.entries(groupedMolecules).map(([groupName, groupMolecules]) => {
                const groupVolume = groupMolecules.reduce((sum, mol) => sum + getActives(mol.ingredient), 0);
                const groupPercentage = totalActives > 0 ? (groupVolume / totalActives * 100).toFixed(1) : 0;
                
                // Get group color info
                const groupInfo = groups[groupName] || {};
                const groupColor = ingredientColors.get(groupMolecules[0].ingredient.name) || '#64748b';
                
                return `
                    <div style="margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(0,0,0,0.1); border: 1px solid ${groupColor};">
                        <div style="font-weight: 600; font-size: 12px; color: ${groupColor}; margin-bottom: 4px;">
                            ${groupName}
                        </div>
                        <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px;">
                            ${groupVolume.toFixed(1)}μL (${groupPercentage}%)
                        </div>
                        <div style="font-size: 10px;">
                            ${groupMolecules.map(mol => {
                                const inventoryStatus = getInventoryStatus(mol.ingredient.name);
                                const percentage = totalActives > 0 ? (getActives(mol.ingredient) / totalActives * 100).toFixed(1) : 0;
                                const dbEntry = ingredientDatabase.find(entry => 
                                    entry.name.toLowerCase() === mol.ingredient.name.toLowerCase()
                                );
                                const hasCustomColor = dbEntry && dbEntry.customColor;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; color: #d1d5db;">
                                        <span style="display: flex; align-items: center; gap: 4px;">
                                            ${inventoryStatus.available ? '⭐' : '☆'} 
                                            <span style="cursor: pointer; color: ${ingredientColors.get(mol.ingredient.name)}; text-decoration: underline;" 
                                                  onclick="showIngredientColorPicker('${mol.ingredient.name}')" 
                                                  title="Click to change color">
                                                ${mol.ingredient.name}
                                            </span>
                                            ${hasCustomColor ? '<span style="color: #10b981; font-size: 8px;">🎨</span>' : '<span style="color: #6b7280; font-size: 8px;">⚙️</span>'}
                                        </span>
                                        <span>${percentage}%</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            legend.innerHTML = legendHTML;
        }
        
        function updateVisualizationStats() {
            const stats = document.getElementById('visualizerStats');
            const colorStats = document.getElementById('colorStats');
            
            if (!stats) return;
            
            if (ingredients.length === 0) {
                stats.innerHTML = '<div style="color: #9ca3af;">Add ingredients to see statistics</div>';
                if (colorStats) colorStats.innerHTML = '<div style="color: #9ca3af;">No ingredients to color</div>';
                return;
            }
            
            const totalActives = getTotalActives();
            const totalIngredients = ingredients.length;
            const uniqueGroups = new Set(ingredients.map(ing => ing.group)).size;
            const availableIngredients = ingredients.filter(ing => getInventoryStatus(ing.name).available).length;
            const coverage = totalIngredients > 0 ? (availableIngredients / totalIngredients * 100).toFixed(1) : 0;
            
            // Color statistics
            const customColorCount = ingredients.filter(ing => {
                const dbEntry = ingredientDatabase.find(entry => 
                    entry.name.toLowerCase() === ing.name.toLowerCase()
                );
                return dbEntry && dbEntry.customColor;
            }).length;
            
            const autoColorCount = totalIngredients - customColorCount;
            
            stats.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: 600; color: #d1d5db;">Total Actives</div>
                        <div style="font-size: 16px; color: #3b82f6;">${totalActives.toFixed(2)} μL</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #d1d5db;">Molecules</div>
                        <div style="font-size: 16px; color: #3b82f6;">${molecules.length}</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #d1d5db;">Groups</div>
                        <div style="font-size: 16px; color: #3b82f6;">${uniqueGroups}</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #d1d5db;">Inventory</div>
                        <div style="font-size: 16px; color: ${coverage >= 100 ? '#10b981' : coverage >= 50 ? '#f59e0b' : '#ef4444'};">${coverage}%</div>
                    </div>
                </div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 8px;">
                    ${availableIngredients}/${totalIngredients} spherical molecules available in inventory
                </div>
                <div style="font-size: 10px; color: #64748b; margin-bottom: 8px;">
                    <strong>Territory System Active:</strong> Higher concentration = smaller territory, lower concentration = more roaming space
                </div>
                <div style="font-size: 10px; color: #64748b;">
                    Sphere size represents active concentration • Territory size is inversely proportional
                </div>
            `;
            
            if (colorStats) {
                colorStats.innerHTML = `
                    <div style="margin-bottom: 4px;">
                        <span style="color: #10b981;">🎨 ${customColorCount} Custom</span> • 
                        <span style="color: #6b7280;">⚙️ ${autoColorCount} Auto</span>
                    </div>
                    <div style="color: #9ca3af; font-size: 9px;">
                        Click ingredient names in legend to customize colors
                    </div>
                `;
            }
        }
        
        function resetAllColorsToAuto() {
            if (confirm('Reset all ingredient colors to automatic? This will remove all custom smell-based colors.')) {
                // Remove custom colors from all database entries
                ingredientDatabase.forEach(entry => {
                    entry.customColor = null;
                });
                
                // Regenerate all colors
                ingredients.forEach(ingredient => {
                    const hue = (ingredient.name.charCodeAt(0) * 137.5) % 360;
                    const saturation = 70 + (ingredient.name.length * 5) % 30;
                    const lightness = 50 + (ingredient.name.charCodeAt(1) * 3) % 20;
                    const autoColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    ingredientColors.set(ingredient.name, autoColor);
                    
                    // Update 3D visualization
                    if (currentTab === 'visualizer') {
                        updateMoleculeColor(ingredient.name, autoColor);
                    }
                });
                
                // Update displays
                updateVisualizationLegend();
                updateVisualizationStats();
                
                console.log('Reset all colors to automatic');
            }
        }
        
        function showColorPresets() {
            // Remove any existing color picker
            const existingPicker = document.getElementById('ingredient-color-picker');
            if (existingPicker) {
                existingPicker.remove();
            }
            
            // Create color presets modal
            const modal = document.createElement('div');
            modal.id = 'ingredient-color-picker';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            const colorPresets = {
                'Citrus': '#FFA500',  // Orange
                'Woody': '#8B4513',   // Saddle Brown
                'Floral': '#FFB6C1',  // Light Pink
                'Fresh/Green': '#32CD32', // Lime Green
                'Spicy': '#DC143C',   // Crimson
                'Sweet': '#FFD700',   // Gold
                'Musky': '#8A2BE2',   // Blue Violet
                'Marine': '#00CED1',  // Dark Turquoise
                'Fruity': '#FF69B4',  // Hot Pink
                'Herbal': '#228B22'   // Forest Green
            };
            
            modal.innerHTML = `
                <div style="background: #1f2937; padding: 30px; border-radius: 12px; max-width: 500px; color: white; border: 1px solid #3b82f6;">
                    <h3 style="margin: 0 0 20px 0; color: #3b82f6; text-align: center;">🎨 Color Presets for Fragrance Families</h3>
                    
                    <div style="background: #1e3a8a; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 12px; color: #bfdbfe;">💡 <strong>Quick color assignment based on common fragrance families</strong></div>
                        <div style="font-size: 11px; color: #93c5fd; margin-top: 4px;">Click a preset color to apply to ingredients that match the family name</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        ${Object.entries(colorPresets).map(([family, color]) => `
                            <button onclick="applyFamilyColorPreset('${family}', '${color}')" 
                                    style="background: ${color}; color: ${getBestTextColor(color)}; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                ${family}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="closeIngredientColorPicker()" 
                                style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ❌ Close
                        </button>
                    </div>
                </div>
            `;
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeIngredientColorPicker();
                }
            };
            
            document.body.appendChild(modal);
        }
        
        function getBestTextColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // Calculate relative luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }
        
        function applyFamilyColorPreset(family, color) {
            const familyLower = family.toLowerCase();
            let appliedCount = 0;
            
            ingredients.forEach(ingredient => {
                const ingredientName = ingredient.name.toLowerCase();
                
                // Check if ingredient name contains family keywords
                let matches = false;
                switch (familyLower) {
                    case 'citrus':
                        matches = ingredientName.includes('lemon') || ingredientName.includes('orange') || 
                                 ingredientName.includes('bergamot') || ingredientName.includes('lime') ||
                                 ingredientName.includes('grapefruit') || ingredientName.includes('citrus');
                        break;
                    case 'woody':
                        matches = ingredientName.includes('cedar') || ingredientName.includes('sandalwood') ||
                                 ingredientName.includes('vetiver') || ingredientName.includes('wood') ||
                                 ingredientName.includes('timber') || ingredientName.includes('oak');
                        break;
                    case 'floral':
                        matches = ingredientName.includes('rose') || ingredientName.includes('jasmine') ||
                                 ingredientName.includes('lavender') || ingredientName.includes('geranium') ||
                                 ingredientName.includes('floral') || ingredientName.includes('flower');
                        break;
                    case 'fresh/green':
                        matches = ingredientName.includes('mint') || ingredientName.includes('eucalyptus') ||
                                 ingredientName.includes('grass') || ingredientName.includes('green') ||
                                 ingredientName.includes('fresh') || ingredientName.includes('leaf');
                        break;
                    case 'spicy':
                        matches = ingredientName.includes('pepper') || ingredientName.includes('cinnamon') ||
                                 ingredientName.includes('clove') || ingredientName.includes('spice') ||
                                 ingredientName.includes('ginger') || ingredientName.includes('cardamom');
                        break;
                    case 'sweet':
                        matches = ingredientName.includes('vanilla') || ingredientName.includes('caramel') ||
                                 ingredientName.includes('honey') || ingredientName.includes('sugar') ||
                                 ingredientName.includes('sweet') || ingredientName.includes('candy');
                        break;
                    case 'musky':
                        matches = ingredientName.includes('musk') || ingredientName.includes('ambergris') ||
                                 ingredientName.includes('civet') || ingredientName.includes('animalic');
                        break;
                    case 'marine':
                        matches = ingredientName.includes('marine') || ingredientName.includes('ocean') ||
                                 ingredientName.includes('sea') || ingredientName.includes('aquatic') ||
                                 ingredientName.includes('water') || ingredientName.includes('algae');
                        break;
                    case 'fruity':
                        matches = ingredientName.includes('apple') || ingredientName.includes('peach') ||
                                 ingredientName.includes('strawberry') || ingredientName.includes('pear') ||
                                 ingredientName.includes('fruit') || ingredientName.includes('berry');
                        break;
                    case 'herbal':
                        matches = ingredientName.includes('herb') || ingredientName.includes('basil') ||
                                 ingredientName.includes('thyme') || ingredientName.includes('sage') ||
                                 ingredientName.includes('rosemary') || ingredientName.includes('oregano');
                        break;
                }
                
                if (matches) {
                    // Apply color
                    ingredientColors.set(ingredient.name, color);
                    
                    // Save to database
                    const dbEntry = getOrCreateDatabaseEntry(ingredient.name);
                    dbEntry.customColor = color;
                    
                    // Update 3D visualization
                    if (currentTab === 'visualizer') {
                        updateMoleculeColor(ingredient.name, color);
                    }
                    
                    appliedCount++;
                }
            });
            
            // Update displays
            updateVisualizationLegend();
            updateVisualizationStats();
            closeIngredientColorPicker();
            
            alert(`Applied ${family} color to ${appliedCount} ingredient(s)`);
        }
        

        
        // Smart Load All Functions
        function loadAllFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            const progressDiv = document.getElementById('loadAllProgress');
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = 'Analyzing files...';
            
            // Analyze each file to determine its type
            const filePromises = files.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            const fileType = detectFileType(data);
                            resolve({
                                name: file.name,
                                data: data,
                                type: fileType,
                                content: e.target.result
                            });
                        } catch (error) {
                            reject(new Error(`Error reading ${file.name}: ${error.message}`));
                        }
                    };
                    reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
                    reader.readAsText(file);
                });
            });
            
            Promise.all(filePromises)
                .then(fileData => {
                    processLoadAllFiles(fileData, progressDiv);
                })
                .catch(error => {
                    progressDiv.innerHTML = `❌ Error: ${error.message}`;
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 3000);
                });
            
            // Reset file input
            event.target.value = '';
        }
        
        function detectFileType(data) {
            // Check for database file
            if (data.database && Array.isArray(data.database)) {
                return 'database';
            }
            
            // Check for inventory file
            if (data.inventory && Array.isArray(data.inventory)) {
                return 'inventory';
            }
            
            // Check for recipe file
            if (data.ingredients && data.groups) {
                return 'recipe';
            }
            
            return 'unknown';
        }
        
        async function processLoadAllFiles(fileData, progressDiv) {
            const databaseFiles = fileData.filter(f => f.type === 'database');
            const inventoryFiles = fileData.filter(f => f.type === 'inventory');
            const recipeFiles = fileData.filter(f => f.type === 'recipe');
            const unknownFiles = fileData.filter(f => f.type === 'unknown');
            
            let results = [];
            
            try {
                // Step 1: Load database files first
                if (databaseFiles.length > 0) {
                    progressDiv.innerHTML = `📚 Loading ${databaseFiles.length} database file(s)...`;
                    await new Promise(resolve => setTimeout(resolve, 500)); // Visual delay
                    
                    for (const file of databaseFiles) {
                        await loadDatabaseFile(file.data);
                        results.push(`✅ Database: ${file.name}`);
                    }
                }
                
                // Step 2: Load inventory files next
                if (inventoryFiles.length > 0) {
                    progressDiv.innerHTML = `📦 Loading ${inventoryFiles.length} inventory file(s)...`;
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    for (const file of inventoryFiles) {
                        await loadInventoryFile(file.data);
                        results.push(`✅ Inventory: ${file.name}`);
                    }
                }
                
                // Step 3: Load recipe files last
                if (recipeFiles.length > 0) {
                    progressDiv.innerHTML = `🧪 Loading ${recipeFiles.length} recipe file(s)...`;
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    for (const file of recipeFiles) {
                        await loadRecipeFile(file.data);
                        results.push(`✅ Recipe: ${file.name}`);
                    }
                }
                
                // Report unknown files
                unknownFiles.forEach(file => {
                    results.push(`⚠️ Unknown: ${file.name}`);
                });
                
                // Show success message
                progressDiv.innerHTML = `
                    <div style="color: #059669; font-weight: 600;">🎉 Load Complete!</div>
                    <div style="margin-top: 4px;">
                        ${results.join('<br>')}
                    </div>
                `;
                
                // Update displays
                render();
                renderInventory();
                if (currentTab === 'database') {
                    renderDatabase();
                }
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 4000);
                
            } catch (error) {
                progressDiv.innerHTML = `❌ Error: ${error.message}`;
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        function loadDatabaseFile(data) {
            return new Promise((resolve, reject) => {
                try {
                    if (!data.database || !Array.isArray(data.database)) {
                        throw new Error('Invalid database format');
                    }

                    // Merge with existing database
                    data.database.forEach(importedEntry => {
                        const existing = ingredientDatabase.find(entry => 
                            entry.name.toLowerCase() === importedEntry.name.toLowerCase()
                        );
                        
                        if (existing) {
                            // Merge notes with separator
                            if (importedEntry.notes && importedEntry.notes.trim()) {
                                if (existing.notes && existing.notes.trim()) {
                                    existing.notes += '\n---\n' + importedEntry.notes;
                                } else {
                                    existing.notes = importedEntry.notes;
                                }
                            }
                            
                            // Merge substitutions
                            if (importedEntry.substitutions && Array.isArray(importedEntry.substitutions)) {
                                importedEntry.substitutions.forEach(sub => {
                                    if (!existing.substitutions.includes(sub)) {
                                        existing.substitutions.push(sub);
                                    }
                                });
                            }
                            
                            // Update other fields if they're better/newer
                            if (importedEntry.dilution && !existing.dilution) existing.dilution = importedEntry.dilution;
                            if (importedEntry.typicalUsage && !existing.typicalUsage) existing.typicalUsage = importedEntry.typicalUsage;
                            if (importedEntry.olfactoryFamily && !existing.olfactoryFamily) existing.olfactoryFamily = importedEntry.olfactoryFamily;
                        } else {
                            // Add new entry
                            ingredientDatabase.push({
                                id: Date.now() + Math.random(),
                                name: importedEntry.name || 'Unknown',
                                notes: importedEntry.notes || '',
                                substitutions: Array.isArray(importedEntry.substitutions) ? importedEntry.substitutions : [],
                                dilution: parseFloat(importedEntry.dilution) || 1.0,
                                typicalUsage: parseFloat(importedEntry.typicalUsage) || 0,
                                olfactoryFamily: importedEntry.olfactoryFamily || ''
                            });
                        }
                    });
                    
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function loadInventoryFile(data) {
            return new Promise((resolve, reject) => {
                try {
                    if (!data.inventory || !Array.isArray(data.inventory)) {
                        throw new Error('Invalid inventory format');
                    }

                    data.inventory.forEach(item => {
                        const existing = inventory.find(inv => 
                            inv.name.toLowerCase() === item.name.toLowerCase()
                        );
                        
                        if (existing) {
                            // Update existing inventory
                            existing.amount = parseFloat(item.amount) || 0;
                            existing.unit = item.unit || 'ml';
                            existing.dilution = parseFloat(item.dilution) || 1.0;
                        } else {
                            // Add new inventory item
                            inventory.push({
                                id: Date.now() + Math.random(),
                                name: item.name || 'Unknown',
                                amount: parseFloat(item.amount) || 0,
                                unit: item.unit || 'ml',
                                dilution: parseFloat(item.dilution) || 1.0
                            });
                        }
                        
                        // Update database entry with inventory information
                        const dbEntry = getOrCreateDatabaseEntry(item.name);
                        dbEntry.currentInventory = parseFloat(item.amount) || 0;
                        dbEntry.inventoryUnit = item.unit || 'ml';
                        dbEntry.lastUpdated = new Date().toISOString();
                    });
                    
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function loadRecipeFile(data) {
            return new Promise((resolve, reject) => {
                try {
                    if (!data.ingredients || !data.groups) {
                        throw new Error('Invalid recipe format');
                    }

                    // Clear existing data
                    ingredients = [];
                    groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };

                    // Import ingredients and merge notes into database
                    if (Array.isArray(data.ingredients)) {
                        ingredients = data.ingredients.map(ing => {
                            // Get or create database entry for this ingredient
                            const dbEntry = getOrCreateDatabaseEntry(ing.name || 'Unknown');
                            
                            // Merge notes from recipe into database
                            if (ing.notes && ing.notes.trim()) {
                                if (dbEntry.notes && dbEntry.notes.trim()) {
                                    dbEntry.notes += '\n---\n' + ing.notes;
                                } else {
                                    dbEntry.notes = ing.notes;
                                }
                            }
                            
                            return {
                                id: ing.id || Date.now() + Math.random(),
                                name: ing.name || 'Unknown',
                                dilution: parseFloat(ing.dilution) || 1.0,
                                volume: parseFloat(ing.volume) || 0,
                                group: ing.group || 'Unassigned',
                                notes: '', // Notes now come from database
                                substituted: ing.substituted || false,
                                // Preserve compound substitution metadata
                                isCompoundSubstitute: ing.isCompoundSubstitute || false,
                                originalIngredient: ing.originalIngredient || undefined,
                                compoundId: ing.compoundId || undefined,
                                compoundPercentage: ing.compoundPercentage || undefined
                            };
                        });
                    }

                    // Import groups
                    if (typeof data.groups === 'object') {
                        Object.entries(data.groups).forEach(([groupName, groupData]) => {
                            groups[groupName] = {
                                ingredients: Array.isArray(groupData.ingredients) ? groupData.ingredients : [],
                                expanded: groupData.expanded !== false,
                                color: groupData.color || 'bg-gray-100'
                            };
                        });
                    }

                    // Handle compound substitutions (for version 1.1+)
                    if (data.compoundSubstitutions && typeof data.compoundSubstitutions === 'object') {
                        console.log('Loaded compound substitutions:', Object.keys(data.compoundSubstitutions).length);
                    }
                    
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        let lastClickTime = 0;
        function onMolecularClick(event) {
            const now = Date.now();
            if (now - lastClickTime > 500) { // Throttle to once per 500ms
                console.log('🎯 Molecular click detected');
                lastClickTime = now;
            }
        }
        
        function onMolecularWheel(event) {
            event.preventDefault();
            const delta = event.deltaY > 0 ? 2 : -2;
            camera.position.z += delta;
            
            // Limit zoom to reasonable bounds
            if (camera.position.z < 5) {
                camera.position.z = 5;
            } else if (camera.position.z > 100) {
                camera.position.z = 100;
            }
            
            document.getElementById('cameraInfo').textContent = `${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)}`;
        }
        
        function onMolecularMouseDown(event) {
            isMouseDown = true;
            document.getElementById('molecularVisualization').style.cursor = 'grabbing';
        }
        
        function onMolecularMouseUp(event) {
            isMouseDown = false;
            document.getElementById('molecularVisualization').style.cursor = 'grab';
        }
        
        function onMolecularKeyDown(event) {
            if (!camera) return;
            
            // Only handle arrow keys and WASD when visualizer is active
            if (currentTab !== 'visualizer') return;
            
            const moveSpeed = 2;
            const rotateSpeed = 0.1;
            let moved = false;
            
            switch(event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    // Move camera up
                    camera.position.y += moveSpeed;
                    moved = true;
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    // Move camera down
                    camera.position.y -= moveSpeed;
                    moved = true;
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    // Pan camera left
                    camera.position.x -= moveSpeed;
                    moved = true;
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    // Pan camera right
                    camera.position.x += moveSpeed;
                    moved = true;
                    break;
                case 'q':
                case 'Q':
                    // Move camera closer (zoom in)
                    camera.position.z -= moveSpeed;
                    moved = true;
                    break;
                case 'e':
                case 'E':
                    // Move camera further (zoom out)
                    camera.position.z += moveSpeed;
                    moved = true;
                    break;
            }
            
            if (moved) {
                event.preventDefault();
                document.getElementById('cameraInfo').textContent = 
                    `${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)}`;
            }
        }
        
        function showMolecularTooltip(event, ingredient) {
            const tooltip = document.getElementById('visualizationTooltip');
            const inventoryStatus = getInventoryStatus(ingredient.name);
            
            // Calculate territory info for this ingredient
            const totalActives = getTotalActives();
            const actives = getActives(ingredient);
            const activeRatio = totalActives > 0 ? actives / totalActives : 0;
            const poweredActiveRatio = Math.pow(activeRatio, territoryPower);
            const territoryRadius = 6.0 - (poweredActiveRatio * 4.5); // Same calculation as in calculateTerritoryAllocations
            
            // Calculate sphere radius (same calculation as in renderVisualization)
            const totalPoweredActives = ingredients.reduce((sum, ing) => {
                const ingActives = getActives(ing);
                return sum + Math.pow(ingActives, spherePower);
            }, 0);
            const poweredActives = Math.pow(actives, spherePower);
            const poweredPercentage = totalPoweredActives > 0 ? (poweredActives / totalPoweredActives) * 100 : 0;
            // Dynamic radius range based on power - same calculation as in renderVisualization
            const baseMaxRadius = 2.0;
            const baseMinRadius = 0.3;
            const powerMultiplier = Math.pow(spherePower, 0.5);
            const maxRadius = baseMaxRadius * powerMultiplier;
            const minRadius = baseMinRadius / powerMultiplier;
            const sphereRadius = minRadius + (poweredPercentage / 100) * (maxRadius - minRadius);
            
            const tooltipHTML = `
                <div style="font-weight: 600; color: ${ingredientColors.get(ingredient.name)};">${ingredient.name}</div>
                <div style="margin: 4px 0; font-size: 11px;">
                    Volume: ${ingredient.volume.toFixed(1)}μL @ ${(ingredient.dilution * 100).toFixed(1)}%<br>
                    Actives: ${getActives(ingredient).toFixed(2)}μL (${getIngredientPercentage(ingredient)}%)<br>
                    Group: ${ingredient.group}<br>
                    Sphere: ${sphereRadius.toFixed(2)} radius (^${spherePower} scaling)<br>
                    Territory: ${territoryRadius.toFixed(1)} radius (^${territoryPower} scaling, ${poweredActiveRatio > 0.1 ? 'constrained' : 'roaming'})
                </div>
                <div style="color: ${inventoryStatus.available ? '#10b981' : '#ef4444'}; font-size: 11px;">
                    ${inventoryStatus.available ? 
                        `✓ In Stock: ${inventoryStatus.amount}${inventoryStatus.unit}` : 
                        '✗ Not in Inventory'
                    }
                </div>
            `;
            
            tooltip.innerHTML = tooltipHTML;
            
            // Smart positioning to keep tooltip on screen
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left = event.clientX + 10;
            let top = event.clientY - 10;
            
            // Check if tooltip would go off right edge
            if (left + 250 > viewportWidth) { // Assume max tooltip width of 250px
                left = event.clientX - 260;
            }
            
            // Check if tooltip would go off bottom edge
            if (top + 100 > viewportHeight) { // Assume max tooltip height of 100px
                top = event.clientY - 110;
            }
            
            // Check if tooltip would go off left edge
            if (left < 0) {
                left = 10;
            }
            
            // Check if tooltip would go off top edge
            if (top < 0) {
                top = 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.opacity = '1';
            tooltip.style.maxWidth = '250px';
            tooltip.style.wordWrap = 'break-word';
        }
        
        function hideMolecularTooltip() {
            document.getElementById('visualizationTooltip').style.opacity = '0';
        }
        
        function resetCameraView() {
            camera.position.set(0, 0, 25);
            camera.lookAt(0, 0, 0);
            cameraDistance = 25;
            document.getElementById('cameraInfo').textContent = '0.0, 0.0, 25.0';
        }
        
        function toggleMolecularMotion() {
            molecularMotion = !molecularMotion;
            const button = document.getElementById('motionToggle');
            if (molecularMotion) {
                button.innerHTML = '⏸️ Stop Motion';
                button.style.background = '#ef4444';
            } else {
                button.innerHTML = '⚡ Start Motion';
                button.style.background = '#6b7280';
            }
        }
        
        function exportVisualizationImage() {
            if (!renderer) return;
            
            const link = document.createElement('a');
            link.download = `fragrance-molecular-view-${new Date().toISOString().split('T')[0]}.png`;
            link.href = renderer.domElement.toDataURL();
            link.click();
        }
        
        function toggleFullscreen() {
            const container = document.getElementById('molecularVisualization').parentElement;
            const button = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().then(() => {
                    button.innerHTML = '🔲 Exit Fullscreen';
                    button.style.background = '#ef4444';
                    
                    // Resize renderer for fullscreen
                    setTimeout(() => {
                        if (renderer && camera) {
                            const width = window.innerWidth;
                            const height = window.innerHeight;
                            camera.aspect = width / height;
                            camera.updateProjectionMatrix();
                            renderer.setSize(width, height);
                        }
                    }, 100);
                }).catch(err => {
                    console.error('Failed to enter fullscreen:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    button.innerHTML = '🔳 Fullscreen';
                    button.style.background = '#8b5cf6';
                    
                    // Resize renderer back to normal
                    setTimeout(() => {
                        if (renderer && camera) {
                            const container = document.getElementById('molecularVisualization');
                            const width = container.clientWidth || 800;
                            const height = container.clientHeight || 500;
                            camera.aspect = width / height;
                            camera.updateProjectionMatrix();
                            renderer.setSize(width, height);
                        }
                    }, 100);
                });
            }
        }
        
        function showKeyboardControls() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            helpModal.innerHTML = `
                <div style="background: #1f2937; padding: 30px; border-radius: 12px; max-width: 500px; color: white; border: 1px solid #3b82f6;">
                    <h3 style="margin: 0 0 20px 0; color: #3b82f6; text-align: center;">🚀 Molecular Navigation Controls</h3>
                    <div style="background: #1e3a8a; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 12px; color: #bfdbfe;">💡 <strong>Note:</strong> All molecules are on a flat plane - bigger molecules = higher concentration! Pan and zoom to explore different areas.</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-bottom: 20px; font-size: 14px;">
                        <div style="color: #fbbf24; font-weight: 600;">Mouse Controls:</div>
                        <div></div>
                        
                        <div style="color: #d1d5db;">🖱️ Drag</div>
                        <div style="color: #9ca3af;">Rotate camera around molecules</div>
                        
                        <div style="color: #d1d5db;">🎯 Scroll</div>
                        <div style="color: #9ca3af;">Zoom in/out on molecular plane</div>
                        
                        <div style="color: #d1d5db;">🖱️ Hover</div>
                        <div style="color: #9ca3af;">Show molecule details</div>
                        
                        <div style="color: #fbbf24; font-weight: 600; margin-top: 15px;">Keyboard Controls:</div>
                        <div></div>
                        
                        <div style="color: #d1d5db;">↑ ↓ or W S</div>
                        <div style="color: #9ca3af;">Move camera up/down</div>
                        
                        <div style="color: #d1d5db;">← → or A D</div>
                        <div style="color: #9ca3af;">Pan camera left/right across plane</div>
                        
                        <div style="color: #d1d5db;">Q / E</div>
                        <div style="color: #9ca3af;">Zoom in / Zoom out on plane</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Got it! 🚀
                        </button>
                    </div>
                </div>
            `;
            
            helpModal.onclick = (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            };
            
            document.body.appendChild(helpModal);
        }

        // Initialize molecular visualization when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM loaded, waiting for page to be ready...');
            setTimeout(() => {
                console.log('⏰ Initializing molecular visualization...');
                if (!renderer) {
                    initializeMolecularVisualization();
                }
            }, 1500);
        });
        
        // Add window resize handler
        window.addEventListener('resize', () => {
            if (renderer && camera) {
                const container = document.getElementById('molecularVisualization');
                if (container) {
                    const width = container.clientWidth || 800;
                    const height = container.clientHeight || 500;
                    
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                    console.log('📐 Visualization resized to:', width, 'x', height);
                }
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragrance Composition Tracker</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" onerror="console.warn('Failed to load Lucide icons')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-layout {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 380px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            color: #6b7280;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 16px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .stats-bar {
            background: #dbeafe;
            padding: 16px 24px;
            border-bottom: 1px solid #bfdbfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .stats-left {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1e40af;
        }
        
        .stat-label {
            font-size: 12px;
            color: #1d4ed8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .groups-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }
        
        .container {
            max-width: none;
            margin: 0;
            padding: 0;
            background: transparent;
            min-height: auto;
        }
        
        .form-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }
        
        .form-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .form-flex {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            white-space: nowrap;
        }
        
        .btn-blue {
            background: #3b82f6;
            color: white;
        }
        .btn-blue:hover {
            background: #2563eb;
        }
        .btn-green {
            background: #10b981;
            color: white;
        }
        .btn-green:hover {
            background: #059669;
        }
        .btn-red {
            background: transparent;
            color: #ef4444;
            padding: 4px;
        }
        .btn-red:hover {
            color: #dc2626;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                width: 320px;
            }
        }
        
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            .stats-bar {
                padding: 12px 16px;
            }
            .stats-left {
                gap: 16px;
            }
            .groups-container {
                padding: 16px;
            }
        }

        .group {
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .group-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .group-header:hover {
            background: rgba(0,0,0,0.02);
        }
        .group-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .group-title {
            font-size: 18px;
            font-weight: 600;
        }
        .group-count {
            font-size: 14px;
            color: #6b7280;
        }
        .group-stats {
            text-align: right;
        }
        .group-actives {
            font-weight: bold;
        }
        .group-percentage {
            font-size: 14px;
            color: #6b7280;
        }
        .group-content {
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            min-height: 100px;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        .ingredient-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: move;
            transition: box-shadow 0.2s;
        }
        .ingredient-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .ingredient-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
        }
        .ingredient-info {
            flex: 1;
        }
        .ingredient-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .ingredient-details {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .ingredient-actives {
            font-size: 12px;
            font-weight: 500;
            color: #2563eb;
        }
        .ingredient-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }
        .icon {
            width: 16px;
            height: 16px;
        }
        .icon-sm {
            width: 14px;
            height: 14px;
        }
        .text-gray {
            color: #9ca3af;
        }
        /* Group color classes */
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-pink-50 { background-color: #fdf2f8; }
        .bg-indigo-50 { background-color: #eef2ff; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-orange-50 { background-color: #fff7ed; }
        
        /* Edit mode styles */
        .ingredient-edit {
            background: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        .edit-input {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
            margin-bottom: 4px;
            outline: none;
        }
        .edit-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .btn-save {
            background: #10b981;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        .btn-save:hover {
            background: #059669;
        }
        .btn-cancel {
            background: #6b7280;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        .btn-cancel:hover {
            background: #4b5563;
        }
        .btn-edit {
            background: transparent;
            color: #3b82f6;
            padding: 4px;
        }
        .btn-edit:hover {
            color: #2563eb;
        }
        
        /* Inventory Management Styles */
        .inventory-section {
            margin-bottom: 16px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            background: white;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #f9fafb;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .inventory-item.low-stock {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        
        .inventory-item.out-of-stock {
            border-color: #ef4444;
            background: #fee2e2;
            opacity: 0.7;
        }
        
        .inventory-name {
            font-weight: 500;
            flex: 1;
        }
        
        .inventory-amount {
            color: #6b7280;
            margin-left: 8px;
        }
        
        .coverage-indicator {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .coverage-full {
            background: #dcfce7;
            color: #166534;
        }
        
        .coverage-partial {
            background: #fef3c7;
            color: #92400e;
        }
        
        .coverage-none {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .add-inventory-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 8px;
            align-items: end;
        }
        
        .recipe-coverage {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .coverage-title {
            font-weight: 600;
            color: #0c4a6e;
        }
        
        .coverage-stats {
            font-size: 12px;
            color: #0369a1;
        }
        
        .missing-ingredients {
            font-size: 12px;
            color: #7c2d12;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .add-inventory-form {
                grid-template-columns: 1fr;
            }
            .inventory-grid {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="title">Fragrance Composer</h1>
                <p class="subtitle">Create and manage your fragrance formulations</p>
            </div>
            
            <div class="sidebar-content">
                <!-- Add Ingredient Form -->
                <div class="form-section">
                    <h2 class="form-title">
                        <i data-lucide="plus-circle" class="icon"></i>
                        Add Ingredient
                    </h2>
                    <div class="form-grid">
                        <input type="text" id="ingredientName" class="input" placeholder="Ingredient name">
                        <input type="number" id="ingredientDilution" class="input" step="0.001" placeholder="Dilution (0.1 = 10%)" value="1.0">
                        <input type="number" id="ingredientVolume" class="input" step="0.1" placeholder="Volume (μL)" value="0">
                        <button onclick="addIngredient()" class="btn btn-blue">
                            <i data-lucide="plus" class="icon"></i>
                            Add Ingredient
                        </button>
                    </div>
                </div>

                <!-- Add Group Form -->
                <div class="form-section">
                    <h2 class="form-title">
                        <i data-lucide="folder-plus" class="icon"></i>
                        Add Group/Accord
                    </h2>
                    <div class="form-grid">
                        <input type="text" id="groupName" class="input" placeholder="Group name (e.g., Citrus, Musks, Pineapple Accord)">
                        <button onclick="addGroup()" class="btn btn-green">
                            <i data-lucide="plus" class="icon"></i>
                            Add Group
                        </button>
                    </div>
                </div>

                <!-- Import/Export Section -->
                <div class="form-section">
                    <h2 class="form-title">
                        <i data-lucide="save" class="icon"></i>
                        Import/Export
                    </h2>
                    <div class="form-grid" style="margin-bottom: 12px;">
                        <button onclick="exportRecipe()" class="btn btn-blue">
                            <i data-lucide="download" class="icon"></i>
                            Export Recipe
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importRecipe(event)">
                        <button onclick="document.getElementById('importFile').click()" class="btn btn-green">
                            <i data-lucide="upload" class="icon"></i>
                            Import Recipe
                        </button>
                        <button onclick="clearAll()" class="btn btn-red" style="background: #ef4444; color: white;">
                            <i data-lucide="trash-2" class="icon"></i>
                            Clear All
                        </button>
                    </div>
                    <div>
                        <textarea id="jsonPreview" class="input" placeholder="JSON preview will appear here..." style="height: 80px; resize: vertical; font-family: monospace; font-size: 11px;" readonly></textarea>
                    </div>
                </div>
                
                <!-- Inventory Management Section -->
                <div class="form-section inventory-section">
                    <h2 class="form-title">
                        <i data-lucide="package" class="icon"></i>
                        Inventory Management
                    </h2>
                    
                    <div class="add-inventory-form" style="margin-bottom: 12px;">
                        <input type="text" id="inventoryName" class="input" placeholder="Ingredient name">
                        <input type="number" id="inventoryAmount" class="input" step="0.1" placeholder="Amount">
                        <select id="inventoryUnit" class="input">
                            <option value="ml">ml</option>
                            <option value="g">g</option>
                            <option value="μL">μL</option>
                        </select>
                        <button onclick="addToInventory()" class="btn btn-blue">
                            <i data-lucide="plus" class="icon"></i>
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <button onclick="importInventoryFromReceipts()" class="btn btn-green" style="flex: 1;">
                            <i data-lucide="file-text" class="icon"></i>
                            Load PA Receipts
                        </button>
                        <button onclick="exportInventory()" class="btn btn-blue" style="flex: 1;">
                            <i data-lucide="database" class="icon"></i>
                            Export
                        </button>
                    </div>
                    
                    <input type="file" id="inventoryImportFile" accept=".json" style="display: none;" onchange="importInventory(event)">
                    <button onclick="document.getElementById('inventoryImportFile').click()" class="btn btn-green" style="width: 100%; margin-bottom: 8px;">
                        <i data-lucide="upload" class="icon"></i>
                        Import Inventory
                    </button>
                    
                    <div class="inventory-grid" id="inventoryGrid">
                        <div style="text-align: center; color: #6b7280; padding: 20px;">
                            No ingredients in inventory
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stats-left">
                    <div class="stat-item">
                        <div class="stat-value" id="totalActives">0.00</div>
                        <div class="stat-label">Total Actives (μL)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalIngredients">0</div>
                        <div class="stat-label">Total Ingredients</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalGroups">1</div>
                        <div class="stat-label">Groups</div>
                    </div>
                </div>
            </div>

            <!-- Groups Container -->
            <div class="groups-container">
                <!-- Recipe Coverage Analysis -->
                <div class="recipe-coverage" id="recipeCoverage" style="display: none;">
                    <div class="coverage-header">
                        <div class="coverage-title">Recipe Coverage Analysis</div>
                        <div class="coverage-stats" id="coverageStats">0/0 ingredients available</div>
                    </div>
                    <div id="coverageDetails">No active recipe loaded</div>
                    <div class="missing-ingredients" id="missingIngredients"></div>
                </div>
                
                <div class="container">
                    <div id="groupsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let ingredients = [];
        let groups = {
            'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' }
        };
        let draggedItem = null;
        
        // Inventory Management
        let inventory = [];
        
        // Perfumer's Apprentice receipts data (from your receipts)
        const paReceiptsData = [
            // Receipt 1
            { name: "Aldehyde C-12 MNA", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Ambroxan", amount: 4, unit: "ml", dilution: 0.1 },
            { name: "Calone", amount: 4, unit: "ml", dilution: 0.1 },
            { name: "Damascone Beta", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Ethyl Maltol", amount: 8, unit: "g", dilution: 1.0 },
            { name: "Hedione", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Iso E Super", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Linalool", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Methyl Anthranilate", amount: 4, unit: "ml", dilution: 0.5 },
            { name: "Raspberry Ketone", amount: 4, unit: "ml", dilution: 0.1 },
            
            // Receipt 2
            { name: "Birch Tar Oil (Rectified)", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Coranol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Alpha Damascone", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Ethyl Methyl-2-Butyrate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Galaxolide", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Helvetolide", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "2-Isobutyl Quinoline", amount: 4, unit: "ml", dilution: 0.1 },
            { name: "Linalyl Acetate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Lyral", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Methyl Benzoate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Paradisamide", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Patchoulol Crystals", amount: 8, unit: "g", dilution: 1.0 },
            { name: "Pineapple Essence", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Valspice", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Evernyl (Veramoss)", amount: 8, unit: "g", dilution: 1.0 },
            
            // Receipt 3
            { name: "Aldehyde C-10", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Allyl Caproate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Ambrettolide", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Beta Pinene", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Dynascone", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Ethyl Caproate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Geosmin", amount: 4, unit: "ml", dilution: 0.01 },
            { name: "Manzanate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Muscone", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Pyralone", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Triethyl Citrate", amount: 250, unit: "g", dilution: 1.0 },
            { name: "Veloutone", amount: 4, unit: "ml", dilution: 1.0 },
            
            // Receipt 4
            { name: "Aldehyde C-6", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Anisic Aldehyde", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Anisyl Acetate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Anisyl Acetone", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Basil Sweet Oil", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Cashmeran", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Citral", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Citronellol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Dihydro Myrcenol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Fennel Sweet Oil", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Geraniol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Hexenol-3-Cis", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Kephalis", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Norlimbanol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Patchouli Absolute", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Phenyl Ethyl Alcohol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Polysantol", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Tarragon Oil", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Vetiveryl Acetate", amount: 4, unit: "ml", dilution: 1.0 },
            { name: "Wormwood Oil", amount: 4, unit: "ml", dilution: 1.0 },
            
            // Receipt 5 (larger quantities)
            { name: "Ambrettolide", amount: 4, unit: "ml", dilution: 1.0 }, // Givaudan version
            { name: "Ambroxan", amount: 50, unit: "g", dilution: 0.1 }, // Large size
            { name: "Hedione", amount: 15, unit: "ml", dilution: 1.0 }, // Large size  
            { name: "Helvetolide", amount: 15, unit: "ml", dilution: 1.0 } // Large size
        ];

        const groupColors = [
            'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50', 
            'bg-pink-50', 'bg-indigo-50', 'bg-red-50', 'bg-orange-50'
        ];

        // Utility functions
        function getActives(ingredient) {
            return ingredient.volume * ingredient.dilution;
        }

        function getTotalActives() {
            return ingredients.reduce((sum, ing) => sum + getActives(ing), 0);
        }

        function getGroupActives(groupName) {
            const groupIngredients = groups[groupName].ingredients.map(id => 
                ingredients.find(i => i.id === id)
            ).filter(Boolean);
            return groupIngredients.reduce((sum, ing) => sum + getActives(ing), 0);
        }

        function getGroupPercentage(groupName) {
            const total = getTotalActives();
            if (total === 0) return 0;
            return (getGroupActives(groupName) / total * 100).toFixed(1);
        }

        function getIngredientPercentage(ingredient) {
            const total = getTotalActives();
            if (total === 0) return 0;
            return (getActives(ingredient) / total * 100).toFixed(2);
        }

        // Import/Export functions
        function exportRecipe() {
            const recipeData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalActives: getTotalActives(),
                ingredients: ingredients,
                groups: groups
            };

            const jsonString = JSON.stringify(recipeData, null, 2);
            
            // Update preview
            document.getElementById('jsonPreview').value = jsonString;

            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-recipe-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importRecipe(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const recipeData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!recipeData.ingredients || !recipeData.groups) {
                        throw new Error('Invalid recipe format');
                    }

                    // Clear existing data
                    ingredients = [];
                    groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };

                    // Import ingredients
                    if (Array.isArray(recipeData.ingredients)) {
                        ingredients = recipeData.ingredients.map(ing => ({
                            id: ing.id || Date.now() + Math.random(),
                            name: ing.name || 'Unknown',
                            dilution: parseFloat(ing.dilution) || 1.0,
                            volume: parseFloat(ing.volume) || 0,
                            group: ing.group || 'Unassigned'
                        }));
                    }

                    // Import groups
                    if (typeof recipeData.groups === 'object') {
                        Object.entries(recipeData.groups).forEach(([groupName, groupData]) => {
                            groups[groupName] = {
                                ingredients: Array.isArray(groupData.ingredients) ? groupData.ingredients : [],
                                expanded: groupData.expanded !== false,
                                color: groupData.color || 'bg-gray-100'
                            };
                        });
                    }

                    // Update preview
                    document.getElementById('jsonPreview').value = JSON.stringify(recipeData, null, 2);

                    render();
                    alert('Recipe imported successfully!');
                } catch (error) {
                    alert('Error importing recipe: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all ingredients and groups? This cannot be undone.')) {
                ingredients = [];
                groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };
                document.getElementById('jsonPreview').value = '';
                render();
            }
        }

        function updateJsonPreview() {
            if (ingredients.length > 0 || Object.keys(groups).length > 1) {
                const recipeData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    totalActives: getTotalActives(),
                    ingredients: ingredients,
                    groups: groups
                };
                document.getElementById('jsonPreview').value = JSON.stringify(recipeData, null, 2);
            } else {
                document.getElementById('jsonPreview').value = '';
            }
        }

        // Inventory Management Functions
        function addToInventory() {
            const name = document.getElementById('inventoryName').value.trim();
            const amount = parseFloat(document.getElementById('inventoryAmount').value);
            const unit = document.getElementById('inventoryUnit').value;

            if (!name || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid ingredient name and amount');
                return;
            }

            // Check if ingredient already exists
            const existing = inventory.find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existing) {
                existing.amount += amount;
                existing.unit = unit; // Update unit if different
            } else {
                inventory.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    unit: unit,
                    dilution: 1.0 // Default to neat
                });
            }

            // Clear form
            document.getElementById('inventoryName').value = '';
            document.getElementById('inventoryAmount').value = '';
            
            renderInventory();
            updateRecipeCoverage();
        }

        function importInventoryFromReceipts() {
            // Merge PA receipts data with existing inventory
            paReceiptsData.forEach(receipt => {
                const existing = inventory.find(item => 
                    item.name.toLowerCase() === receipt.name.toLowerCase()
                );
                
                if (existing) {
                    // Add to existing amount (convert units if needed)
                    existing.amount += receipt.amount;
                    existing.dilution = receipt.dilution; // Update dilution
                } else {
                    inventory.push({
                        id: Date.now() + Math.random(),
                        name: receipt.name,
                        amount: receipt.amount,
                        unit: receipt.unit,
                        dilution: receipt.dilution
                    });
                }
            });

            renderInventory();
            updateRecipeCoverage();
            alert('Perfumer\'s Apprentice receipts loaded successfully!');
        }

        function exportInventory() {
            const inventoryData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalItems: inventory.length,
                inventory: inventory
            };

            const jsonString = JSON.stringify(inventoryData, null, 2);
            
            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-inventory-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importInventory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const inventoryData = JSON.parse(e.target.result);
                    
                    if (!inventoryData.inventory || !Array.isArray(inventoryData.inventory)) {
                        throw new Error('Invalid inventory format');
                    }

                    inventory = inventoryData.inventory.map(item => ({
                        id: item.id || Date.now() + Math.random(),
                        name: item.name || 'Unknown',
                        amount: parseFloat(item.amount) || 0,
                        unit: item.unit || 'ml',
                        dilution: parseFloat(item.dilution) || 1.0
                    }));

                    renderInventory();
                    updateRecipeCoverage();
                    alert('Inventory imported successfully!');
                } catch (error) {
                    alert('Error importing inventory: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function removeFromInventory(id) {
            inventory = inventory.filter(item => item.id !== id);
            renderInventory();
            updateRecipeCoverage();
        }

        function renderInventory() {
            const container = document.getElementById('inventoryGrid');
            
            if (inventory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No ingredients in inventory</div>';
                return;
            }

            container.innerHTML = '';
            
            inventory.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const itemDiv = document.createElement('div');
                
                // Determine stock level
                let stockClass = '';
                if (item.amount <= 0) stockClass = 'out-of-stock';
                else if (item.amount <= 1) stockClass = 'low-stock';
                
                itemDiv.className = `inventory-item ${stockClass}`;
                itemDiv.innerHTML = `
                    <div class="inventory-name">${item.name}</div>
                    <div class="inventory-amount">${item.amount}${item.unit}</div>
                    <button onclick="removeFromInventory(${item.id})" class="btn-red" style="padding: 2px;">
                        <i data-lucide="x" class="icon-sm"></i>
                    </button>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        function updateRecipeCoverage() {
            if (ingredients.length === 0) {
                document.getElementById('recipeCoverage').style.display = 'none';
                return;
            }

            document.getElementById('recipeCoverage').style.display = 'block';
            
            let availableCount = 0;
            let partialCount = 0;
            const missingIngredients = [];
            const partialIngredients = [];

            ingredients.forEach(ingredient => {
                const inventoryItem = findInventoryMatch(ingredient.name);
                
                if (inventoryItem) {
                    const requiredAmount = ingredient.volume; // μL
                    const availableAmount = convertToMicroliters(inventoryItem.amount, inventoryItem.unit);
                    
                    if (availableAmount >= requiredAmount) {
                        availableCount++;
                    } else if (availableAmount > 0) {
                        partialCount++;
                        partialIngredients.push({
                            name: ingredient.name,
                            required: requiredAmount,
                            available: availableAmount
                        });
                    } else {
                        missingIngredients.push(ingredient.name);
                    }
                } else {
                    missingIngredients.push(ingredient.name);
                }
            });

            // Update stats
            document.getElementById('coverageStats').textContent = 
                `${availableCount}/${ingredients.length} ingredients available (${partialCount} partial)`;

            // Update details
            const percentage = ((availableCount + partialCount * 0.5) / ingredients.length * 100).toFixed(1);
            document.getElementById('coverageDetails').innerHTML = `
                <div style="margin-bottom: 4px;">
                    <span class="coverage-indicator coverage-full">${availableCount} Full</span>
                    <span class="coverage-indicator coverage-partial">${partialCount} Partial</span>
                    <span class="coverage-indicator coverage-none">${missingIngredients.length} Missing</span>
                    <span style="margin-left: 8px; font-weight: 600;">${percentage}% Coverage</span>
                </div>
            `;

            // Update missing ingredients
            if (missingIngredients.length > 0) {
                document.getElementById('missingIngredients').innerHTML = 
                    `<strong>Missing:</strong> ${missingIngredients.join(', ')}`;
            } else {
                document.getElementById('missingIngredients').innerHTML = '';
            }
        }

        function findInventoryMatch(ingredientName) {
            return inventory.find(item => {
                const itemName = item.name.toLowerCase().replace(/[®™]/g, '');
                const searchName = ingredientName.toLowerCase().replace(/[®™]/g, '');
                
                // Exact match
                if (itemName === searchName) return true;
                
                // Partial matches for common variations
                if (itemName.includes(searchName) || searchName.includes(itemName)) return true;
                
                // Handle common name variations
                const variations = {
                    'iso e super': ['iso e super', 'isoesuper'],
                    'hedione': ['hedione hc', 'hedione'],
                    'ambroxan': ['ambroxan'],
                    'helvetolide': ['helvetolide'],
                    'lyral': ['leerall', 'lyral'],
                    'evernyl': ['veramoss', 'evernyl'],
                    'birch tar oil': ['birch tar', 'birch tar rectified']
                };
                
                for (const [key, variants] of Object.entries(variations)) {
                    if (variants.some(v => searchName.includes(v) || itemName.includes(v))) {
                        return true;
                    }
                }
                
                return false;
            });
        }

        function convertToMicroliters(amount, unit) {
            switch (unit.toLowerCase()) {
                case 'ml': return amount * 1000;
                case 'g': return amount * 1000; // Approximate for most aromachemicals
                case 'μl': return amount;
                default: return amount * 1000; // Default to ml conversion
            }
        }

        // Main functions
        function addIngredient() {
            const name = document.getElementById('ingredientName').value.trim();
            const dilution = parseFloat(document.getElementById('ingredientDilution').value);
            const volume = parseFloat(document.getElementById('ingredientVolume').value);

            if (!name) return;

            const ingredient = {
                id: Date.now(),
                name: name,
                dilution: dilution,
                volume: volume,
                group: 'Unassigned'
            };

            ingredients.push(ingredient);
            groups['Unassigned'].ingredients.push(ingredient.id);

            // Clear form
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientDilution').value = '1.0';
            document.getElementById('ingredientVolume').value = '0';

            render();
        }

        function addGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name || groups[name]) return;

            const colorIndex = Object.keys(groups).length % groupColors.length;
            groups[name] = {
                ingredients: [],
                expanded: true,
                color: groupColors[colorIndex]
            };

            document.getElementById('groupName').value = '';
            render();
        }

        function deleteIngredient(id) {
            const ingredient = ingredients.find(i => i.id === id);
            if (ingredient) {
                groups[ingredient.group].ingredients = groups[ingredient.group].ingredients.filter(i => i !== id);
            }
            ingredients = ingredients.filter(i => i.id !== id);
            render();
        }

        function moveIngredient(ingredientId, targetGroup) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient || ingredient.group === targetGroup) return;

            // Remove from old group
            groups[ingredient.group].ingredients = groups[ingredient.group].ingredients.filter(i => i !== ingredientId);
            
            // Add to new group
            groups[targetGroup].ingredients.push(ingredientId);
            
            // Update ingredient group
            ingredient.group = targetGroup;
            
            render();
        }

        function toggleGroup(groupName) {
            groups[groupName].expanded = !groups[groupName].expanded;
            render();
        }

        // Edit functionality
        let editingIngredient = null;
        let originalIngredientData = null;

        function startEditIngredient(ingredientId) {
            // If already editing another ingredient, cancel that first
            if (editingIngredient && editingIngredient !== ingredientId) {
                cancelEditIngredient();
            }

            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            editingIngredient = ingredientId;
            originalIngredientData = { ...ingredient }; // Store original data for cancel
            render();
        }

        function saveEditIngredient(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            // Get values from edit inputs
            const nameInput = document.querySelector(`#edit-name-${ingredientId}`);
            const dilutionInput = document.querySelector(`#edit-dilution-${ingredientId}`);
            const volumeInput = document.querySelector(`#edit-volume-${ingredientId}`);

            if (!nameInput || !dilutionInput || !volumeInput) return;

            const newName = nameInput.value.trim();
            const newDilution = parseFloat(dilutionInput.value);
            const newVolume = parseFloat(volumeInput.value);

            // Validate inputs
            if (!newName) {
                alert('Ingredient name cannot be empty');
                return;
            }
            if (isNaN(newDilution) || newDilution <= 0 || newDilution > 1) {
                alert('Dilution must be between 0 and 1 (e.g., 0.1 for 10%)');
                return;
            }
            if (isNaN(newVolume) || newVolume < 0) {
                alert('Volume must be a positive number');
                return;
            }

            // Update ingredient
            ingredient.name = newName;
            ingredient.dilution = newDilution;
            ingredient.volume = newVolume;

            // Clear edit state
            editingIngredient = null;
            originalIngredientData = null;

            render();
        }

        function cancelEditIngredient() {
            if (editingIngredient && originalIngredientData) {
                // Restore original data
                const ingredient = ingredients.find(i => i.id === editingIngredient);
                if (ingredient) {
                    ingredient.name = originalIngredientData.name;
                    ingredient.dilution = originalIngredientData.dilution;
                    ingredient.volume = originalIngredientData.volume;
                }
            }

            editingIngredient = null;
            originalIngredientData = null;
            render();
        }

        function render() {
            // Update stats
            document.getElementById('totalActives').textContent = getTotalActives().toFixed(2);
            document.getElementById('totalIngredients').textContent = ingredients.length;
            document.getElementById('totalGroups').textContent = Object.keys(groups).length;

            // Render groups
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';

            Object.entries(groups).forEach(([groupName, groupData]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = `group ${groupData.color}`;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'group-header';
                headerDiv.onclick = () => toggleGroup(groupName);

                headerDiv.innerHTML = `
                    <div class="group-header-left">
                        <i data-lucide="${groupData.expanded ? 'chevron-down' : 'chevron-right'}" class="icon"></i>
                        <h3 class="group-title">${groupName}</h3>
                        <span class="group-count">(${groupData.ingredients.length} ingredients)</span>
                    </div>
                    <div class="group-stats">
                        <div class="group-actives">${getGroupActives(groupName).toFixed(2)} μL actives</div>
                        <div class="group-percentage">${getGroupPercentage(groupName)}% of total</div>
                    </div>
                `;

                groupDiv.appendChild(headerDiv);

                if (groupData.expanded) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'group-content';
                    
                    // Add drag and drop handlers
                    contentDiv.ondragover = (e) => e.preventDefault();
                    contentDiv.ondrop = (e) => {
                        e.preventDefault();
                        if (draggedItem) {
                            moveIngredient(draggedItem, groupName);
                            draggedItem = null;
                        }
                    };

                    if (groupData.ingredients.length === 0) {
                        contentDiv.innerHTML = '<div class="drop-zone">Drop ingredients here or drag from other groups</div>';
                    } else {
                        const gridDiv = document.createElement('div');
                        gridDiv.className = 'ingredients-grid';

                        groupData.ingredients.forEach(ingredientId => {
                            const ingredient = ingredients.find(i => i.id === ingredientId);
                            if (!ingredient) return;

                            const cardDiv = document.createElement('div');
                            const isEditing = editingIngredient === ingredient.id;
                            cardDiv.className = `ingredient-card ${isEditing ? 'ingredient-edit' : ''}`;
                            cardDiv.draggable = !isEditing;
                            if (!isEditing) {
                                cardDiv.ondragstart = () => draggedItem = ingredient.id;
                            }

                            if (isEditing) {
                                cardDiv.innerHTML = `
                                    <div class="ingredient-header">
                                        <div class="ingredient-info">
                                            <input type="text" id="edit-name-${ingredient.id}" class="edit-input" value="${ingredient.name}" placeholder="Ingredient name">
                                            <div style="display: flex; gap: 4px;">
                                                <input type="number" id="edit-volume-${ingredient.id}" class="edit-input" value="${ingredient.volume}" step="0.1" placeholder="Volume (μL)" style="flex: 1;">
                                                <input type="number" id="edit-dilution-${ingredient.id}" class="edit-input" value="${ingredient.dilution}" step="0.001" min="0" max="1" placeholder="Dilution" style="flex: 1;">
                                            </div>
                                            <p class="ingredient-actives" style="margin-top: 4px;">Preview: ${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                        </div>
                                    </div>
                                    <div class="edit-actions">
                                        <button onclick="saveEditIngredient(${ingredient.id})" class="btn btn-save">
                                            <i data-lucide="check" class="icon-sm"></i> Save
                                        </button>
                                        <button onclick="cancelEditIngredient()" class="btn btn-cancel">
                                            <i data-lucide="x" class="icon-sm"></i> Cancel
                                        </button>
                                    </div>
                                `;
                            } else {
                                cardDiv.innerHTML = `
                                    <div class="ingredient-header">
                                        <div class="ingredient-info">
                                            <h4 class="ingredient-name">${ingredient.name}</h4>
                                            <p class="ingredient-details">${ingredient.volume}μL @ ${(ingredient.dilution * 100).toFixed(1)}%</p>
                                            <p class="ingredient-actives">${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                        </div>
                                        <div class="ingredient-actions">
                                            <i data-lucide="move" class="icon-sm text-gray"></i>
                                            <button onclick="startEditIngredient(${ingredient.id})" class="btn-edit">
                                                <i data-lucide="edit" class="icon-sm"></i>
                                            </button>
                                            <button onclick="deleteIngredient(${ingredient.id})" class="btn-red">
                                                <i data-lucide="trash-2" class="icon-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }

                            gridDiv.appendChild(cardDiv);
                        });

                        contentDiv.appendChild(gridDiv);
                    }

                    groupDiv.appendChild(contentDiv);
                }

                container.appendChild(groupDiv);
            });

            // Initialize Lucide icons with error handling
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Lucide icons failed to load:', error);
                // Fallback: replace icons with text
                document.querySelectorAll('[data-lucide]').forEach(el => {
                    const iconName = el.getAttribute('data-lucide');
                    if (iconName === 'chevron-down') el.innerHTML = '▼';
                    else if (iconName === 'chevron-right') el.innerHTML = '▶';
                    else if (iconName === 'plus') el.innerHTML = '+';
                    else if (iconName === 'download') el.innerHTML = '↓';
                    else if (iconName === 'upload') el.innerHTML = '↑';
                    else if (iconName === 'trash-2') el.innerHTML = '×';
                    else if (iconName === 'move') el.innerHTML = '⌖';
                    else if (iconName === 'edit') el.innerHTML = '✎';
                    else if (iconName === 'check') el.innerHTML = '✓';
                    else if (iconName === 'x') el.innerHTML = '×';
                    else if (iconName === 'plus-circle') el.innerHTML = '⊕';
                    else if (iconName === 'folder-plus') el.innerHTML = '📁+';
                    else if (iconName === 'save') el.innerHTML = '💾';
                    else if (iconName === 'package') el.innerHTML = '📦';
                    else if (iconName === 'file-text') el.innerHTML = '📄';
                    else if (iconName === 'database') el.innerHTML = '🗄️';
                    else el.innerHTML = iconName;
                });
            }
            
            // Update JSON preview and inventory coverage
            updateJsonPreview();
            updateRecipeCoverage();
        }

        // Handle Enter key in form inputs
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ingredientName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addIngredient();
            });
            
            document.getElementById('groupName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addGroup();
            });

            // Global keyboard shortcuts for edit mode
            document.addEventListener('keydown', (e) => {
                if (editingIngredient) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveEditIngredient(editingIngredient);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEditIngredient();
                    }
                }
            });

            // Initial render
            render();
            renderInventory();
        });
    </script>
</body>
</html>
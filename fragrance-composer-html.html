<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragrance Composition Tracker</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" onerror="console.warn('Failed to load Lucide icons')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-layout {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 380px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            color: #6b7280;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 16px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .stats-bar {
            background: #dbeafe;
            padding: 16px 24px;
            border-bottom: 1px solid #bfdbfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .stats-left {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1e40af;
        }
        
        .stat-label {
            font-size: 12px;
            color: #1d4ed8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .groups-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }
        
        .container {
            max-width: none;
            margin: 0;
            padding: 0;
            background: transparent;
            min-height: auto;
        }
        
        .form-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }
        
        .form-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .form-flex {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            white-space: nowrap;
        }
        
        .btn-blue {
            background: #3b82f6;
            color: white;
        }
        .btn-blue:hover {
            background: #2563eb;
        }
        .btn-green {
            background: #10b981;
            color: white;
        }
        .btn-green:hover {
            background: #059669;
        }
        .btn-red {
            background: transparent;
            color: #ef4444;
            padding: 4px;
        }
        .btn-red:hover {
            color: #dc2626;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                width: 320px;
            }
        }
        
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            .stats-bar {
                padding: 12px 16px;
            }
            .stats-left {
                gap: 16px;
            }
            .groups-container {
                padding: 16px;
            }
        }

        .group {
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .group-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .group-header:hover {
            background: rgba(0,0,0,0.02);
        }
        .group-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .group-title {
            font-size: 18px;
            font-weight: 600;
        }
        .group-count {
            font-size: 14px;
            color: #6b7280;
        }
        .group-stats {
            text-align: right;
        }
        .group-actives {
            font-weight: bold;
        }
        .group-percentage {
            font-size: 14px;
            color: #6b7280;
        }
        .group-content {
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            min-height: 100px;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        .ingredient-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: move;
            transition: box-shadow 0.2s;
        }
        .ingredient-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .ingredient-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
        }
        .ingredient-info {
            flex: 1;
        }
        .ingredient-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .ingredient-details {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .ingredient-actives {
            font-size: 12px;
            font-weight: 500;
            color: #2563eb;
        }
        .ingredient-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }
        .icon {
            width: 16px;
            height: 16px;
        }
        .icon-sm {
            width: 14px;
            height: 14px;
        }
        .text-gray {
            color: #9ca3af;
        }
        /* Group color classes */
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-pink-50 { background-color: #fdf2f8; }
        .bg-indigo-50 { background-color: #eef2ff; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-orange-50 { background-color: #fff7ed; }
        
        /* Edit mode styles */
        .ingredient-edit {
            background: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        .edit-input {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
            margin-bottom: 4px;
            outline: none;
        }
        .edit-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .btn-save {
            background: #10b981;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        .btn-save:hover {
            background: #059669;
        }
        .btn-cancel {
            background: #6b7280;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        .btn-cancel:hover {
            background: #4b5563;
        }
        .btn-edit {
            background: transparent;
            color: #3b82f6;
            padding: 4px;
        }
        .btn-edit:hover {
            color: #2563eb;
        }
        
        /* Inventory Management Styles */
        .inventory-section {
            margin-bottom: 16px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            background: white;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #f9fafb;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .inventory-item.low-stock {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        
        .inventory-item.out-of-stock {
            border-color: #ef4444;
            background: #fee2e2;
            opacity: 0.7;
        }
        
        .inventory-name {
            font-weight: 500;
            flex: 1;
        }
        
        .inventory-amount {
            color: #6b7280;
            margin-left: 8px;
        }
        
        .coverage-indicator {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .coverage-full {
            background: #dcfce7;
            color: #166534;
        }
        
        .coverage-partial {
            background: #fef3c7;
            color: #92400e;
        }
        
        .coverage-none {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .add-inventory-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 8px;
            align-items: end;
        }
        
        .recipe-coverage {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .coverage-title {
            font-weight: 600;
            color: #0c4a6e;
        }
        
        .coverage-stats {
            font-size: 12px;
            color: #0369a1;
        }
        
        .missing-ingredients {
            font-size: 12px;
            color: #7c2d12;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .add-inventory-form {
                grid-template-columns: 1fr;
            }
            .inventory-grid {
                max-height: 150px;
            }
        }
        
        /* Notes and Substitution Styles */
        .ingredient-notes {
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
            margin-top: 4px;
            padding: 4px;
            background: #f9fafb;
            border-radius: 3px;
            border-left: 3px solid #d1d5db;
        }
        
        .ingredient-substituted {
            border-left: 3px solid #f59e0b !important;
            background: #fefbf3 !important;
        }
        
        .substitution-info {
            font-size: 11px;
            color: #d97706;
            font-weight: 500;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .notes-textarea {
            width: 100%;
            min-height: 60px;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            resize: vertical;
            font-family: inherit;
        }
        
        .substitution-controls {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        .substitution-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 4px;
            margin-top: 4px;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 120px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .suggestion-item {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background: #f3f4f6;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-source {
            font-size: 10px;
            color: #9ca3af;
        }
        
        .btn-substitute {
            background: #f59e0b;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .btn-substitute:hover {
            background: #d97706;
        }
        
        .btn-clear-sub {
            background: #6b7280;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
        }
        
        .btn-clear-sub:hover {
            background: #4b5563;
        }
        
        .expand-toggle {
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 10px;
            cursor: pointer;
            padding: 2px 4px;
            margin-left: 4px;
        }
        
        .expand-toggle:hover {
            color: #374151;
        }
        
        /* Database Tab Styles */
        .database-table {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .db-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .db-table th {
            background: #f9fafb;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        
        .db-table th:hover {
            background: #f3f4f6;
        }
        
        .db-table td {
            padding: 6px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }
        
        .db-table tr:hover {
            background: #f9fafb;
        }
        
        .db-table .notes-cell {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .db-table .subs-cell {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .db-edit-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 11px;
            background: #fefce8;
        }
        
        .db-edit-textarea {
            width: 100%;
            min-height: 40px;
            padding: 2px 4px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 11px;
            resize: vertical;
            background: #fefce8;
        }
        
        .db-actions {
            display: flex;
            gap: 2px;
        }
        
        .db-btn {
            background: transparent;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .db-btn:hover {
            background: #f3f4f6;
        }
        
        .sort-indicator {
            margin-left: 4px;
            color: #9ca3af;
        }
        
        .tab-active {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        .tab-inactive {
            background: #6b7280 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="title">Fragrance Composer</h1>
                <p class="subtitle">Create and manage your fragrance formulations</p>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button onclick="switchTab('composer')" id="composerTab" class="btn" style="flex: 1; font-size: 12px;">
                        <i data-lucide="beaker" class="icon"></i>
                        Composer
                    </button>
                    <button onclick="switchTab('database')" id="databaseTab" class="btn" style="flex: 1; font-size: 12px; background: #6b7280; color: white;">
                        <i data-lucide="database" class="icon"></i>
                        Database
                    </button>
                </div>
            </div>
            
            <div class="sidebar-content">
                <!-- Composer Tab Content -->
                <div id="composerContent">
                    <!-- Add Ingredient Form -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="plus-circle" class="icon"></i>
                            Add Ingredient
                        </h2>
                        <div class="form-grid">
                            <input type="text" id="ingredientName" class="input" placeholder="Ingredient name" onchange="onIngredientNameChange()">
                            <input type="number" id="ingredientDilution" class="input" step="0.001" placeholder="Dilution (0.1 = 10%)" value="1.0">
                            <input type="number" id="ingredientVolume" class="input" step="0.1" placeholder="Volume (μL)" value="0">
                            <button onclick="addIngredient()" class="btn btn-blue">
                                <i data-lucide="plus" class="icon"></i>
                                Add Ingredient
                            </button>
                        </div>
                    </div>

                    <!-- Add Group Form -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="folder-plus" class="icon"></i>
                            Add Group/Accord
                        </h2>
                        <div class="form-grid">
                            <input type="text" id="groupName" class="input" placeholder="Group name (e.g., Citrus, Musks, Pineapple Accord)">
                            <button onclick="addGroup()" class="btn btn-green">
                                <i data-lucide="plus" class="icon"></i>
                                Add Group
                            </button>
                        </div>
                    </div>

                    <!-- Import/Export Section -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="save" class="icon"></i>
                            Import/Export
                        </h2>
                        <div class="form-grid" style="margin-bottom: 12px;">
                            <button onclick="exportRecipe()" class="btn btn-blue">
                                <i data-lucide="download" class="icon"></i>
                                Export Recipe
                            </button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importRecipe(event)">
                            <button onclick="document.getElementById('importFile').click()" class="btn btn-green">
                                <i data-lucide="upload" class="icon"></i>
                                Import Recipe
                            </button>
                            <button onclick="clearAll()" class="btn btn-red" style="background: #ef4444; color: white;">
                                <i data-lucide="trash-2" class="icon"></i>
                                Clear All
                            </button>
                        </div>
                        <div>
                            <textarea id="jsonPreview" class="input" placeholder="JSON preview will appear here..." style="height: 80px; resize: vertical; font-family: monospace; font-size: 11px;" readonly></textarea>
                        </div>
                    </div>
                    
                    <!-- Inventory Management Section -->
                    <div class="form-section inventory-section">
                        <h2 class="form-title">
                            <i data-lucide="package" class="icon"></i>
                            Inventory Management
                        </h2>
                        
                        <div class="add-inventory-form" style="margin-bottom: 12px;">
                            <input type="text" id="inventoryName" class="input" placeholder="Ingredient name">
                            <input type="number" id="inventoryAmount" class="input" step="0.1" placeholder="Amount">
                            <select id="inventoryUnit" class="input">
                                <option value="ml">ml</option>
                                <option value="g">g</option>
                                <option value="μL">μL</option>
                            </select>
                            <button onclick="addToInventory()" class="btn btn-blue">
                                <i data-lucide="plus" class="icon"></i>
                            </button>
                        </div>
                        
                        <button onclick="exportInventory()" class="btn btn-blue" style="width: 100%; margin-bottom: 8px;">
                            <i data-lucide="database" class="icon"></i>
                            Export Inventory
                        </button>
                        
                        <input type="file" id="inventoryImportFile" accept=".json" style="display: none;" onchange="importInventory(event)">
                        <button onclick="document.getElementById('inventoryImportFile').click()" class="btn btn-green" style="width: 100%; margin-bottom: 8px;">
                            <i data-lucide="upload" class="icon"></i>
                            Import Inventory
                        </button>
                        
                        <div class="inventory-grid" id="inventoryGrid">
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                No ingredients in inventory
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Tab Content -->
                <div id="databaseContent" style="display: none;">
                    <!-- Database Search -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="search" class="icon"></i>
                            Search Database
                        </h2>
                        <input type="text" id="databaseSearch" class="input" placeholder="Search ingredients..." onkeyup="filterDatabase()">
                    </div>
                    
                    <!-- Database Export/Import -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="database" class="icon"></i>
                            Database Management
                        </h2>
                        <div class="form-grid">
                            <button onclick="exportDatabase()" class="btn btn-blue">
                                <i data-lucide="download" class="icon"></i>
                                Export Database
                            </button>
                            <input type="file" id="databaseImportFile" accept=".json" style="display: none;" onchange="importDatabase(event)">
                            <button onclick="document.getElementById('databaseImportFile').click()" class="btn btn-green">
                                <i data-lucide="upload" class="icon"></i>
                                Import Database
                            </button>
                        </div>
                    </div>
                    
                    <!-- Database Table -->
                    <div class="form-section">
                        <h2 class="form-title">
                            <i data-lucide="list" class="icon"></i>
                            Ingredient Database
                        </h2>
                        <div id="databaseTable" class="database-table">
                            <!-- Table will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stats-left">
                    <div class="stat-item">
                        <div class="stat-value" id="totalActives">0.00</div>
                        <div class="stat-label">Total Actives (μL)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalIngredients">0</div>
                        <div class="stat-label">Total Ingredients</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalGroups">1</div>
                        <div class="stat-label">Groups</div>
                    </div>
                </div>
            </div>

            <!-- Groups Container -->
            <div class="groups-container">
                <!-- Recipe Coverage Analysis -->
                <div class="recipe-coverage" id="recipeCoverage" style="display: none;">
                    <div class="coverage-header">
                        <div class="coverage-title">Recipe Coverage Analysis</div>
                        <div class="coverage-stats" id="coverageStats">0/0 ingredients available</div>
                    </div>
                    <div id="coverageDetails">No active recipe loaded</div>
                    <div class="missing-ingredients" id="missingIngredients"></div>
                </div>
                
                <div class="container">
                    <div id="groupsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let ingredients = [];
        let groups = {
            'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' }
        };
        let draggedItem = null;
        
        // Inventory Management
        let inventory = [];
        
        // Ingredient Database
        let ingredientDatabase = [];
        let currentTab = 'composer'; // 'composer' or 'database'
        
        // Notes and Substitutions
        let expandedIngredients = new Set(); // Track which ingredient cards are expanded
        
        // Common aromachemical substitutions database
        const substitutionDatabase = {
            // Citrus substitutions
            "bergamot oil": ["lemon oil", "sweet orange oil", "citral", "limonene"],
            "sweet orange oil": ["bergamot oil", "mandarin oil", "citral", "valencene"],
            "lemon oil": ["bergamot oil", "citral", "limonene"],
            
            // Woody substitutions  
            "iso e super": ["timbersilk", "kephalis", "cashmeran"],
            "cashmeran": ["iso e super", "kephalis", "polysantol"],
            "kephalis": ["iso e super", "cashmeran", "timbersilk"],
            
            // Musk substitutions
            "helvetolide": ["galaxolide", "ambrettolide", "muscone"],
            "galaxolide": ["helvetolide", "ambrettolide", "exaltolide"],
            "ambrettolide": ["helvetolide", "galaxolide", "muscone"],
            "muscone": ["ambrettolide", "helvetolide", "civetone"],
            
            // Floral substitutions
            "hedione": ["methyl anthranilate", "linalool", "phenyl ethyl alcohol"],
            "lyral": ["lily aldehyde", "hydroxycitronellal", "linalool"],
            "linalool": ["linalyl acetate", "hedione", "phenyl ethyl alcohol"],
            "linalyl acetate": ["linalool", "lavender oil", "bergamyl acetate"],
            
            // Aldehyde substitutions
            "aldehyde c-12 mna": ["aldehyde c-10", "aldehyde c-11", "aldehyde c-12"],
            "aldehyde c-10": ["aldehyde c-12 mna", "aldehyde c-11", "decanal"],
            "aldehyde c-6": ["hexanal", "aldehyde c-8", "aldehyde c-10"],
            
            // Amber substitutions
            "ambroxan": ["ambrocenide", "ambergris tincture", "labdanol"],
            
            // Animalic substitutions
            "2-isobutyl quinoline": ["civet absolute", "castoreum", "indole"],
            "birch tar oil": ["cade oil", "guaiacol", "phenolic compounds"],
            
            // Green substitutions
            "galbanum oil": ["violet leaf absolute", "green leaves accord", "hexenol-3-cis"],
            "petitgrain bigarade oil": ["clary sage oil", "petitgrain paraguay", "neroli oil"],
            
            // Fruity substitutions
            "beta pinene": ["alpha pinene", "limonene", "fruit terpenes"],
            "manzanate": ["apple ester", "ethyl butyrate", "fruit accord"],
            "veloutone": ["gamma undecalactone", "peach aldehyde", "fruity lactones"],
            "ethyl caproate": ["ethyl butyrate", "pineapple ester", "fruit esters"],
            
            // Spice substitutions
            "pink pepper oil": ["black pepper oil", "coriander oil", "cardamom oil"],
            "coranol": ["coriander oil", "metallic aldehydes", "green aldehydes"],
            
            // Patchouli substitutions
            "patchouli oil": ["patchoulol", "dark patchouli oil", "patchouli fraction"],
            "patchoulol crystals": ["patchouli oil", "synthetic patchoulol"],
            
            // Synthetic backbone
            "evernyl": ["oakmoss absolute", "treemoss", "mousse de chene"],
            "octyl salicylate": ["homosalate", "sunscreen molecules", "salicylates"]
        };

        const groupColors = [
            'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50', 
            'bg-pink-50', 'bg-indigo-50', 'bg-red-50', 'bg-orange-50'
        ];

        // Utility functions
        function getActives(ingredient) {
            return ingredient.volume * ingredient.dilution;
        }

        function getTotalActives() {
            return ingredients.reduce((sum, ing) => sum + getActives(ing), 0);
        }

        function getGroupActives(groupName) {
            const groupIngredients = groups[groupName].ingredients.map(id => 
                ingredients.find(i => i.id === id)
            ).filter(Boolean);
            return groupIngredients.reduce((sum, ing) => sum + getActives(ing), 0);
        }

        function getGroupPercentage(groupName) {
            const total = getTotalActives();
            if (total === 0) return 0;
            return (getGroupActives(groupName) / total * 100).toFixed(1);
        }

        function getIngredientPercentage(ingredient) {
            const total = getTotalActives();
            if (total === 0) return 0;
            return (getActives(ingredient) / total * 100).toFixed(2);
        }

        // Import/Export functions
        function exportRecipe() {
            const recipeData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalActives: getTotalActives(),
                ingredients: ingredients,
                groups: groups
            };

            const jsonString = JSON.stringify(recipeData, null, 2);
            
            // Update preview
            document.getElementById('jsonPreview').value = jsonString;

            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-recipe-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importRecipe(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const recipeData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!recipeData.ingredients || !recipeData.groups) {
                        throw new Error('Invalid recipe format');
                    }

                    // Clear existing data
                    ingredients = [];
                    groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };

                    // Import ingredients and merge notes into database
                    if (Array.isArray(recipeData.ingredients)) {
                        ingredients = recipeData.ingredients.map(ing => {
                            // Get or create database entry for this ingredient
                            const dbEntry = getOrCreateDatabaseEntry(ing.name || 'Unknown');
                            
                            // Merge notes from recipe into database
                            if (ing.notes && ing.notes.trim()) {
                                if (dbEntry.notes && dbEntry.notes.trim()) {
                                    dbEntry.notes += '\n---\n' + ing.notes;
                                } else {
                                    dbEntry.notes = ing.notes;
                                }
                            }
                            
                            return {
                                id: ing.id || Date.now() + Math.random(),
                                name: ing.name || 'Unknown',
                                dilution: parseFloat(ing.dilution) || 1.0,
                                volume: parseFloat(ing.volume) || 0,
                                group: ing.group || 'Unassigned',
                                notes: '', // Notes now come from database
                                substituted: false
                            };
                        });
                    }

                    // Import groups
                    if (typeof recipeData.groups === 'object') {
                        Object.entries(recipeData.groups).forEach(([groupName, groupData]) => {
                            groups[groupName] = {
                                ingredients: Array.isArray(groupData.ingredients) ? groupData.ingredients : [],
                                expanded: groupData.expanded !== false,
                                color: groupData.color || 'bg-gray-100'
                            };
                        });
                    }

                    // Update preview
                    document.getElementById('jsonPreview').value = JSON.stringify(recipeData, null, 2);

                    render();
                    alert('Recipe imported successfully! Notes have been merged into your ingredient database.');
                } catch (error) {
                    alert('Error importing recipe: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all ingredients and groups? This cannot be undone.')) {
                ingredients = [];
                groups = { 'Unassigned': { ingredients: [], expanded: true, color: 'bg-gray-100' } };
                document.getElementById('jsonPreview').value = '';
                render();
            }
        }

        function updateJsonPreview() {
            if (ingredients.length > 0 || Object.keys(groups).length > 1) {
                const recipeData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    totalActives: getTotalActives(),
                    ingredients: ingredients,
                    groups: groups
                };
                document.getElementById('jsonPreview').value = JSON.stringify(recipeData, null, 2);
            } else {
                document.getElementById('jsonPreview').value = '';
            }
        }

        // Inventory Management Functions
        function addToInventory() {
            const name = document.getElementById('inventoryName').value.trim();
            const amount = parseFloat(document.getElementById('inventoryAmount').value);
            const unit = document.getElementById('inventoryUnit').value;

            if (!name || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid ingredient name and amount');
                return;
            }

            // Check if ingredient already exists
            const existing = inventory.find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existing) {
                existing.amount += amount;
                existing.unit = unit; // Update unit if different
            } else {
                inventory.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    unit: unit,
                    dilution: 1.0 // Default to neat
                });
            }

            // Clear form
            document.getElementById('inventoryName').value = '';
            document.getElementById('inventoryAmount').value = '';
            
            renderInventory();
            updateRecipeCoverage();
        }

        function importInventoryFromReceipts() {
            // Merge PA receipts data with existing inventory
            paReceiptsData.forEach(receipt => {
                const existing = inventory.find(item => 
                    item.name.toLowerCase() === receipt.name.toLowerCase()
                );
                
                if (existing) {
                    // Add to existing amount (convert units if needed)
                    existing.amount += receipt.amount;
                    existing.dilution = receipt.dilution; // Update dilution
                } else {
                    inventory.push({
                        id: Date.now() + Math.random(),
                        name: receipt.name,
                        amount: receipt.amount,
                        unit: receipt.unit,
                        dilution: receipt.dilution
                    });
                }
            });

            renderInventory();
            updateRecipeCoverage();
            alert('Perfumer\'s Apprentice receipts loaded successfully!');
        }

        function exportInventory() {
            const inventoryData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalItems: inventory.length,
                inventory: inventory
            };

            const jsonString = JSON.stringify(inventoryData, null, 2);
            
            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-inventory-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importInventory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const inventoryData = JSON.parse(e.target.result);
                    
                    if (!inventoryData.inventory || !Array.isArray(inventoryData.inventory)) {
                        throw new Error('Invalid inventory format');
                    }

                    inventory = inventoryData.inventory.map(item => ({
                        id: item.id || Date.now() + Math.random(),
                        name: item.name || 'Unknown',
                        amount: parseFloat(item.amount) || 0,
                        unit: item.unit || 'ml',
                        dilution: parseFloat(item.dilution) || 1.0
                    }));

                    renderInventory();
                    updateRecipeCoverage();
                    alert('Inventory imported successfully!');
                } catch (error) {
                    alert('Error importing inventory: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function removeFromInventory(id) {
            inventory = inventory.filter(item => item.id !== id);
            renderInventory();
            updateRecipeCoverage();
        }

        function renderInventory() {
            const container = document.getElementById('inventoryGrid');
            
            if (inventory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No ingredients in inventory</div>';
                return;
            }

            container.innerHTML = '';
            
            inventory.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const itemDiv = document.createElement('div');
                
                // Determine stock level
                let stockClass = '';
                if (item.amount <= 0) stockClass = 'out-of-stock';
                else if (item.amount <= 1) stockClass = 'low-stock';
                
                itemDiv.className = `inventory-item ${stockClass}`;
                itemDiv.innerHTML = `
                    <div class="inventory-name">${item.name}</div>
                    <div class="inventory-amount">${item.amount}${item.unit}</div>
                    <button onclick="removeFromInventory(${item.id})" class="btn-red" style="padding: 2px;">
                        <i data-lucide="x" class="icon-sm"></i>
                    </button>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        function updateRecipeCoverage() {
            if (ingredients.length === 0) {
                document.getElementById('recipeCoverage').style.display = 'none';
                return;
            }

            document.getElementById('recipeCoverage').style.display = 'block';
            
            let availableCount = 0;
            let partialCount = 0;
            const missingIngredients = [];
            const partialIngredients = [];

            ingredients.forEach(ingredient => {
                const inventoryItem = findInventoryMatch(ingredient.name);
                
                if (inventoryItem) {
                    const requiredAmount = ingredient.volume; // μL
                    const availableAmount = convertToMicroliters(inventoryItem.amount, inventoryItem.unit);
                    
                    if (availableAmount >= requiredAmount) {
                        availableCount++;
                    } else if (availableAmount > 0) {
                        partialCount++;
                        partialIngredients.push({
                            name: ingredient.name,
                            required: requiredAmount,
                            available: availableAmount
                        });
                    } else {
                        missingIngredients.push(ingredient.name);
                    }
                } else {
                    missingIngredients.push(ingredient.name);
                }
            });

            // Update stats
            document.getElementById('coverageStats').textContent = 
                `${availableCount}/${ingredients.length} ingredients available (${partialCount} partial)`;

            // Update details
            const percentage = ((availableCount + partialCount * 0.5) / ingredients.length * 100).toFixed(1);
            document.getElementById('coverageDetails').innerHTML = `
                <div style="margin-bottom: 4px;">
                    <span class="coverage-indicator coverage-full">${availableCount} Full</span>
                    <span class="coverage-indicator coverage-partial">${partialCount} Partial</span>
                    <span class="coverage-indicator coverage-none">${missingIngredients.length} Missing</span>
                    <span style="margin-left: 8px; font-weight: 600;">${percentage}% Coverage</span>
                </div>
            `;

            // Update missing ingredients
            if (missingIngredients.length > 0) {
                document.getElementById('missingIngredients').innerHTML = 
                    `<strong>Missing:</strong> ${missingIngredients.join(', ')}`;
            } else {
                document.getElementById('missingIngredients').innerHTML = '';
            }
        }

        function findInventoryMatch(ingredientName) {
            return inventory.find(item => {
                const itemName = item.name.toLowerCase().replace(/[®™]/g, '').trim();
                const searchName = ingredientName.toLowerCase().replace(/[®™]/g, '').trim();
                
                // Exact match
                if (itemName === searchName) return true;
                
                // Normalize common variations (remove/standardize suffixes)
                const normalizeIngredientName = (name) => {
                    return name
                        .replace(/\s+(essential\s+)?oil$/i, '')
                        .replace(/\s+co2$/i, '')
                        .replace(/\s+absolute$/i, '')
                        .replace(/\s+eo$/i, '') // Remove EO suffix
                        .replace(/\s+by-absolute$/i, ' absolute')
                        .trim();
                };
                
                const normalizedItem = normalizeIngredientName(itemName);
                const normalizedSearch = normalizeIngredientName(searchName);
                
                // Check normalized names
                if (normalizedItem === normalizedSearch) return true;
                
                // Handle specific common variations
                const variations = {
                    // Citrus oils
                    'bergamot': ['bergamot oil', 'bergamot eo', 'bergamot essential oil'],
                    'bergamot oil': ['bergamot', 'bergamot eo', 'bergamot essential oil'],
                    'sweet orange': ['sweet orange oil', 'orange oil', 'orange'],
                    'sweet orange oil': ['sweet orange', 'orange oil', 'orange'],
                    'lemon': ['lemon oil', 'lemon eo', 'lemon essential oil'],
                    'lemon oil': ['lemon', 'lemon eo', 'lemon essential oil'],
                    'lime': ['lime oil', 'lime eo', 'lime essential oil'],
                    'lime oil': ['lime', 'lime eo', 'lime essential oil'],
                    
                    // CO2 vs Oil variations
                    'juniper berry oil': ['juniper berry co2', 'juniper berry'],
                    'juniper berry co2': ['juniper berry oil', 'juniper berry'],
                    'galbanum oil': ['galbanum co2', 'galbanum'],
                    'galbanum co2': ['galbanum oil', 'galbanum'],
                    'angelica root oil': ['angelica root co2', 'angelica root'],
                    'angelica root co2': ['angelica root oil', 'angelica root'],
                    'myrrh oil': ['myrrh co2', 'myrrh'],
                    'myrrh co2': ['myrrh oil', 'myrrh'],
                    'cassia oil': ['cassia co2', 'cassia'],
                    'cassia co2': ['cassia oil', 'cassia'],
                    
                    // Essential oils vs absolutes
                    'clary sage oil': ['clary sage absolute', 'clary sage'],
                    'clary sage absolute': ['clary sage oil', 'clary sage'],
                    'lavender oil': ['lavender absolute', 'lavender'],
                    'lavender absolute': ['lavender oil', 'lavender'],
                    'geranium oil': ['geranium absolute', 'geranium'],
                    'geranium absolute': ['geranium oil', 'geranium'],
                    
                    // Wood oils
                    'patchouli': ['patchouli oil', 'patchouli eo'],
                    'patchouli oil': ['patchouli', 'patchouli eo'],
                    'sandalwood': ['sandalwood oil', 'sandalwood eo'],
                    'sandalwood oil': ['sandalwood', 'sandalwood eo'],
                    'cedarwood': ['cedarwood oil', 'cedarwood absolute', 'cedarwood eo'],
                    'cedarwood oil': ['cedarwood', 'cedarwood absolute', 'cedarwood eo'],
                    'cedarwood absolute': ['cedarwood', 'cedarwood oil', 'cedarwood eo'],
                    'vetiver': ['vetiver oil', 'vetiver eo'],
                    'vetiver oil': ['vetiver', 'vetiver eo'],
                    
                    // Spice oils
                    'pink pepper': ['pink pepper oil', 'pink peppercorn oil'],
                    'pink pepper oil': ['pink pepper', 'pink peppercorn oil'],
                    'star anise': ['star anise oil', 'star anise eo'],
                    'star anise oil': ['star anise', 'star anise eo'],
                    'thyme': ['thyme oil', 'thyme eo'],
                    'thyme oil': ['thyme', 'thyme eo'],
                    
                    // Herb oils
                    'basil': ['basil oil', 'basil eo'],
                    'basil oil': ['basil', 'basil eo'],
                    'fennel': ['fennel oil', 'fennel eo'],
                    'fennel oil': ['fennel', 'fennel eo'],
                    'marjoram': ['marjoram oil', 'marjoram eo'],
                    'marjoram oil': ['marjoram', 'marjoram eo'],
                    'sage': ['sage oil', 'sage eo'],
                    'sage oil': ['sage', 'sage eo'],
                    
                    // Special cases
                    'cypress by-absolute': ['cypress absolute', 'cypress'],
                    'cypress absolute': ['cypress by-absolute', 'cypress'],
                    'birch tar oil': ['birch tar', 'birch tar rectified'],
                    'birch tar': ['birch tar oil', 'birch tar rectified'],
                    
                    // Synthetics
                    'iso e super': ['isoesuper', 'iso-e-super'],
                    'hedione': ['hedione hc'],
                    'lyral': ['leerall'],
                    'evernyl': ['veramoss']
                };
                
                // Check bidirectional variations
                const checkVariations = (name1, name2) => {
                    if (variations[name1] && variations[name1].includes(name2)) return true;
                    if (variations[name2] && variations[name2].includes(name1)) return true;
                    return false;
                };
                
                if (checkVariations(normalizedSearch, normalizedItem)) return true;
                if (checkVariations(searchName, itemName)) return true;
                
                // Final fallback: check if core ingredient name matches
                // Remove common suffixes and check again
                const getCoreIngredientName = (name) => {
                    return name
                        .replace(/\s+(oil|absolute|co2|eo|essential oil|by-absolute)$/i, '')
                        .replace(/\s+decumbens$/i, '') // For hyssop decumbens
                        .replace(/\s+verbenone$/i, '') // For rosemary verbenone
                        .replace(/\s+antioxidant$/i, '') // For rosemary antioxidant
                        .replace(/\s+leaf$/i, '') // For rosewood leaf
                        .replace(/\s+frereana$/i, '') // For frankincense frereana
                        .replace(/\s+bud$/i, '') // For black currant bud
                        .replace(/\s+berry$/i, '') // For juniper berry
                        .replace(/\s+root$/i, '') // For angelica root
                        .trim();
                };
                
                const coreItem = getCoreIngredientName(normalizedItem);
                const coreSearch = getCoreIngredientName(normalizedSearch);
                
                if (coreItem === coreSearch && coreItem.length > 3) return true;
                
                return false;
            });
        }

        function convertToMicroliters(amount, unit) {
            switch (unit.toLowerCase()) {
                case 'ml': return amount * 1000;
                case 'g': return amount * 1000; // Approximate for most aromachemicals
                case 'μl': return amount;
                default: return amount * 1000; // Default to ml conversion
            }
        }

        // Notes and Substitution Functions
        function toggleIngredientExpansion(ingredientId) {
            if (expandedIngredients.has(ingredientId)) {
                expandedIngredients.delete(ingredientId);
            } else {
                expandedIngredients.add(ingredientId);
            }
            render();
        }

        function updateIngredientNotes(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            const notesTextarea = document.querySelector(`#notes-${ingredientId}`);
            
            if (ingredient && notesTextarea) {
                ingredient.notes = notesTextarea.value;
                // Don't re-render to avoid losing focus
            }
        }
        
        function updateDatabaseNotes(ingredientName, notes) {
            const dbEntry = getOrCreateDatabaseEntry(ingredientName);
            dbEntry.notes = notes.trim();
        }

        function substituteIngredient(ingredientId, substituteName = null) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            if (substituteName) {
                // Apply substitution
                ingredient.originalName = ingredient.originalName || ingredient.name;
                ingredient.name = substituteName;
                ingredient.substituted = true;
                ingredient.notes = (ingredient.notes || '') + 
                    `\n[Substituted: ${ingredient.originalName} → ${substituteName}]`;
            } else {
                // Get substitution name from input
                const substitutionInput = document.querySelector(`#substitution-${ingredientId}`);
                if (substitutionInput && substitutionInput.value.trim()) {
                    substituteIngredient(ingredientId, substitutionInput.value.trim());
                    return;
                }
            }
            
            render();
            updateRecipeCoverage();
        }

        function clearSubstitution(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient || !ingredient.substituted) return;

            ingredient.name = ingredient.originalName || ingredient.name;
            ingredient.substituted = false;
            delete ingredient.originalName;
            
            // Remove substitution note
            if (ingredient.notes) {
                ingredient.notes = ingredient.notes.replace(/\n\[Substituted:.*?\]/g, '');
            }
            
            render();
            updateRecipeCoverage();
        }

        function getSubstitutionSuggestions(ingredientName) {
            const normalizedName = ingredientName.toLowerCase().replace(/[®™]/g, '').trim();
            const suggestions = [];
            
            // Check substitution database
            for (const [key, subs] of Object.entries(substitutionDatabase)) {
                if (normalizedName.includes(key) || key.includes(normalizedName)) {
                    subs.forEach(sub => {
                        if (!suggestions.some(s => s.name.toLowerCase() === sub.toLowerCase())) {
                            suggestions.push({
                                name: sub,
                                source: 'database',
                                reason: 'Similar function'
                            });
                        }
                    });
                    break;
                }
            }
            
            // Check inventory for available alternatives
            inventory.forEach(item => {
                const itemName = item.name.toLowerCase().replace(/[®™]/g, '');
                
                // Skip if it's the same ingredient
                if (itemName === normalizedName) return;
                
                // Look for similar ingredients in inventory
                if (itemName.includes(normalizedName.split(' ')[0]) || 
                    normalizedName.includes(itemName.split(' ')[0])) {
                    if (!suggestions.some(s => s.name.toLowerCase() === item.name.toLowerCase())) {
                        suggestions.push({
                            name: item.name,
                            source: 'inventory',
                            reason: `${item.amount}${item.unit} available`
                        });
                    }
                }
            });
            
            return suggestions.slice(0, 5); // Limit to 5 suggestions
        }

        function showSubstitutionSuggestions(ingredientId, inputElement) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            const suggestions = getSubstitutionSuggestions(ingredient.name);
            if (suggestions.length === 0) return;

            // Remove existing dropdown
            const existing = document.querySelector('.suggestions-dropdown');
            if (existing) existing.remove();

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'suggestions-dropdown';
            
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.onclick = () => {
                    substituteIngredient(ingredientId, suggestion.name);
                    dropdown.remove();
                };
                
                item.innerHTML = `
                    <span>${suggestion.name}</span>
                    <span class="suggestion-source">${suggestion.reason}</span>
                `;
                
                dropdown.appendChild(item);
            });

            // Position and show dropdown
            const container = inputElement.parentElement;
            container.style.position = 'relative';
            container.appendChild(dropdown);

            // Remove dropdown when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== inputElement) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        // Main functions
        function addIngredient() {
            const name = document.getElementById('ingredientName').value.trim();
            const dilution = parseFloat(document.getElementById('ingredientDilution').value);
            const volume = parseFloat(document.getElementById('ingredientVolume').value);

            if (!name) return;
            
            // Create or get database entry for this ingredient
            const dbEntry = getOrCreateDatabaseEntry(name);

            const ingredient = {
                id: Date.now(),
                name: name,
                dilution: dilution,
                volume: volume,
                group: 'Unassigned',
                notes: '',
                substituted: false
            };

            ingredients.push(ingredient);
            groups['Unassigned'].ingredients.push(ingredient.id);

            // Clear form
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientDilution').value = '1.0';
            document.getElementById('ingredientVolume').value = '0';

            render();
        }
        
        // Auto-populate form when ingredient name changes
        function onIngredientNameChange() {
            const name = document.getElementById('ingredientName').value.trim();
            if (!name) return;
            
            const dbEntry = ingredientDatabase.find(entry => 
                entry.name.toLowerCase() === name.toLowerCase()
            );
            
            if (dbEntry) {
                // Auto-populate dilution and volume from database
                if (dbEntry.dilution && dbEntry.dilution !== 1.0) {
                    document.getElementById('ingredientDilution').value = dbEntry.dilution;
                }
                if (dbEntry.typicalUsage && dbEntry.typicalUsage > 0) {
                    document.getElementById('ingredientVolume').value = dbEntry.typicalUsage;
                }
            }
        }

        function addGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name || groups[name]) return;

            const colorIndex = Object.keys(groups).length % groupColors.length;
            groups[name] = {
                ingredients: [],
                expanded: true,
                color: groupColors[colorIndex]
            };

            document.getElementById('groupName').value = '';
            render();
        }

        function deleteIngredient(id) {
            const ingredient = ingredients.find(i => i.id === id);
            if (ingredient) {
                groups[ingredient.group].ingredients = groups[ingredient.group].ingredients.filter(i => i !== id);
            }
            ingredients = ingredients.filter(i => i.id !== id);
            render();
        }

        function moveIngredient(ingredientId, targetGroup) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient || ingredient.group === targetGroup) return;

            // Remove from old group
            groups[ingredient.group].ingredients = groups[ingredient.group].ingredients.filter(i => i !== ingredientId);
            
            // Add to new group
            groups[targetGroup].ingredients.push(ingredientId);
            
            // Update ingredient group
            ingredient.group = targetGroup;
            
            render();
        }

        function toggleGroup(groupName) {
            groups[groupName].expanded = !groups[groupName].expanded;
            render();
        }

        // Edit functionality
        let editingIngredient = null;
        let originalIngredientData = null;

        function startEditIngredient(ingredientId) {
            // If already editing another ingredient, cancel that first
            if (editingIngredient && editingIngredient !== ingredientId) {
                cancelEditIngredient();
            }

            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            editingIngredient = ingredientId;
            originalIngredientData = { ...ingredient }; // Store original data for cancel
            render();
        }

        function saveEditIngredient(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            // Get values from edit inputs
            const nameInput = document.querySelector(`#edit-name-${ingredientId}`);
            const dilutionInput = document.querySelector(`#edit-dilution-${ingredientId}`);
            const volumeInput = document.querySelector(`#edit-volume-${ingredientId}`);

            if (!nameInput || !dilutionInput || !volumeInput) return;

            const newName = nameInput.value.trim();
            const newDilution = parseFloat(dilutionInput.value);
            const newVolume = parseFloat(volumeInput.value);

            // Validate inputs
            if (!newName) {
                alert('Ingredient name cannot be empty');
                return;
            }
            if (isNaN(newDilution) || newDilution <= 0 || newDilution > 1) {
                alert('Dilution must be between 0 and 1 (e.g., 0.1 for 10%)');
                return;
            }
            if (isNaN(newVolume) || newVolume < 0) {
                alert('Volume must be a positive number');
                return;
            }

            // Update ingredient
            ingredient.name = newName;
            ingredient.dilution = newDilution;
            ingredient.volume = newVolume;

            // Clear edit state
            editingIngredient = null;
            originalIngredientData = null;

            render();
        }

        function cancelEditIngredient() {
            if (editingIngredient && originalIngredientData) {
                // Restore original data
                const ingredient = ingredients.find(i => i.id === editingIngredient);
                if (ingredient) {
                    ingredient.name = originalIngredientData.name;
                    ingredient.dilution = originalIngredientData.dilution;
                    ingredient.volume = originalIngredientData.volume;
                }
            }

            editingIngredient = null;
            originalIngredientData = null;
            render();
        }

        function render() {
            // Update stats
            document.getElementById('totalActives').textContent = getTotalActives().toFixed(2);
            document.getElementById('totalIngredients').textContent = ingredients.length;
            document.getElementById('totalGroups').textContent = Object.keys(groups).length;

            // Render groups
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';

            Object.entries(groups).forEach(([groupName, groupData]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = `group ${groupData.color}`;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'group-header';
                headerDiv.onclick = () => toggleGroup(groupName);

                headerDiv.innerHTML = `
                    <div class="group-header-left">
                        <i data-lucide="${groupData.expanded ? 'chevron-down' : 'chevron-right'}" class="icon"></i>
                        <h3 class="group-title">${groupName}</h3>
                        <span class="group-count">(${groupData.ingredients.length} ingredients)</span>
                    </div>
                    <div class="group-stats">
                        <div class="group-actives">${getGroupActives(groupName).toFixed(2)} μL actives</div>
                        <div class="group-percentage">${getGroupPercentage(groupName)}% of total</div>
                    </div>
                `;

                groupDiv.appendChild(headerDiv);

                if (groupData.expanded) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'group-content';
                    
                    // Add drag and drop handlers
                    contentDiv.ondragover = (e) => e.preventDefault();
                    contentDiv.ondrop = (e) => {
                        e.preventDefault();
                        if (draggedItem) {
                            moveIngredient(draggedItem, groupName);
                            draggedItem = null;
                        }
                    };

                    if (groupData.ingredients.length === 0) {
                        contentDiv.innerHTML = '<div class="drop-zone">Drop ingredients here or drag from other groups</div>';
                    } else {
                        const gridDiv = document.createElement('div');
                        gridDiv.className = 'ingredients-grid';

                        groupData.ingredients.forEach(ingredientId => {
                            const ingredient = ingredients.find(i => i.id === ingredientId);
                            if (!ingredient) return;

                            const cardDiv = document.createElement('div');
                            const isEditing = editingIngredient === ingredient.id;
                            const isSubstituted = ingredient.substituted;
                            cardDiv.className = `ingredient-card ${isEditing ? 'ingredient-edit' : ''} ${isSubstituted ? 'ingredient-substituted' : ''}`;
                            cardDiv.draggable = !isEditing;
                            if (!isEditing) {
                                cardDiv.ondragstart = () => draggedItem = ingredient.id;
                            }

                            if (isEditing) {
                                cardDiv.innerHTML = `
                                    <div class="ingredient-header">
                                        <div class="ingredient-info">
                                            <input type="text" id="edit-name-${ingredient.id}" class="edit-input" value="${ingredient.name}" placeholder="Ingredient name">
                                            <div style="display: flex; gap: 4px;">
                                                <input type="number" id="edit-volume-${ingredient.id}" class="edit-input" value="${ingredient.volume}" step="0.1" placeholder="Volume (μL)" style="flex: 1;">
                                                <input type="number" id="edit-dilution-${ingredient.id}" class="edit-input" value="${ingredient.dilution}" step="0.001" min="0" max="1" placeholder="Dilution" style="flex: 1;">
                                            </div>
                                            <p class="ingredient-actives" style="margin-top: 4px;">Preview: ${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                        </div>
                                    </div>
                                    <div class="edit-actions">
                                        <button onclick="saveEditIngredient(${ingredient.id})" class="btn btn-save">
                                            <i data-lucide="check" class="icon-sm"></i> Save
                                        </button>
                                        <button onclick="cancelEditIngredient()" class="btn btn-cancel">
                                            <i data-lucide="x" class="icon-sm"></i> Cancel
                                        </button>
                                    </div>
                                `;
                            } else {
                                const isExpanded = expandedIngredients.has(ingredient.id);
                                const isSubstituted = ingredient.substituted;
                                
                                // Get notes from database
                                const dbEntry = ingredientDatabase.find(entry => 
                                    entry.name.toLowerCase() === ingredient.name.toLowerCase()
                                );
                                const dbNotes = dbEntry ? dbEntry.notes : '';
                                const dbSubstitutions = dbEntry ? dbEntry.substitutions : [];
                                
                                cardDiv.innerHTML = `
                                    <div class="ingredient-header">
                                        <div class="ingredient-info">
                                            ${isSubstituted ? `<div class="substitution-info">
                                                <i data-lucide="arrow-right" class="icon-sm"></i>
                                                Substituted: ${ingredient.originalName}
                                                <button onclick="clearSubstitution(${ingredient.id})" class="btn-clear-sub">
                                                    <i data-lucide="x" class="icon-sm"></i>
                                                </button>
                                            </div>` : ''}
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <h4 class="ingredient-name">${ingredient.name}</h4>
                                                <button onclick="toggleIngredientExpansion(${ingredient.id})" class="expand-toggle">
                                                    ${isExpanded ? '▼' : '▶'} ${isExpanded ? 'Less' : 'More'}
                                                </button>
                                            </div>
                                            <p class="ingredient-details">${ingredient.volume}μL @ ${(ingredient.dilution * 100).toFixed(1)}%</p>
                                            <p class="ingredient-actives">${getActives(ingredient).toFixed(2)}μL actives (${getIngredientPercentage(ingredient)}%)</p>
                                            
                                            ${dbNotes ? `<div class="ingredient-notes">${dbNotes}</div>` : ''}
                                            
                                            ${isExpanded ? `
                                                <div class="substitution-controls">
                                                    <div style="font-size: 11px; font-weight: 500; margin-bottom: 4px;">Database Notes:</div>
                                                    <textarea id="notes-${ingredient.id}" 
                                                             class="notes-textarea" 
                                                             placeholder="Add notes about this ingredient..."
                                                             onblur="updateDatabaseNotes('${ingredient.name}', this.value)">${dbNotes}</textarea>
                                                    
                                                    <div style="font-size: 11px; font-weight: 500; margin: 8px 0 4px 0;">Known Substitutions:</div>
                                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">
                                                        ${dbSubstitutions.length > 0 ? dbSubstitutions.join(', ') : 'None recorded'}
                                                    </div>
                                                    
                                                    <div style="font-size: 11px; font-weight: 500; margin: 8px 0 4px 0;">Add Substitution:</div>
                                                    <div class="substitution-form">
                                                        <input type="text" 
                                                               id="substitution-${ingredient.id}" 
                                                               class="input" 
                                                               placeholder="Enter substitute ingredient"
                                                               onfocus="showSubstitutionSuggestions(${ingredient.id}, this)"
                                                               style="font-size: 11px;">
                                                        <button onclick="substituteIngredient(${ingredient.id})" class="btn btn-substitute">
                                                            <i data-lucide="arrow-right" class="icon-sm"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="ingredient-actions">
                                            <i data-lucide="move" class="icon-sm text-gray"></i>
                                            <button onclick="startEditIngredient(${ingredient.id})" class="btn-edit">
                                                <i data-lucide="edit" class="icon-sm"></i>
                                            </button>
                                            <button onclick="deleteIngredient(${ingredient.id})" class="btn-red">
                                                <i data-lucide="trash-2" class="icon-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }

                            gridDiv.appendChild(cardDiv);
                        });

                        contentDiv.appendChild(gridDiv);
                    }

                    groupDiv.appendChild(contentDiv);
                }

                container.appendChild(groupDiv);
            });

            // Initialize Lucide icons with error handling
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Lucide icons failed to load:', error);
                // Fallback: replace icons with text
                document.querySelectorAll('[data-lucide]').forEach(el => {
                    const iconName = el.getAttribute('data-lucide');
                    if (iconName === 'chevron-down') el.innerHTML = '▼';
                    else if (iconName === 'chevron-right') el.innerHTML = '▶';
                    else if (iconName === 'plus') el.innerHTML = '+';
                    else if (iconName === 'download') el.innerHTML = '↓';
                    else if (iconName === 'upload') el.innerHTML = '↑';
                    else if (iconName === 'trash-2') el.innerHTML = '×';
                    else if (iconName === 'move') el.innerHTML = '⌖';
                    else if (iconName === 'edit') el.innerHTML = '✎';
                    else if (iconName === 'check') el.innerHTML = '✓';
                    else if (iconName === 'x') el.innerHTML = '×';
                    else if (iconName === 'plus-circle') el.innerHTML = '⊕';
                    else if (iconName === 'folder-plus') el.innerHTML = '📁+';
                    else if (iconName === 'save') el.innerHTML = '💾';
                    else if (iconName === 'package') el.innerHTML = '📦';
                    else if (iconName === 'file-text') el.innerHTML = '📄';
                    else if (iconName === 'database') el.innerHTML = '🗄️';
                    else if (iconName === 'arrow-right') el.innerHTML = '→';
                    else el.innerHTML = iconName;
                });
            }
            
            // Update JSON preview and inventory coverage
            updateJsonPreview();
            updateRecipeCoverage();
        }

        // Handle Enter key in form inputs
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize tab state
            switchTab('composer');
            
            document.getElementById('ingredientName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addIngredient();
            });
            
            document.getElementById('groupName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addGroup();
            });

            // Global keyboard shortcuts for edit mode
            document.addEventListener('keydown', (e) => {
                if (editingIngredient) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveEditIngredient(editingIngredient);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEditIngredient();
                    }
                }
            });

            // Initial render
            render();
            renderInventory();
        });

        // Database Management Functions
        function getOrCreateDatabaseEntry(ingredientName) {
            let dbEntry = ingredientDatabase.find(entry => 
                entry.name.toLowerCase() === ingredientName.toLowerCase()
            );
            
            if (!dbEntry) {
                dbEntry = {
                    id: Date.now() + Math.random(),
                    name: ingredientName,
                    notes: '',
                    substitutions: [],
                    dilution: 1.0,
                    typicalUsage: 0,
                    olfactoryFamily: ''
                };
                ingredientDatabase.push(dbEntry);
            }
            
            return dbEntry;
        }
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.getElementById('composerTab').className = tabName === 'composer' ? 'btn tab-active' : 'btn tab-inactive';
            document.getElementById('databaseTab').className = tabName === 'database' ? 'btn tab-active' : 'btn tab-inactive';
            
            // Show/hide content
            document.getElementById('composerContent').style.display = tabName === 'composer' ? 'block' : 'none';
            document.getElementById('databaseContent').style.display = tabName === 'database' ? 'block' : 'none';
            
            if (tabName === 'database') {
                renderDatabase();
            }
        }
        
        function exportDatabase() {
            const databaseData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                totalEntries: ingredientDatabase.length,
                database: ingredientDatabase
            };

            const jsonString = JSON.stringify(databaseData, null, 2);
            
            // Download file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fragrance-ingredient-database-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const databaseData = JSON.parse(e.target.result);
                    
                    if (!databaseData.database || !Array.isArray(databaseData.database)) {
                        throw new Error('Invalid database format');
                    }

                    // Merge with existing database
                    databaseData.database.forEach(importedEntry => {
                        const existing = ingredientDatabase.find(entry => 
                            entry.name.toLowerCase() === importedEntry.name.toLowerCase()
                        );
                        
                        if (existing) {
                            // Merge notes with separator
                            if (importedEntry.notes && importedEntry.notes.trim()) {
                                if (existing.notes && existing.notes.trim()) {
                                    existing.notes += '\n---\n' + importedEntry.notes;
                                } else {
                                    existing.notes = importedEntry.notes;
                                }
                            }
                            
                            // Merge substitutions
                            if (importedEntry.substitutions && Array.isArray(importedEntry.substitutions)) {
                                importedEntry.substitutions.forEach(sub => {
                                    if (!existing.substitutions.includes(sub)) {
                                        existing.substitutions.push(sub);
                                    }
                                });
                            }
                            
                            // Update other fields if they're better/newer
                            if (importedEntry.dilution && !existing.dilution) existing.dilution = importedEntry.dilution;
                            if (importedEntry.typicalUsage && !existing.typicalUsage) existing.typicalUsage = importedEntry.typicalUsage;
                            if (importedEntry.olfactoryFamily && !existing.olfactoryFamily) existing.olfactoryFamily = importedEntry.olfactoryFamily;
                        } else {
                            // Add new entry
                            ingredientDatabase.push({
                                id: Date.now() + Math.random(),
                                name: importedEntry.name || 'Unknown',
                                notes: importedEntry.notes || '',
                                substitutions: Array.isArray(importedEntry.substitutions) ? importedEntry.substitutions : [],
                                dilution: parseFloat(importedEntry.dilution) || 1.0,
                                typicalUsage: parseFloat(importedEntry.typicalUsage) || 0,
                                olfactoryFamily: importedEntry.olfactoryFamily || ''
                            });
                        }
                    });

                    if (currentTab === 'database') {
                        renderDatabase();
                    }
                    alert('Database imported and merged successfully!');
                } catch (error) {
                    alert('Error importing database: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        let currentSort = { field: 'name', direction: 'asc' };
        let filteredDatabase = [];
        
        function renderDatabase() {
            const searchTerm = document.getElementById('databaseSearch').value.toLowerCase();
            
            // Filter database
            filteredDatabase = ingredientDatabase.filter(entry =>
                entry.name.toLowerCase().includes(searchTerm) ||
                entry.notes.toLowerCase().includes(searchTerm) ||
                entry.olfactoryFamily.toLowerCase().includes(searchTerm) ||
                entry.substitutions.some(sub => sub.toLowerCase().includes(searchTerm))
            );
            
            // Sort database
            filteredDatabase.sort((a, b) => {
                let aVal = a[currentSort.field] || '';
                let bVal = b[currentSort.field] || '';
                
                if (currentSort.field === 'substitutions') {
                    aVal = aVal.join(', ');
                    bVal = bVal.join(', ');
                }
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            const container = document.getElementById('databaseTable');
            
            if (filteredDatabase.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No ingredients in database</div>';
                return;
            }
            
            const getSortIndicator = (field) => {
                if (currentSort.field === field) {
                    return `<span class="sort-indicator">${currentSort.direction === 'asc' ? '↑' : '↓'}</span>`;
                }
                return '<span class="sort-indicator">↕</span>';
            };
            
            container.innerHTML = `
                <table class="db-table">
                    <thead>
                        <tr>
                            <th onclick="sortDatabase('name')">Name ${getSortIndicator('name')}</th>
                            <th onclick="sortDatabase('olfactoryFamily')">Family ${getSortIndicator('olfactoryFamily')}</th>
                            <th onclick="sortDatabase('dilution')">Dilution ${getSortIndicator('dilution')}</th>
                            <th onclick="sortDatabase('typicalUsage')">Usage ${getSortIndicator('typicalUsage')}</th>
                            <th onclick="sortDatabase('notes')">Notes ${getSortIndicator('notes')}</th>
                            <th onclick="sortDatabase('substitutions')">Substitutions ${getSortIndicator('substitutions')}</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredDatabase.map(entry => `
                            <tr id="db-row-${entry.id}">
                                <td><strong>${entry.name}</strong></td>
                                <td>${entry.olfactoryFamily}</td>
                                <td>${entry.dilution}</td>
                                <td>${entry.typicalUsage}μL</td>
                                <td class="notes-cell" title="${entry.notes}">${entry.notes}</td>
                                <td class="subs-cell" title="${entry.substitutions.join(', ')}">${entry.substitutions.join(', ')}</td>
                                <td class="db-actions">
                                    <button onclick="editDatabaseEntry(${entry.id})" class="db-btn" title="Edit">
                                        <i data-lucide="edit" style="width: 12px; height: 12px;"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function sortDatabase(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            renderDatabase();
        }
        
        function filterDatabase() {
            renderDatabase();
        }
        
        let editingDatabaseEntry = null;
        
        function editDatabaseEntry(entryId) {
            const entry = ingredientDatabase.find(e => e.id === entryId);
            if (!entry) return;
            
            editingDatabaseEntry = entryId;
            
            const row = document.getElementById(`db-row-${entryId}`);
            if (!row) return;
            
            row.innerHTML = `
                <td><input type="text" class="db-edit-input" value="${entry.name}" id="edit-db-name-${entryId}"></td>
                <td><input type="text" class="db-edit-input" value="${entry.olfactoryFamily}" id="edit-db-family-${entryId}" placeholder="e.g., Citrus, Woody, Floral"></td>
                <td><input type="number" class="db-edit-input" value="${entry.dilution}" id="edit-db-dilution-${entryId}" step="0.001" min="0" max="1"></td>
                <td><input type="number" class="db-edit-input" value="${entry.typicalUsage}" id="edit-db-usage-${entryId}" step="0.1" min="0"></td>
                <td><textarea class="db-edit-textarea" id="edit-db-notes-${entryId}" placeholder="Notes about this ingredient...">${entry.notes}</textarea></td>
                <td><textarea class="db-edit-textarea" id="edit-db-subs-${entryId}" placeholder="Comma-separated substitutions">${entry.substitutions.join(', ')}</textarea></td>
                <td class="db-actions">
                    <button onclick="saveDatabaseEntry(${entryId})" class="db-btn" title="Save" style="color: #10b981;">
                        <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                    </button>
                    <button onclick="cancelEditDatabase()" class="db-btn" title="Cancel" style="color: #ef4444;">
                        <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                    </button>
                </td>
            `;
        }
        
        function saveDatabaseEntry(entryId) {
            const entry = ingredientDatabase.find(e => e.id === entryId);
            if (!entry) return;
            
            const name = document.getElementById(`edit-db-name-${entryId}`).value.trim();
            const family = document.getElementById(`edit-db-family-${entryId}`).value.trim();
            const dilution = parseFloat(document.getElementById(`edit-db-dilution-${entryId}`).value);
            const usage = parseFloat(document.getElementById(`edit-db-usage-${entryId}`).value);
            const notes = document.getElementById(`edit-db-notes-${entryId}`).value.trim();
            const subsText = document.getElementById(`edit-db-subs-${entryId}`).value.trim();
            
            if (!name) {
                alert('Ingredient name cannot be empty');
                return;
            }
            
            // Update entry
            entry.name = name;
            entry.olfactoryFamily = family;
            entry.dilution = isNaN(dilution) ? 1.0 : dilution;
            entry.typicalUsage = isNaN(usage) ? 0 : usage;
            entry.notes = notes;
            entry.substitutions = subsText ? subsText.split(',').map(s => s.trim()).filter(s => s) : [];
            
            editingDatabaseEntry = null;
            renderDatabase();
        }
        
        function cancelEditDatabase() {
            editingDatabaseEntry = null;
            renderDatabase();
        }
    </script>
</body>
</html>